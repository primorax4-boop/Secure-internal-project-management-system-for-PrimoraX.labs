<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>PrimoraX.labs ‚Äî Operations</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&family=Clash+Display:wght@600;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
:root{
  --bg:#080c14;--bg2:#0c1220;--bg3:#101828;--bg4:#151e2e;--bg5:#1a2438;
  --border:#1e2d45;--border2:#243654;--border3:#2d4268;
  --text:#f0f4ff;--text2:#c8d4f0;--text3:#8fa3c8;--text4:#506280;--text5:#2e4060;
  --accent:#3b82f6;--accent2:#60a5fa;--accent3:#1d4ed8;
  --green:#22c55e;--green2:#14532d;--red:#ef4444;--amber:#f59e0b;
  --purple:#a855f7;--cyan:#06b6d4;--teal:#14b8a6;
  --ff:'DM Sans',sans-serif;--fm:'DM Mono',monospace;--fd:'Syne',sans-serif;
  --r6:6px;--r8:8px;--r10:10px;--r12:12px;--r16:16px;--r20:20px;
  --sh:0 4px 24px rgba(0,0,0,.5);--sh2:0 8px 48px rgba(0,0,0,.7);
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--ff);font-size:14px;overflow:hidden;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border3);border-radius:4px;}
button{cursor:pointer;border:none;font-family:var(--ff);background:none;}
input,select,textarea{outline:none;font-family:var(--ff);}
input,select{font-size:16px!important;}

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.screen{display:none;}
.screen.active{display:flex;}

/* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
#s-loading{min-height:100vh;align-items:center;justify-content:center;flex-direction:column;gap:16px;background:var(--bg);}
.loader-ring{width:48px;height:48px;border:3px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
#s-login{min-height:100vh;align-items:center;justify-content:center;padding:20px;background:var(--bg);background-image:radial-gradient(ellipse 100% 80% at 20% 50%,rgba(59,130,246,.12) 0%,transparent 65%),radial-gradient(ellipse 60% 60% at 80% 20%,rgba(168,85,247,.06) 0%,transparent 55%);}
.login-wrap{width:100%;max-width:420px;}
.login-card{background:var(--bg3);border:1px solid var(--border2);border-radius:24px;padding:48px 40px;box-shadow:0 40px 100px rgba(0,0,0,.8),0 0 0 1px rgba(59,130,246,.05);}
.login-logo{text-align:center;margin-bottom:40px;}
.logo-mark{width:56px;height:56px;background:linear-gradient(145deg,#3b82f6,#1d4ed8);border-radius:16px;display:inline-flex;align-items:center;justify-content:center;font-size:28px;margin-bottom:16px;box-shadow:0 8px 32px rgba(59,130,246,.3);}
.brand-name{font-family:var(--fd);font-weight:800;font-size:26px;letter-spacing:-.04em;}
.brand-name span{color:var(--accent2);}
.brand-sub{font-size:11px;color:var(--text5);font-family:var(--fm);letter-spacing:.12em;text-transform:uppercase;margin-top:7px;}
.field-label{display:block;font-size:10px;color:var(--text4);font-family:var(--fm);letter-spacing:.1em;text-transform:uppercase;font-weight:600;margin-bottom:8px;}
.inp{width:100%;background:var(--bg4);border:1.5px solid var(--border2);border-radius:var(--r10);color:var(--text);padding:14px 16px;font-size:16px!important;transition:border-color .2s,box-shadow .2s;}
.inp:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,.12);}
.inp::placeholder{color:var(--text5);}
.pw-wrap{position:relative;}
.pw-wrap .inp{padding-right:52px;}
.pw-eye{position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--text4);font-size:18px;padding:8px;min-height:44px;display:flex;align-items:center;}
.login-err{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.25);color:#fca5a5;border-radius:var(--r8);padding:10px 14px;font-size:12px;margin-bottom:14px;font-family:var(--fm);display:none;}
.btn-login{width:100%;background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:#fff;padding:15px;border-radius:var(--r10);font-size:15px;font-weight:600;letter-spacing:.02em;box-shadow:0 4px 20px rgba(59,130,246,.35);transition:all .2s;min-height:52px;}
.btn-login:hover{transform:translateY(-2px);box-shadow:0 8px 32px rgba(59,130,246,.45);}
.btn-login:active{transform:translateY(0);}
.login-footer{text-align:center;margin-top:24px;font-size:10px;color:var(--text5);font-family:var(--fm);letter-spacing:.06em;}
.inp-group{margin-bottom:18px;}
.lock-msg{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.25);color:#fcd34d;border-radius:var(--r8);padding:10px 14px;font-size:12px;font-family:var(--fm);margin-bottom:14px;display:none;}
.rm-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;}
.rm-toggle{display:flex;align-items:center;gap:10px;cursor:pointer;user-select:none;}
.toggle-track{width:40px;height:22px;background:var(--bg5);border-radius:11px;border:1.5px solid var(--border2);position:relative;transition:all .2s;flex-shrink:0;}
.toggle-thumb{width:16px;height:16px;background:var(--text5);border-radius:50%;position:absolute;top:1px;left:1px;transition:all .2s;}
.rm-label{font-size:12px;color:var(--text4);font-family:var(--fm);}

/* ‚îÄ‚îÄ APP SHELL ‚îÄ‚îÄ */
#s-app{height:100vh;flex-direction:row;overflow:hidden;}
#sidebar{width:240px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;height:100vh;flex-shrink:0;transition:transform .28s cubic-bezier(.4,0,.2,1);z-index:200;}
#main-area{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;}
#sb-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:199;}
#sb-overlay.on{display:block;}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sb-logo{padding:22px 18px 18px;border-bottom:1px solid var(--border);}
.sb-logo-inner{display:flex;align-items:center;gap:12px;}
.sb-mark{width:40px;height:40px;background:linear-gradient(145deg,#3b82f6,#1d4ed8);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;box-shadow:0 4px 16px rgba(59,130,246,.3);}
.sb-brand{font-family:var(--fd);font-weight:800;font-size:17px;letter-spacing:-.03em;}
.sb-brand span{color:var(--accent2);}
.sb-tag{font-size:9px;color:var(--text5);font-family:var(--fm);letter-spacing:.1em;text-transform:uppercase;margin-top:2px;}
.sb-nav{flex:1;padding:12px 10px;overflow-y:auto;}
.sb-sec{font-size:9px;color:var(--text5);font-family:var(--fm);letter-spacing:.12em;text-transform:uppercase;padding:0 8px;margin:12px 0 6px;}
.nav-btn{display:flex;align-items:center;gap:10px;width:100%;padding:10px 12px;border-radius:var(--r8);margin-bottom:2px;color:var(--text4);border:1px solid transparent;text-align:left;font-size:13px;font-weight:500;transition:all .14s;position:relative;min-height:44px;}
.nav-btn:hover{background:var(--bg3);color:var(--text2);}
.nav-btn.active{background:rgba(59,130,246,.1);color:var(--accent2);border-color:rgba(59,130,246,.2);}
.nav-btn.active::before{content:'';position:absolute;left:0;top:25%;bottom:25%;width:3px;background:var(--accent2);border-radius:0 3px 3px 0;}
.nav-icon{font-size:15px;width:20px;text-align:center;flex-shrink:0;}
.nav-label{flex:1;}
.nav-tag{font-size:9px;font-family:var(--fm);color:var(--purple);background:rgba(168,85,247,.1);border:1px solid rgba(168,85,247,.2);padding:2px 6px;border-radius:3px;}
.sb-user{padding:14px 16px 18px;border-top:1px solid var(--border);}
.sb-user-inner{display:flex;align-items:center;gap:10px;margin-bottom:12px;}
.sb-uname{font-size:12px;font-weight:600;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.sb-urole{font-size:10px;color:var(--text4);font-family:var(--fm);margin-top:1px;}
.btn-signout{width:100%;padding:10px;border-radius:var(--r8);font-size:13px;background:var(--bg4);color:var(--text3);border:1px solid var(--border2);transition:all .15s;min-height:44px;}
.btn-signout:hover{background:rgba(239,68,68,.12);color:#fca5a5;border-color:rgba(239,68,68,.3);}

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
#topbar{padding:0 22px;height:58px;border-bottom:1px solid var(--border);background:var(--bg2);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.tb-left{display:flex;align-items:center;gap:10px;}
#menu-btn{display:none;color:var(--text3);font-size:22px;padding:8px;border-radius:var(--r8);min-height:44px;min-width:44px;align-items:center;justify-content:center;}
#menu-btn:hover{background:var(--bg3);}
.tb-title{font-family:var(--fd);font-weight:800;font-size:17px;letter-spacing:-.03em;}
.tb-sub{font-size:10px;color:var(--text5);font-family:var(--fm);margin-top:2px;}
.tb-right{display:flex;align-items:center;gap:10px;}
.live-dot{width:7px;height:7px;border-radius:50%;background:var(--green);box-shadow:0 0 0 2px rgba(34,197,94,.2);animation:pulse 2s ease-in-out infinite;display:inline-block;margin-right:5px;}
@keyframes pulse{0%,100%{opacity:1;box-shadow:0 0 0 2px rgba(34,197,94,.2);}50%{opacity:.7;box-shadow:0 0 0 5px rgba(34,197,94,.05);}}

/* ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ */
#content{flex:1;overflow-y:auto;padding:24px;-webkit-overflow-scrolling:touch;}
.page{animation:pageIn .2s ease both;}
@keyframes pageIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}

/* ‚îÄ‚îÄ REUSABLES ‚îÄ‚îÄ */
.badge{display:inline-flex;align-items:center;border-radius:4px;padding:2px 8px;font-size:10px;font-family:var(--fm);font-weight:600;letter-spacing:.05em;text-transform:uppercase;white-space:nowrap;}
.avatar{border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:var(--fm);font-weight:700;flex-shrink:0;}
.card{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r12);}
.card-hover{transition:all .18s;}
.card-hover:hover{border-color:var(--border3);transform:translateY(-1px);box-shadow:0 6px 20px rgba(0,0,0,.3);}
.stat-card{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r12);padding:18px 20px;}
.stat-icon{font-size:22px;margin-bottom:10px;}
.stat-val{font-family:var(--fd);font-weight:800;font-size:26px;margin-bottom:4px;letter-spacing:-.03em;}
.stat-lbl{font-size:10px;color:var(--text4);font-family:var(--fm);text-transform:uppercase;letter-spacing:.08em;}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.g3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;}
.pbar-wrap{height:4px;background:var(--bg5);border-radius:2px;overflow:hidden;}
.pbar{height:100%;border-radius:2px;transition:width .4s ease;}
.divider{border:none;border-top:1px solid var(--border);margin:12px 0;}
.sec-head{font-family:var(--fd);font-weight:700;font-size:14px;color:var(--text);margin-bottom:14px;}
.irow{display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid var(--border);}
.irow:last-child{border-bottom:none;}
.il{font-size:10px;color:var(--text4);font-family:var(--fm);text-transform:uppercase;letter-spacing:.06em;}
.iv{font-size:13px;color:var(--text2);font-weight:500;}
.filter-bar{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:18px;}
.fbtn{padding:8px 14px;border-radius:var(--r8);font-size:12px;font-family:var(--fm);background:var(--bg3);color:var(--text4);border:1px solid var(--border);transition:all .14s;min-height:38px;}
.fbtn:hover{border-color:var(--border3);color:var(--text2);}
.fbtn.on{background:rgba(59,130,246,.15);color:var(--accent2);border-color:rgba(59,130,246,.3);}
.flex-end{display:flex;justify-content:flex-end;}
.flex-mid{display:flex;align-items:center;}
.flex-between{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;}
.empty{text-align:center;padding:52px 20px;color:var(--text5);background:var(--bg3);border:1px dashed var(--border2);border-radius:var(--r12);}
.empty-icon{font-size:36px;display:block;margin-bottom:12px;}
.back-btn{display:inline-flex;align-items:center;gap:6px;color:var(--text4);font-size:12px;font-family:var(--fm);margin-bottom:16px;padding:8px 0;transition:color .14s;min-height:40px;}
.back-btn:hover{color:var(--accent2);}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn-p{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:#fff;padding:10px 20px;border-radius:var(--r8);font-size:13px;font-weight:600;box-shadow:0 3px 12px rgba(59,130,246,.25);white-space:nowrap;transition:all .2s;min-height:42px;position:relative;overflow:hidden;}
.btn-p:hover{transform:translateY(-1px);box-shadow:0 5px 20px rgba(59,130,246,.4);}
.btn-s{background:var(--bg4);color:var(--text3);padding:10px 16px;border-radius:var(--r8);font-size:13px;border:1px solid var(--border2);white-space:nowrap;transition:all .14s;min-height:42px;}
.btn-s:hover{background:var(--bg5);color:var(--text2);}
.btn-sm{background:var(--bg4);color:var(--text3);padding:7px 13px;border-radius:6px;font-size:12px;font-family:var(--fm);border:1px solid var(--border2);transition:all .14s;min-height:36px;}
.btn-sm:hover{background:var(--bg5);color:var(--text2);}
.btn-icon{background:var(--bg4);border:1px solid var(--border2);border-radius:6px;color:var(--text3);padding:6px 10px;font-size:13px;transition:all .14s;min-height:36px;min-width:36px;display:inline-flex;align-items:center;justify-content:center;}
.btn-icon:hover{border-color:var(--border3);color:var(--text2);}
.btn-danger{background:rgba(239,68,68,.12);color:#fca5a5;border:1px solid rgba(239,68,68,.25);padding:7px 13px;border-radius:6px;font-size:12px;font-family:var(--fm);transition:all .14s;min-height:36px;}
.btn-danger:hover{background:rgba(239,68,68,.2);}

/* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
.field{margin-bottom:14px;}
.field-lbl{display:block;font-size:10px;color:var(--text4);font-family:var(--fm);letter-spacing:.1em;text-transform:uppercase;font-weight:600;margin-bottom:8px;}
.inp-sm{background:var(--bg4);border:1.5px solid var(--border2);border-radius:var(--r8);color:var(--text);padding:11px 13px;font-size:16px!important;width:100%;transition:border-color .2s;min-height:46px;}
.inp-sm:focus{border-color:var(--accent);}
.inp-sm::placeholder{color:var(--text5);}
select.inp-sm option{background:var(--bg3);}
textarea.inp-sm{min-height:unset;resize:vertical;font-size:14px!important;}

/* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
.tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:20px;gap:0;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
.tabs::-webkit-scrollbar{display:none;}
.tab{padding:11px 18px;font-size:13px;font-weight:500;color:var(--text4);border-bottom:2px solid transparent;transition:all .14s;white-space:nowrap;min-height:44px;display:flex;align-items:center;text-transform:capitalize;}
.tab:hover{color:var(--text2);}
.tab.on{color:var(--accent2);border-bottom-color:var(--accent2);}

/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.tbl-wrap{overflow-x:auto;border-radius:var(--r12);border:1px solid var(--border);}
table{width:100%;border-collapse:collapse;min-width:560px;}
th{padding:11px 14px;text-align:left;font-size:10px;color:var(--text4);font-family:var(--fm);text-transform:uppercase;letter-spacing:.08em;font-weight:600;background:var(--bg4);border-bottom:1px solid var(--border);}
td{padding:13px 14px;border-bottom:1px solid var(--border);font-size:12px;color:var(--text2);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:rgba(255,255,255,.012);}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.proj-card{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r12);padding:18px 20px;margin-bottom:10px;cursor:pointer;transition:all .15s;}
.proj-card:hover{border-color:var(--border3);background:var(--bg4);transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,0,0,.3);}
.task-card{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r12);margin-bottom:10px;overflow:hidden;}
.tc-head{padding:14px 16px;cursor:pointer;transition:background .14s;min-height:62px;}
.tc-head:hover{background:rgba(255,255,255,.02);}
.tc-body{border-top:1px solid var(--border);padding:14px 16px;}
.doc-card{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r10);padding:14px 16px;margin-bottom:9px;}
.note-item{padding:10px 13px;background:var(--bg4);border-radius:var(--r8);margin-bottom:7px;border-left:3px solid var(--border2);}
.cmt-item{display:flex;gap:11px;padding:12px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--r10);margin-bottom:8px;}
.pay-row{display:flex;align-items:center;justify-content:space-between;padding:13px 16px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--r10);margin-bottom:8px;}

/* ‚îÄ‚îÄ MEMBER CHIPS ‚îÄ‚îÄ */
.mchip{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;background:var(--bg4);border:1px solid var(--border2);border-radius:20px;font-size:13px;margin:4px;cursor:pointer;transition:all .14s;min-height:40px;}
.mchip:hover{border-color:var(--border3);}
.mchip.sel{background:rgba(59,130,246,.15);border-color:rgba(59,130,246,.4);color:var(--accent2);}
.vis-row{display:flex;gap:8px;margin-top:6px;}
.vbtn{flex:1;padding:10px 8px;border-radius:var(--r8);font-size:12px;font-family:var(--fm);border:1.5px solid var(--border2);background:var(--bg4);color:var(--text4);cursor:pointer;transition:all .15s;min-height:44px;}

/* ‚îÄ‚îÄ UPLOAD ZONE ‚îÄ‚îÄ */
.upload-zone{border:2px dashed var(--border3);border-radius:var(--r12);padding:32px 20px;text-align:center;cursor:pointer;transition:all .2s;background:var(--bg4);}
.upload-zone:hover,.upload-zone.drag{border-color:var(--accent);background:rgba(59,130,246,.05);}
.upload-zone-icon{font-size:40px;margin-bottom:12px;display:block;}
.upload-zone-title{font-size:15px;font-weight:600;color:var(--text2);margin-bottom:6px;}
.upload-zone-sub{font-size:12px;color:var(--text4);font-family:var(--fm);}
.file-input-hidden{display:none;}
.upload-preview{background:var(--bg4);border:1px solid var(--border2);border-radius:var(--r8);padding:12px 14px;margin-top:10px;display:flex;align-items:center;gap:10px;}
.up-icon{font-size:26px;flex-shrink:0;}
.up-name{font-size:13px;color:var(--text2);font-weight:500;word-break:break-all;}
.up-size{font-size:11px;color:var(--text4);font-family:var(--fm);margin-top:2px;}
.up-rm{margin-left:auto;color:var(--red);font-size:20px;padding:4px 6px;flex-shrink:0;}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
#modal-root .overlay{position:fixed;inset:0;background:rgba(2,6,14,.9);z-index:1000;display:flex;align-items:flex-end;justify-content:center;padding:0;animation:ovIn .18s ease;}
@media(min-width:600px){#modal-root .overlay{align-items:center;padding:16px;}}
@keyframes ovIn{from{opacity:0;}to{opacity:1;}}
.mbox{background:var(--bg3);border:1px solid var(--border2);border-radius:20px 20px 0 0;padding:22px 20px 36px;width:100%;max-height:92vh;overflow-y:auto;box-shadow:0 -20px 60px rgba(0,0,0,.8);animation:mUp .25s cubic-bezier(.34,1.1,.64,1);}
@media(min-width:600px){.mbox{border-radius:18px;max-width:520px;padding:28px 30px 30px;animation:mIn .22s cubic-bezier(.34,1.3,.64,1);}}
@keyframes mUp{from{transform:translateY(100%);}to{transform:translateY(0);}}
@keyframes mIn{from{opacity:0;transform:scale(.95) translateY(16px);}to{opacity:1;transform:scale(1) translateY(0);}}
.mbox-wide{max-width:580px;}
.mhead{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px;}
.mtitle{font-family:var(--fd);font-weight:800;font-size:17px;color:var(--text);}
.mclose{color:var(--text4);font-size:28px;padding:4px 8px;border-radius:5px;min-height:44px;min-width:44px;display:flex;align-items:center;justify-content:center;}
.mclose:hover{background:var(--bg5);color:var(--text);}
.drag-handle{width:36px;height:4px;background:var(--border2);border-radius:2px;margin:0 auto 16px;}

/* ‚îÄ‚îÄ GROUP CHAT ‚îÄ‚îÄ */
#chat-wrap{display:flex;flex-direction:column;height:calc(100vh - 58px);overflow:hidden;}
#chat-messages{flex:1;overflow-y:auto;padding:18px;display:flex;flex-direction:column;gap:12px;-webkit-overflow-scrolling:touch;scroll-behavior:smooth;}
#chat-input-bar{padding:12px 16px;border-top:1px solid var(--border);background:var(--bg2);display:flex;gap:10px;align-items:flex-end;flex-shrink:0;}
.chat-msg{display:flex;gap:10px;max-width:82%;animation:msgIn .28s ease-out both;}
.chat-msg.mine{flex-direction:row-reverse;align-self:flex-end;}
.chat-msg.theirs{align-self:flex-start;}
@keyframes msgIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
.chat-msg.mine .chat-bubble{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:#fff;border-radius:18px 18px 4px 18px;box-shadow:0 2px 12px rgba(59,130,246,.2);}
.chat-msg.theirs .chat-bubble{background:var(--bg3);border:1px solid var(--border);border-radius:18px 18px 18px 4px;}
.chat-bubble{padding:11px 15px;font-size:13.5px;line-height:1.6;max-width:100%;word-break:break-word;}
.chat-meta{font-size:10px;margin-top:4px;font-family:var(--fm);opacity:.7;}
.chat-msg.mine .chat-meta{text-align:right;color:rgba(255,255,255,.7);}
.chat-msg.theirs .chat-meta{color:var(--text5);}
.chat-name-badge{font-size:11px;font-weight:600;color:var(--text3);margin-bottom:5px;padding:0 2px;}
.chat-msg.mine .chat-name-badge{display:none;}
.chat-date-div{text-align:center;font-size:10px;color:var(--text5);font-family:var(--fm);padding:8px 0;letter-spacing:.06em;text-transform:uppercase;position:relative;margin:6px 0;}
.chat-date-div::before,.chat-date-div::after{content:'';position:absolute;top:50%;width:28%;height:1px;background:var(--border);}
.chat-date-div::before{left:0;}.chat-date-div::after{right:0;}
.chat-typing-area{flex:1;background:var(--bg4);border:1.5px solid var(--border2);border-radius:14px;color:var(--text);padding:11px 14px;font-size:15px;resize:none;max-height:120px;min-height:44px;line-height:1.5;transition:border-color .2s;}
.chat-typing-area:focus{border-color:var(--accent);}
.chat-send-btn{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:#fff;font-size:18px;display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 3px 12px rgba(59,130,246,.35);transition:all .2s;}
.chat-send-btn:hover{transform:scale(1.08);}
.chat-send-btn:active{transform:scale(.92);}
.chat-typing-indicator{display:flex;gap:4px;padding:9px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:12px;max-width:fit-content;font-size:11px;color:var(--text4);font-family:var(--fm);align-items:center;}
.typing-dots{display:flex;gap:3px;margin-left:5px;}
.typing-dot{width:6px;height:6px;border-radius:50%;background:var(--text5);animation:typDot 1.4s ease-in-out infinite;}
.typing-dot:nth-child(2){animation-delay:.2s;}.typing-dot:nth-child(3){animation-delay:.4s;}
@keyframes typDot{0%,60%,100%{transform:translateY(0);opacity:.4;}30%{transform:translateY(-6px);opacity:1;}}

/* ‚îÄ‚îÄ NOTIF ‚îÄ‚îÄ */
#notif{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);z-index:9999;background:rgba(20,53,28,.97);border:1px solid rgba(34,197,94,.3);color:#86efac;padding:12px 22px;border-radius:12px;font-family:var(--fm);font-size:13px;box-shadow:var(--sh2);display:none;animation:notifIn .22s ease;max-width:90vw;text-align:center;white-space:nowrap;}
#notif.err{background:rgba(60,10,10,.97);border-color:rgba(239,68,68,.3);color:#fca5a5;}
@keyframes notifIn{from{transform:translateX(-50%) translateY(16px);opacity:0;}to{transform:translateX(-50%) translateY(0);opacity:1;}}

/* ‚îÄ‚îÄ BOTTOM NAV (mobile) ‚îÄ‚îÄ */
#bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;z-index:150;background:var(--bg2);border-top:1px solid var(--border);padding:6px 8px env(safe-area-inset-bottom,8px);gap:2px;}
.bnav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:8px 4px;border-radius:var(--r8);color:var(--text5);font-size:9px;font-family:var(--fm);letter-spacing:.04em;text-transform:uppercase;cursor:pointer;transition:all .14s;min-height:54px;justify-content:center;}
.bnav-item:hover,.bnav-item.active{color:var(--accent2);}
.bnav-item.active{background:rgba(59,130,246,.08);}
.bnav-icon{font-size:20px;}

/* ‚îÄ‚îÄ LOADING STATES ‚îÄ‚îÄ */
.skeleton{background:linear-gradient(90deg,var(--bg4) 25%,var(--bg5) 50%,var(--bg4) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:6px;}
@keyframes shimmer{0%{background-position:200% 0;}100%{background-position:-200% 0;}}
.loading-card{height:80px;margin-bottom:10px;}

/* ‚îÄ‚îÄ STATUS INDICATOR ‚îÄ‚îÄ */
.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;flex-shrink:0;}
.online-badge{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.2);border-radius:6px;font-size:10px;font-family:var(--fm);color:var(--green);}

@media(max-width:768px){
  #menu-btn{display:flex;}
  #sidebar{position:fixed;left:0;top:0;bottom:0;transform:translateX(-100%);}
  #sidebar.open{transform:translateX(0);}
  #content{padding:14px 14px 80px;}
  #bottom-nav{display:flex;}
  .g4{grid-template-columns:1fr 1fr;}
  .g2{grid-template-columns:1fr;}
  .g3{grid-template-columns:1fr 1fr;}
  #chat-wrap{height:calc(100vh - 58px - 68px);}
}
@media(max-width:480px){
  .g4{grid-template-columns:1fr 1fr;}
  .g3{grid-template-columns:1fr;}
  .login-card{padding:32px 22px;}
  .filter-bar{gap:5px;}
  .fbtn{padding:7px 11px;font-size:11px;}
}
</style>
</head>
<body>

<!-- LOADING -->
<div id="s-loading" class="screen active">
  <div class="loader-ring"></div>
  <div style="font-size:12px;color:var(--text5);font-family:var(--fm);letter-spacing:.08em;">CONNECTING TO DATABASE...</div>
</div>

<!-- LOGIN -->
<div id="s-login" class="screen">
  <div class="login-wrap">
    <div class="login-card">
      <div class="login-logo">
        <div class="logo-mark">‚¨°</div>
        <div class="brand-name">PrimoraX<span>.labs</span></div>
        <div class="brand-sub">Internal Operations System ¬∑ Live</div>
      </div>
      <div class="inp-group">
        <label class="field-label">Username</label>
        <input class="inp" id="l-user" placeholder="e.g. vishal.elec" autocomplete="username" autocapitalize="none" spellcheck="false"/>
      </div>
      <div class="inp-group">
        <label class="field-label">Password</label>
        <div class="pw-wrap">
          <input class="inp" id="l-pass" type="password" placeholder="Your password" autocomplete="current-password"/>
          <button class="pw-eye" id="l-eye" onclick="togglePW()">üëÅ</button>
        </div>
      </div>
      <div class="login-err" id="l-err"></div>
      <div class="lock-msg" id="l-lock"></div>
      <div class="rm-row">
        <label class="rm-toggle" onclick="toggleRM()">
          <div class="toggle-track" id="rm-track"><div class="toggle-thumb" id="rm-thumb"></div></div>
          <span class="rm-label">Remember me (7 days)</span>
        </label>
      </div>
      <button class="btn-login" onclick="doLogin()">Access System</button>
      <p class="login-footer">üîí RESTRICTED INTERNAL ACCESS</p>
    </div>
  </div>
</div>

<!-- APP -->
<div id="s-app" class="screen">
  <div id="sb-overlay" onclick="closeSB()"></div>
  <div id="sidebar">
    <div class="sb-logo">
      <div class="sb-logo-inner">
        <div class="sb-mark">‚¨°</div>
        <div>
          <div class="sb-brand">PrimoraX<span>.labs</span></div>
          <div class="sb-tag">Live Operations</div>
        </div>
      </div>
    </div>
    <nav class="sb-nav" id="sb-nav"></nav>
    <div class="sb-user" id="sb-user"></div>
  </div>
  <div id="main-area">
    <div id="topbar">
      <div class="tb-left">
        <button id="menu-btn" onclick="toggleSB()">‚ò∞</button>
        <div>
          <div class="tb-title" id="tb-title">Dashboard</div>
          <div class="tb-sub" id="tb-sub"></div>
        </div>
      </div>
      <div class="tb-right" id="tb-right"></div>
    </div>
    <div id="content"></div>
  </div>
  <div id="bottom-nav">
    <div class="bnav-item" id="bn-dashboard" onclick="navigate('dashboard')"><span class="bnav-icon">‚óà</span>Home</div>
    <div class="bnav-item" id="bn-projects" onclick="navigate('projects')"><span class="bnav-icon">‚¨°</span>Projects</div>
    <div class="bnav-item" id="bn-tasks" onclick="navigate('tasks')"><span class="bnav-icon">‚óé</span>Tasks</div>
    <div class="bnav-item" id="bn-groupchat" onclick="navigate('groupchat')"><span class="bnav-icon">üí¨</span>Chat</div>
    <div class="bnav-item" id="bn-more" onclick="toggleSB()"><span class="bnav-icon">‚ò∞</span>More</div>
  </div>
</div>

<div id="notif"></div>
<div id="modal-root"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<script>
'use strict';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE CONFIG ‚Äî ALL data lives here permanently
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FB_CONFIG = {
  apiKey:            'AIzaSyC8SaNwndgJNNcu9IMAzlwZFuP6yMIR7NA',
  authDomain:        'primorax-ops.firebaseapp.com',
  databaseURL:       'https://primorax-ops-default-rtdb.firebaseio.com',
  projectId:         'primorax-ops',
  storageBucket:     'primorax-ops.firebasestorage.app',
  messagingSenderId: '525693856762',
  appId:             '1:525693856762:web:0606cc21534b0a75a69243'
};

let db = null;
let dbReady = false;

function initFirebase() {
  return new Promise((resolve) => {
    try {
      if (!firebase.apps.length) firebase.initializeApp(FB_CONFIG);
      db = firebase.database();
      // Test connectivity
      db.ref('.info/connected').on('value', snap => {
        dbReady = snap.val() === true;
        updateConnectionUI(dbReady);
      });
      resolve(true);
    } catch(e) {
      console.error('Firebase init failed:', e);
      resolve(false);
    }
  });
}

function updateConnectionUI(connected) {
  const dot = document.getElementById('conn-dot');
  const lbl = document.getElementById('conn-lbl');
  if (dot) { dot.style.background = connected ? 'var(--green)' : 'var(--red)'; }
  if (lbl) { lbl.textContent = connected ? 'Live' : 'Offline'; }
}

// ‚îÄ‚îÄ Firebase CRUD Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FB = {
  // Read once
  get: (path) => db.ref(path).once('value').then(s => s.val()),
  // Set (overwrite)
  set: (path, val) => db.ref(path).set(val),
  // Push (auto-id)
  push: (path, val) => db.ref(path).push(val),
  // Update (merge)
  update: (path, val) => db.ref(path).update(val),
  // Remove
  remove: (path) => db.ref(path).remove(),
  // Listen (realtime)
  on: (path, ev, cb) => db.ref(path).on(ev, s => cb(s.val(), s.key)),
  // Off
  off: (path) => db.ref(path).off(),
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SECURITY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SEC = {
  TOKEN_KEY:'px_tok',TOKEN_USER:'px_user',TOKEN_EXPIRY:'px_exp',TOKEN_HASH:'px_hash',
  FAIL_KEY:'px_fail_',LOCK_KEY:'px_lock_',REMEMBER:'px_rem',
  MAX_FAILS:5,LOCK_SECS:30,SESSION_SECS:1800,REMEMBER_DAYS:7,
};
let _rememberMe = false, _inactivityTimer = null;

async function sha256(str) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
function genToken() {
  const a = new Uint8Array(32);
  crypto.getRandomValues(a);
  return Array.from(a).map(b=>b.toString(16).padStart(2,'0')).join('');
}
function getFailCount(un) { return parseInt(localStorage.getItem(SEC.FAIL_KEY+un)||'0'); }
function incFail(un) {
  const n = getFailCount(un)+1;
  localStorage.setItem(SEC.FAIL_KEY+un, n);
  if (n >= SEC.MAX_FAILS) localStorage.setItem(SEC.LOCK_KEY+un, Date.now()+SEC.LOCK_SECS*1000);
  return n;
}
function clearFail(un) { localStorage.removeItem(SEC.FAIL_KEY+un); localStorage.removeItem(SEC.LOCK_KEY+un); }
function getLockRemain(un) { const u=parseInt(localStorage.getItem(SEC.LOCK_KEY+un)||'0'); const r=Math.ceil((u-Date.now())/1000); return r>0?r:0; }

async function createSession(un, remember) {
  const tok = genToken();
  const hash = await sha256(tok+un+navigator.userAgent.slice(0,30));
  const store = remember ? localStorage : sessionStorage;
  const exp = remember ? Date.now()+SEC.REMEMBER_DAYS*86400000 : Date.now()+SEC.SESSION_SECS*1000;
  [localStorage,sessionStorage].forEach(s=>{s.removeItem(SEC.TOKEN_KEY);s.removeItem(SEC.TOKEN_USER);s.removeItem(SEC.TOKEN_EXPIRY);s.removeItem(SEC.TOKEN_HASH);});
  store.setItem(SEC.TOKEN_KEY,tok); store.setItem(SEC.TOKEN_USER,un);
  store.setItem(SEC.TOKEN_EXPIRY,exp); store.setItem(SEC.TOKEN_HASH,hash);
  if(remember) localStorage.setItem(SEC.REMEMBER,'1');
}

async function validateSession() {
  for (const store of [sessionStorage,localStorage]) {
    const tok=store.getItem(SEC.TOKEN_KEY), hash=store.getItem(SEC.TOKEN_HASH);
    const user=store.getItem(SEC.TOKEN_USER), exp=parseInt(store.getItem(SEC.TOKEN_EXPIRY)||'0');
    if(!tok||!hash||!user||!exp) continue;
    if(Date.now()>exp) { store.removeItem(SEC.TOKEN_KEY); continue; }
    const expected = await sha256(tok+user+navigator.userAgent.slice(0,30));
    if(expected!==hash) { clearSession(); return null; }
    if(store===sessionStorage) store.setItem(SEC.TOKEN_EXPIRY,Date.now()+SEC.SESSION_SECS*1000);
    return user;
  }
  return null;
}

function clearSession() {
  [localStorage,sessionStorage].forEach(s=>{
    [SEC.TOKEN_KEY,SEC.TOKEN_USER,SEC.TOKEN_EXPIRY,SEC.TOKEN_HASH].forEach(k=>s.removeItem(k));
  });
  localStorage.removeItem(SEC.REMEMBER);
}

function startInactivity() {
  if(_rememberMe) return;
  clearTimeout(_inactivityTimer);
  _inactivityTimer = setTimeout(()=>{notify('Session expired','err');setTimeout(doLogout,1500);},SEC.SESSION_SECS*1000);
}
function resetInactivity() { if(!_rememberMe){clearTimeout(_inactivityTimer);startInactivity();} }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOCAL INDEXEDDB ‚Äî for storing uploaded file blobs only
// (Firebase free tier has no file storage, so files stored locally)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let IDB = null;
async function openIDB() {
  return new Promise((resolve) => {
    const req = indexedDB.open('PrimoraXFiles_v1', 1);
    req.onupgradeneeded = e => {
      const d = e.target.result;
      if (!d.objectStoreNames.contains('files')) d.createObjectStore('files',{keyPath:'id'});
    };
    req.onsuccess = e => { IDB = e.target.result; resolve(); };
    req.onerror = () => resolve();
  });
}
function saveFile(id, data) {
  return new Promise(r => {
    if(!IDB){r();return;}
    const tx = IDB.transaction('files','readwrite');
    tx.objectStore('files').put({id,...data});
    tx.oncomplete=r; tx.onerror=r;
  });
}
function getFile(id) {
  return new Promise(r => {
    if(!IDB){r(null);return;}
    const tx=IDB.transaction('files','readonly');
    const req=tx.objectStore('files').get(id);
    req.onsuccess=()=>r(req.result||null);
    req.onerror=()=>r(null);
  });
}
function delFile(id) {
  return new Promise(r => {
    if(!IDB){r();return;}
    const tx=IDB.transaction('files','readwrite');
    tx.objectStore('files').delete(id);
    tx.oncomplete=r; tx.onerror=r;
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEFAULT USERS ‚Äî stored in Firebase on first run
// CEO can add/edit/disable users via the UI permanently
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEFAULT_USERS = {
  'sumukh.ceo'       : {password:'PrimoraX@CEO2025',    name:'Sumukh Bharadwaj K S', role:'CEO',  domain:'Management',                      avatar:'SB', color:'#7b1fa2', enabled:true},
  'vishal.elec'      : {password:'elec@vishal01',        name:'Vishal Rajoor',         role:'team', domain:'Electronics',                    avatar:'VR', color:'#1d4ed8', enabled:true},
  'yashas.mech'      : {password:'mech@yashas01',        name:'Yashas Raj',            role:'team', domain:'Mechanical',                     avatar:'YR', color:'#0f766e', enabled:true},
  'vaishak.analysis' : {password:'analysis@vaishak01',   name:'Vaishakh Shetty B',     role:'team', domain:'Analysis',                      avatar:'VS', color:'#1d4ed8', enabled:true},
  'subbaiah.research': {password:'research@subbaiah01',  name:'Thaman Subbaiah',       role:'team', domain:'Research',                      avatar:'TS', color:'#6d28d9', enabled:true},
  'thilak.media'     : {password:'media@thilak01',       name:'Thilak',                role:'team', domain:'Media',                         avatar:'TM', color:'#be185d', enabled:true},
  'bindushree.coord' : {password:'coord@bindushree01',   name:'Bindushree H M',        role:'team', domain:'Research',                      avatar:'BH', color:'#6d28d9', enabled:true},
  'manoj.elec'       : {password:'elec@manoj01',         name:'Manoj Y S',             role:'team', domain:'Electronics Assembly & Testing', avatar:'MY', color:'#c2410c', enabled:true},
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APP STATE ‚Äî live from Firebase
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let USERS = {};
let projects = [];
let tasks = [];
let docs = [];
let archNotes = [];
let projComments = {};
let groupChat = [];
let uploadedFile = null;
let CU = null;
let page = 'dashboard';
let selProj = null;
let activeTab = 'overview';
let taskExp = {};
let docOpen = {};
let fStatus = 'All';
let fVis = 'all';
let fTask = 'All';
let selMembers = [];
let typingUsers = {};
let typingTimeout = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE REALTIME LISTENERS ‚Äî the magic that keeps
// everything live without page reloads
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let fbListeners = [];

function startListeners() {
  // Projects
  db.ref('projects').on('value', snap => {
    const val = snap.val() || {};
    projects = Object.entries(val).map(([id,p])=>({...p,fbKey:id}));
    if(page==='dashboard'||page==='projects'||page==='proj-detail') safeRender();
    buildWelcomeStats();
  });

  // Tasks
  db.ref('tasks').on('value', snap => {
    const val = snap.val() || {};
    tasks = Object.entries(val).map(([id,t])=>({...t,fbKey:id}));
    if(page==='dashboard'||page==='tasks'||page==='proj-detail') safeRender();
  });

  // Docs
  db.ref('docs').on('value', snap => {
    const val = snap.val() || {};
    docs = Object.entries(val).map(([id,d])=>({...d,fbKey:id}));
    if(page==='documents'||page==='proj-detail') safeRender();
  });

  // Architecture Notes
  db.ref('archNotes').on('value', snap => {
    const val = snap.val() || {};
    archNotes = Object.entries(val).map(([id,n])=>({...n,fbKey:id}));
    if(page==='architecture') safeRender();
  });

  // Project Comments
  db.ref('projComments').on('value', snap => {
    projComments = snap.val() || {};
    if(page==='proj-detail'&&activeTab==='comments') safeRender();
  });

  // Users (live, CEO can manage)
  db.ref('users').on('value', snap => {
    USERS = snap.val() || {};
    if(page==='users') safeRender();
    renderSidebar(); // update avatar etc
  });

  // Group Chat (live)
  db.ref('groupChat').on('child_added', snap => {
    const val = snap.val();
    if (!val) return;
    const msg = {...val, fbKey:snap.key};
    if (!groupChat.find(m=>m.fbKey===snap.key)) {
      groupChat.push(msg);
      groupChat.sort((a,b)=>(a.ts||0)-(b.ts||0));
    }
    if(page==='groupchat') {
      const area = $('chat-messages');
      if(area) { area.innerHTML = buildChatMessages(); area.scrollTop = area.scrollHeight; }
    }
  });

  // Presence (typing indicators)
  db.ref('presence').on('value', snap => {
    const pres = snap.val() || {};
    const now = Date.now();
    typingUsers = {};
    Object.keys(pres).forEach(un => {
      if(un !== CU.username && pres[un]?.typing && (now - pres[un].lastSeen < 5000)) {
        typingUsers[un] = pres[un].lastSeen;
      }
    });
    if(page==='groupchat') {
      const area = $('chat-messages');
      if(area) { const scrollPos = area.scrollHeight - area.scrollTop; area.innerHTML = buildChatMessages(); area.scrollTop = area.scrollHeight - scrollPos; }
    }
    // Update online count
    const online = Object.keys(pres).filter(u => pres[u]?.lastSeen > now - 300000);
    const onlineEl = $('online-count');
    if(onlineEl) onlineEl.textContent = online.length;
  });
}

function stopListeners() {
  ['projects','tasks','docs','archNotes','projComments','users','groupChat','presence'].forEach(p => db.ref(p).off());
}

let _renderDebounce = null;
function safeRender() {
  clearTimeout(_renderDebounce);
  _renderDebounce = setTimeout(() => { if(CU && page) renderContent(); }, 80);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SC = {Created:'#60a5fa',Approved:'#22c55e','In Development':'#f59e0b',Review:'#a855f7',Delivered:'#6ee7b7',Archived:'#475569','In Progress':'#f59e0b',Completed:'#6ee7b7','Not Started':'#64748b'};
const VC = {'ceo-only':{l:'CEO Only',c:'#ef4444',i:'üëë'},'team-only':{l:'Team Only',c:'#60a5fa',i:'üë•'},shared:{l:'Shared',c:'#22c55e',i:'üåê'}};
const FI = {pdf:'üìÑ',xlsx:'üìä',docx:'üìù',zip:'üì¶',png:'üñº',jpg:'üñº',jpeg:'üñº',gif:'üñº',mp4:'üé¨',mp3:'üéµ',dwg:'üìê',txt:'üìã',ppt:'üìä',pptx:'üìä'};
const QUOTES = ['Build something that matters.','Excellence is in the details.','Every great project starts with a clear plan.','Precision drives progress.','Data tells the story ‚Äî you write it.','Presentation is everything.'];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const $ = id => document.getElementById(id);
const isCEO = () => CU?.role === 'CEO';
const myProj = () => isCEO() ? projects : projects.filter(p => (p.assignedMembers||[]).includes(CU.username));
const myTasks = () => isCEO() ? tasks : tasks.filter(t => t.assignedTo === CU.username);
function canSee(d) {
  if(isCEO()) return true;
  if(d.visibility==='ceo-only') return false;
  if(d.visibility==='team-only') return true;
  if(d.visibility==='shared') { const p=projects.find(x=>x.id===d.projectId); return p?.assignedMembers?.includes(CU.username); }
  return false;
}
function fi(t) { return FI[t?.toLowerCase()]||'üìé'; }
function fmtD(d) { if(!d)return'‚Äî'; return new Date(d).toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'}); }
function fmtDT(d) { return new Date(d).toLocaleDateString('en-IN',{weekday:'long',day:'2-digit',month:'long',year:'numeric'}); }
function fmtSize(b) { if(!b)return'‚Äî'; if(b<1024)return b+' B'; if(b<1048576)return(b/1024).toFixed(1)+' KB'; return(b/1048576).toFixed(1)+' MB'; }
function bdg(label,color,sm) {
  const p=sm?'2px 7px':'3px 10px', f=sm?'10px':'11px';
  return `<span class="badge" style="background:${color}25;color:${color};border:1px solid ${color}45;padding:${p};font-size:${f};">${label}</span>`;
}
function av(init,sz=36,col='#1d4ed8') {
  return `<div class="avatar" style="width:${sz}px;height:${sz}px;background:${col};font-size:${Math.round(sz*.36)}px;color:#fff;">${init}</div>`;
}
function pb(val,col='#3b82f6') {
  return `<div class="pbar-wrap"><div class="pbar" style="width:${Math.min(100,val||0)}%;background:${col};"></div></div>`;
}
function gid(p) { return p+'-'+Date.now().toString().slice(-6); }
function greetWord() { const h=new Date().getHours(); return h<12?'Good morning':h<17?'Good afternoon':'Good evening'; }
function notify(msg,type='ok') {
  const n=$('notif'); n.textContent=(type==='err'?'‚ö† ':'‚úì ')+msg; n.className=type==='err'?'err':'';
  n.style.display='block'; clearTimeout(n._t); n._t=setTimeout(()=>n.style.display='none',3200);
}
function toggleSB(){$('sidebar').classList.toggle('open');$('sb-overlay').classList.toggle('on');}
function closeSB(){$('sidebar').classList.remove('open');$('sb-overlay').classList.remove('on');}
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));$(id).classList.add('active');}
function escHtml(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/\n/g,'<br>');}
function readFileAsDataURL(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.onerror=rej;r.readAsDataURL(file);});}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _rmOn = false;
function toggleRM() {
  _rmOn = !_rmOn;
  $('rm-track').style.background = _rmOn?'rgba(59,130,246,.3)':'var(--bg5)';
  $('rm-track').style.borderColor = _rmOn?'var(--accent)':'var(--border2)';
  $('rm-thumb').style.left = _rmOn?'18px':'1px';
  $('rm-thumb').style.background = _rmOn?'var(--accent2)':'var(--text5)';
}
function togglePW(){const p=$('l-pass');p.type=p.type==='password'?'text':'password';$('l-eye').textContent=p.type==='password'?'üëÅ':'üôà';}
$('l-pass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
$('l-user').addEventListener('keydown',e=>{if(e.key==='Enter')$('l-pass').focus();});

async function doLogin() {
  const un=$('l-user').value.trim().toLowerCase();
  const pw=$('l-pass').value;
  const errEl=$('l-err'), lockEl=$('l-lock');

  const lockRemain = getLockRemain(un);
  if(lockRemain>0) {
    lockEl.style.display='block';
    lockEl.textContent=`‚è± Locked. Try again in ${lockRemain}s.`;
    const t=setInterval(()=>{const r=getLockRemain(un);if(r<=0){clearInterval(t);lockEl.style.display='none';}else lockEl.textContent=`‚è± Locked. Try again in ${r}s.`;},1000);
    return;
  }

  const u = USERS[un];
  if(u && u.password===pw && u.enabled!==false) {
    clearFail(un);
    CU = {username:un,...u};
    _rememberMe = _rmOn;
    await createSession(un,_rmOn);
    // Set presence
    setPresence();
    startInactivity();
    ['click','keydown','touchstart','scroll'].forEach(e=>document.addEventListener(e,resetInactivity,{passive:true}));
    startListeners();
    showScreen('s-app');
    initApp();
  } else {
    const fails = incFail(un);
    const rem = SEC.MAX_FAILS - fails;
    errEl.style.display='block';
    errEl.textContent = rem>0 ? `‚ö† Invalid credentials. ${rem} attempt${rem!==1?'s':''} remaining.` : '‚õî Account locked for 30 seconds.';
    setTimeout(()=>errEl.style.display='none',4000);
    const card=document.querySelector('.login-card');
    card.style.animation='none'; card.offsetHeight; card.style.animation='shake .4s ease';
  }
}

function setPresence() {
  if(!db||!CU) return;
  const ref = db.ref(`presence/${CU.username}`);
  ref.set({online:true,lastSeen:Date.now(),typing:false,name:CU.name});
  ref.onDisconnect().set({online:false,lastSeen:Date.now(),typing:false,name:CU.name});
}

async function doLogout() {
  clearTimeout(_inactivityTimer);
  if(db&&CU) {
    stopListeners();
    db.ref(`presence/${CU.username}`).set({online:false,lastSeen:Date.now(),typing:false});
  }
  clearSession();
  CU=null;selProj=null;page='dashboard';
  projects=[];tasks=[];docs=[];archNotes=[];projComments={};groupChat=[];
  showScreen('s-login');
  $('l-user').value='';$('l-pass').value='';
  _rmOn=false;
  $('rm-track').style.background='var(--bg5)';$('rm-track').style.borderColor='var(--border2)';
  $('rm-thumb').style.left='1px';$('rm-thumb').style.background='var(--text5)';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APP INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initApp() {
  if(window.innerWidth<=768) $('menu-btn').style.display='flex';
  renderSidebar();
  navigate('dashboard');
}

function navigate(p, proj) {
  page=p;
  if(p!=='proj-detail') selProj=null;
  if(proj) selProj=proj;
  activeTab='overview'; taskExp={}; docOpen={};
  fStatus='All'; fVis='all'; fTask='All';
  renderTopBar(); renderSidebar(); updateBottomNav();
  const c=$('content');
  c.innerHTML='';
  c.style.padding = p==='groupchat'?'0':'';
  c.style.overflow = p==='groupchat'?'hidden':'';
  setTimeout(renderContent,10);
  closeSB();
}

function updateBottomNav() {
  ['dashboard','projects','tasks','groupchat'].forEach(id=>{
    const el=$('bn-'+id);
    if(el) el.classList.toggle('active',page===id||(id==='projects'&&page==='proj-detail'));
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SIDEBAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSidebar() {
  if(!CU) return;
  const navItems=[
    {id:'dashboard',icon:'‚óà',label:'Dashboard'},
    {id:'projects',icon:'‚¨°',label:'Projects'},
    {id:'tasks',icon:'‚óé',label:'Tasks'},
    {id:'documents',icon:'‚ñ£',label:'Documents'},
    {id:'groupchat',icon:'üí¨',label:'Group Chat'},
    {id:'architecture',icon:'‚¨¢',label:'Architecture'},
    ...(isCEO()?[
      {id:'finance',icon:'‚óÜ',label:'Finance',ceo:true},
      {id:'delivery',icon:'‚ñ∂',label:'Delivery',ceo:true},
      {id:'users',icon:'‚óâ',label:'Users',ceo:true},
    ]:[]),
  ];
  const isActive=id=>page===id||(page==='proj-detail'&&id==='projects');
  $('sb-nav').innerHTML=`
    <div class="sb-sec">Navigation</div>
    ${navItems.map(n=>`
    <button class="nav-btn${isActive(n.id)?' active':''}" onclick="navigate('${n.id}')">
      <span class="nav-icon">${n.icon}</span>
      <span class="nav-label">${n.label}</span>
      ${n.ceo?`<span class="nav-tag">CEO</span>`:''}
    </button>`).join('')}`;

  $('sb-user').innerHTML=`
    <div class="sb-user-inner">
      ${av(CU.avatar,36,CU.color)}
      <div style="min-width:0;">
        <div class="sb-uname">${CU.name.split(' ').slice(0,2).join(' ')}</div>
        <div class="sb-urole">${isCEO()?'üëë CEO':CU.domain}</div>
      </div>
    </div>
    <button class="btn-signout" onclick="doLogout()">Sign Out</button>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOPBAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderTopBar() {
  if(!CU) return;
  const labels={dashboard:'Dashboard',projects:'Projects','proj-detail':selProj?selProj.id:'Project',tasks:'Tasks',documents:'Documents',finance:'Finance',users:'Users',delivery:'Delivery',architecture:'Architecture',groupchat:'Group Chat'};
  $('tb-title').textContent=labels[page]||'‚Äî';
  $('tb-sub').innerHTML=`<span id="conn-dot" class="live-dot" style="background:${dbReady?'var(--green)':'var(--red)'};"></span><span id="conn-lbl">${dbReady?'Live':'Offline'}</span> ¬∑ ${new Date().toLocaleDateString('en-IN',{weekday:'short',day:'2-digit',month:'short'})}`;
  $('tb-right').innerHTML=isCEO()?bdg('üëë CEO','#a855f7',true):bdg(CU.domain.split(' ')[0],'#60a5fa',true);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderContent() {
  if(!CU) return;
  const c=$('content');
  const map={
    dashboard:renderDashboard,projects:renderProjects,'proj-detail':renderProjDetail,
    tasks:renderTasksPage,documents:renderDocsPage,groupchat:renderGroupChat,
    finance:isCEO()?renderFinance:renderDashboard,
    users:isCEO()?renderUsers:renderDashboard,
    delivery:isCEO()?renderDelivery:renderDashboard,
    architecture:renderArchitecture,
  };
  c.innerHTML=`<div class="page">${(map[page]||renderDashboard)()}</div>`;
  if(page==='groupchat') afterChatRender();
}

// ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildWelcomeStats() {}
function renderDashboard() {
  const mp=myProj(), mt=myTasks();
  const stats=isCEO()?[
    {icon:'‚¨°',val:projects.length,lbl:'Total Projects',color:'var(--accent2)'},
    {icon:'‚óé',val:tasks.filter(t=>t.status==='In Progress').length,lbl:'Active Tasks',color:'var(--amber)'},
    {icon:'‚ñ£',val:docs.length,lbl:'Documents',color:'var(--green)'},
    {icon:'‚óÜ',val:'‚Çπ'+projects.reduce((s,p)=>s+(p.revenue||0),0).toLocaleString('en-IN'),lbl:'Total Revenue',color:'var(--purple)'},
  ]:[
    {icon:'‚¨°',val:mp.length,lbl:'My Projects',color:'var(--accent2)'},
    {icon:'‚óé',val:mt.filter(t=>t.status==='In Progress').length,lbl:'In Progress',color:'var(--amber)'},
    {icon:'‚úì',val:mt.filter(t=>t.status==='Completed').length,lbl:'Completed',color:'var(--green)'},
    {icon:'‚ñ£',val:docs.filter(canSee).length,lbl:'My Docs',color:'var(--purple)'},
  ];
  return `
  <div style="margin-bottom:22px;">
    <div style="font-family:var(--fd);font-weight:800;font-size:21px;letter-spacing:-.04em;">${greetWord()}, ${CU.name.split(' ')[0]} üëã</div>
    <div style="font-size:12px;color:var(--text4);margin-top:5px;font-family:var(--fm);">${fmtDT(new Date())} ¬∑ ${isCEO()?'Full system overview':'Your workspace'}</div>
  </div>
  <div class="g4" style="margin-bottom:22px;">
    ${stats.map(s=>`
    <div class="stat-card">
      <div class="stat-icon">${s.icon}</div>
      <div class="stat-val" style="color:${s.color};">${s.val}</div>
      <div class="stat-lbl">${s.lbl}</div>
    </div>`).join('')}
  </div>
  <div class="g2">
    <div class="card" style="padding:18px 20px;">
      <div class="flex-between" style="margin-bottom:14px;">
        <div class="sec-head" style="margin:0;">${isCEO()?'All Projects':'My Projects'}</div>
        <button class="btn-sm" onclick="navigate('projects')">View all ‚Üí</button>
      </div>
      ${mp.slice(0,4).map(p=>`
      <div class="proj-card" style="padding:11px 13px;" onclick="openProj('${p.id}')">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
          <div style="min-width:0;">
            <div style="font-size:10px;color:var(--accent2);font-family:var(--fm);font-weight:600;margin-bottom:3px;">${p.id}</div>
            <div style="font-size:13px;font-weight:600;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${p.title}</div>
          </div>
          ${bdg(p.status,SC[p.status]||'#64748b',true)}
        </div>
        <div style="margin-top:8px;">${pb(tasks.filter(t=>t.projectId===p.id).reduce((s,t,_,a)=>s+(a.length?t.progress/a.length:0),0)||0,SC[p.status]||'#3b82f6')}</div>
      </div>`).join('')}
      ${mp.length===0?'<div class="empty" style="padding:28px;"><span class="empty-icon">üìÇ</span>No projects yet</div>':''}
    </div>
    <div class="card" style="padding:18px 20px;">
      <div class="flex-between" style="margin-bottom:14px;">
        <div class="sec-head" style="margin:0;">${isCEO()?'All Tasks':'My Tasks'}</div>
        <button class="btn-sm" onclick="navigate('tasks')">View all ‚Üí</button>
      </div>
      ${mt.slice(0,5).map(t=>{
        const proj=projects.find(p=>p.id===t.projectId);
        const od=t.deadline&&new Date(t.deadline)<new Date()&&t.status!=='Completed';
        return `
        <div style="padding:10px 12px;background:var(--bg4);border-radius:9px;margin-bottom:7px;border:1px solid var(--border);">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;gap:8px;">
            <div style="font-size:13px;font-weight:500;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${t.title}</div>
            ${bdg(t.status,SC[t.status]||'#64748b',true)}
            ${od?bdg('Overdue','#ef4444',true):''}
          </div>
          <div style="font-size:10px;color:var(--text4);font-family:var(--fm);margin-bottom:5px;">${proj?.id||''} ¬∑ Due ${fmtD(t.deadline)}</div>
          <div style="display:flex;align-items:center;gap:8px;">${pb(t.progress,SC[t.status]||'#3b82f6')}<span style="font-size:10px;color:var(--accent2);font-family:var(--fm);flex-shrink:0;">${t.progress||0}%</span></div>
        </div>`;
      }).join('')}
      ${mt.length===0?'<div class="empty" style="padding:28px;"><span class="empty-icon">‚úì</span>No tasks assigned</div>':''}
    </div>
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ PROJECTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderProjects() {
  const mp=myProj();
  const filt=fStatus==='All'?mp:mp.filter(p=>p.status===fStatus);
  return `
  <div class="flex-between" style="margin-bottom:16px;gap:10px;">
    <div class="filter-bar" style="margin:0;flex:1;flex-wrap:wrap;">
      ${['All','Created','Approved','In Development','Review','Delivered','Archived'].map(s=>`
      <button class="fbtn${fStatus===s?' on':''}" onclick="fStatus='${s}';renderContent()">${s}</button>`).join('')}
    </div>
    ${isCEO()?`<button class="btn-p" onclick="mCreateProj()">+ New Project</button>`:''}
  </div>
  ${filt.map(p=>projCard(p)).join('')}
  ${filt.length===0?'<div class="empty"><span class="empty-icon">üîç</span>No projects found</div>':''}`;
}

function openProj(id) {
  const p=projects.find(x=>x.id===id);
  if(p){selProj=p;page='proj-detail';activeTab='overview';renderTopBar();renderSidebar();updateBottomNav();renderContent();}
}

function projCard(p) {
  const members=(p.assignedMembers||[]).slice(0,4).map((un,i)=>{
    const u=USERS[un];return u?`<div style="margin-left:${i>0?'-9px':'0'};z-index:${4-i};position:relative;">${av(u.avatar,28,u.color)}</div>`:'';}).join('');
  const pt=tasks.filter(t=>t.projectId===p.id);
  const overall=pt.length?Math.round(pt.reduce((s,t)=>s+t.progress,0)/pt.length):0;
  return `
  <div class="proj-card" onclick="openProj('${p.id}')">
    <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;">
      <div style="flex:1;min-width:0;">
        <div style="display:flex;align-items:center;gap:7px;flex-wrap:wrap;margin-bottom:6px;">
          <span style="font-size:11px;color:var(--accent2);font-family:var(--fm);font-weight:600;">${p.id}</span>
          ${bdg(p.status,SC[p.status]||'#64748b',true)}
          ${bdg(p.branch,'#475569',true)}
        </div>
        <div style="font-family:var(--fd);font-weight:700;font-size:15px;color:var(--text);margin-bottom:5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${p.title}</div>
        <div style="font-size:12px;color:var(--text4);margin-bottom:10px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;">${p.description||'No description'}</div>
        <div style="display:flex;align-items:center;gap:8px;">${pb(overall,SC[p.status]||'#3b82f6')}<span style="font-size:10px;color:var(--text4);font-family:var(--fm);flex-shrink:0;">${overall}%</span></div>
        <div style="display:flex;gap:14px;font-size:11px;color:var(--text4);font-family:var(--fm);flex-wrap:wrap;margin-top:8px;">
          <span>üìÖ ${fmtD(p.deadline)}</span>
          <span>üë• ${(p.assignedMembers||[]).length}</span>
          ${isCEO()?`<span style="color:var(--purple);">‚Çπ${(p.budget||0).toLocaleString('en-IN')}</span>`:''}
        </div>
      </div>
      <div style="display:flex;align-items:center;flex-shrink:0;margin-top:4px;">${members}</div>
    </div>
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ PROJECT DETAIL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderProjDetail() {
  if(!selProj) return '<div class="empty">No project selected</div>';
  // Sync selProj with live data
  const live = projects.find(p=>p.id===selProj.id);
  if(live) selProj=live;
  const p=selProj;
  const tabs=['overview','tasks','documents','comments'];
  if(isCEO()) tabs.push('payments');
  let body='';
  if(activeTab==='overview')body=tabOverview(p);
  else if(activeTab==='tasks')body=tabTasks(p);
  else if(activeTab==='documents')body=tabDocs(p);
  else if(activeTab==='comments')body=tabComments(p);
  else if(activeTab==='payments')body=tabPayments(p);
  return `
  <button class="back-btn" onclick="navigate('projects')">‚Üê Back to Projects</button>
  <div class="flex-between" style="margin-bottom:18px;">
    <div>
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:6px;">
        <span style="font-family:var(--fm);font-size:11px;color:var(--accent2);font-weight:600;">${p.id}</span>
        ${bdg(p.status,SC[p.status]||'#64748b')}
        ${bdg(p.branch,'#475569',true)}
      </div>
      <h2 style="font-family:var(--fd);font-weight:800;font-size:18px;letter-spacing:-.03em;line-height:1.3;">${p.title}</h2>
    </div>
    <div style="display:flex;gap:7px;flex-wrap:wrap;">
      ${isCEO()?`<button class="btn-s" onclick="mStatusChange()" style="padding:8px 12px;font-size:12px;">Change Status</button>`:''}
      <button class="btn-s" onclick="mUploadDoc('${p.id}')" style="padding:8px 12px;font-size:12px;">+ Upload</button>
      ${isCEO()?`<button class="btn-p" onclick="mCreateTask('${p.id}')" style="padding:8px 12px;font-size:12px;">+ Task</button>`:''}
    </div>
  </div>
  <div class="tabs">
    ${tabs.map(t=>`<button class="tab${activeTab===t?' on':''}" onclick="activeTab='${t}';renderContent()">${t}</button>`).join('')}
  </div>
  ${body}`;
}

function tabOverview(p) {
  const pt=tasks.filter(t=>t.projectId===p.id);
  const overall=pt.length?Math.round(pt.reduce((s,t)=>s+t.progress,0)/pt.length):0;
  return `
  <div class="g2">
    <div class="card" style="padding:18px 20px;">
      <div class="sec-head">Project Info</div>
      <div class="irow"><span class="il">Type</span><span class="iv">${p.type||'‚Äî'}</span></div>
      <div class="irow"><span class="il">Branch</span><span class="iv">${p.branch||'‚Äî'}</span></div>
      <div class="irow"><span class="il">Year</span><span class="iv">${p.year||'‚Äî'}</span></div>
      <div class="irow"><span class="il">Created</span><span class="iv">${fmtD(p.createdAt)}</span></div>
      <div class="irow"><span class="il">Deadline</span><span class="iv">${fmtD(p.deadline)}</span></div>
      ${isCEO()?`<div class="irow"><span class="il">Budget</span><span class="iv" style="color:var(--purple);">‚Çπ${(p.budget||0).toLocaleString('en-IN')}</span></div>`:''}
      <div style="margin-top:14px;padding-top:12px;border-top:1px solid var(--border);">
        <div style="font-size:10px;color:var(--text4);font-family:var(--fm);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;">Overall Progress</div>
        ${pb(overall,'var(--accent2)')}
        <div style="text-align:right;font-size:11px;color:var(--accent2);font-family:var(--fm);margin-top:5px;">${overall}%</div>
      </div>
    </div>
    <div class="card" style="padding:18px 20px;">
      <div class="sec-head">Team</div>
      ${(p.assignedMembers||[]).map(un=>{const u=USERS[un];return u?`
      <div style="display:flex;align-items:center;gap:10px;padding:9px 12px;background:var(--bg4);border-radius:var(--r8);margin-bottom:7px;border:1px solid var(--border);">
        ${av(u.avatar,32,u.color)}
        <div><div style="font-size:13px;font-weight:500;color:var(--text2);">${u.name}</div><div style="font-size:10px;color:var(--text4);font-family:var(--fm);">${u.domain}</div></div>
      </div>`:''}).join('')}
      ${(p.assignedMembers||[]).length===0?'<div style="color:var(--text5);font-size:12px;font-family:var(--fm);">No members assigned</div>':''}
    </div>
    <div class="card" style="padding:18px 20px;grid-column:span 2;">
      <div class="sec-head">Description & Requirements</div>
      <p style="font-size:13px;color:var(--text3);line-height:1.8;margin-bottom:14px;">${p.description||'‚Äî'}</p>
      <div style="font-size:10px;color:var(--text4);font-family:var(--fm);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;">Requirements</div>
      <p style="font-size:13px;color:var(--text3);line-height:1.75;">${p.requirements||'‚Äî'}</p>
      ${isCEO()?`<div style="margin-top:14px;"><button class="btn-sm" onclick="mEditProj('${p.id}')">‚úè Edit Project Details</button></div>`:''}
    </div>
  </div>`;
}

function tabTasks(p) {
  const pt=isCEO()?tasks.filter(t=>t.projectId===p.id):tasks.filter(t=>t.projectId===p.id&&t.assignedTo===CU.username);
  if(!pt.length) return `<div class="empty"><span class="empty-icon">üìã</span>${isCEO()?'No tasks yet. Tap "+ Task" above.':'No tasks assigned to you.'}</div>`;
  return pt.map(t=>taskCard(t)).join('');
}

function taskCard(t) {
  const u=USERS[t.assignedTo];
  const canEdit=isCEO()||t.assignedTo===CU.username;
  const exp=taskExp[t.fbKey||t.id];
  const od=t.deadline&&new Date(t.deadline)<new Date()&&t.status!=='Completed';
  return `
  <div class="task-card">
    <div class="tc-head" onclick="toggleTE('${t.fbKey||t.id}')">
      <div style="display:flex;align-items:center;gap:10px;">
        <div style="flex:1;min-width:0;">
          <div style="display:flex;align-items:center;gap:7px;flex-wrap:wrap;margin-bottom:5px;">
            <span style="font-size:10px;color:var(--accent2);font-family:var(--fm);font-weight:600;">${t.id}</span>
            ${bdg(t.status,SC[t.status]||'#64748b',true)}
            ${od?bdg('Overdue','#ef4444',true):''}
          </div>
          <div style="font-size:14px;font-weight:600;color:var(--text2);margin-bottom:8px;">${t.title}</div>
          <div style="display:flex;align-items:center;gap:8px;">${pb(t.progress||0,SC[t.status]||'#3b82f6')}<span style="font-size:10px;color:var(--accent2);font-family:var(--fm);flex-shrink:0;">${t.progress||0}%</span></div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:5px;margin-left:8px;flex-shrink:0;">
          ${u?av(u.avatar,30,u.color):''}
          <span style="font-size:10px;color:var(--text5);font-family:var(--fm);">Due ${fmtD(t.deadline)}</span>
        </div>
        <span style="color:var(--text5);font-size:12px;margin-left:6px;">${exp?'‚ñ≤':'‚ñº'}</span>
      </div>
    </div>
    ${exp?`
    <div class="tc-body">
      ${canEdit?`
      <div style="margin-bottom:14px;padding:13px;background:var(--bg4);border-radius:var(--r8);border:1px solid var(--border);">
        <div style="font-size:10px;color:var(--text4);font-family:var(--fm);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;">Update Progress</div>
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
          <input type="range" min="0" max="100" value="${t.progress||0}" 
            oninput="updTP('${t.fbKey||t.id}',this.value);this.nextElementSibling.textContent=this.value+'%'"
            style="flex:1;accent-color:var(--accent);height:20px;">
          <span style="font-size:12px;color:var(--accent2);font-family:var(--fm);width:38px;flex-shrink:0;">${t.progress||0}%</span>
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;">
          ${['Not Started','In Progress','Review','Completed'].map(s=>`
          <button onclick="updTS('${t.fbKey||t.id}','${s}')" style="padding:7px 11px;border-radius:6px;font-size:11px;font-family:var(--fm);background:${t.status===s?'rgba(59,130,246,.2)':'var(--bg3)'};color:${t.status===s?'var(--accent2)':'var(--text3)'};border:1px solid ${t.status===s?'var(--accent)':'var(--border2)'};min-height:36px;">${s}</button>`).join('')}
        </div>
      </div>`:''}
      <div style="font-size:10px;color:var(--text4);font-family:var(--fm);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;">Notes</div>
      ${Object.values(t.notes||{}).sort((a,b)=>a.ts-b.ts).map(n=>`
      <div class="note-item">
        <div style="display:flex;justify-content:space-between;margin-bottom:4px;flex-wrap:wrap;gap:6px;">
          <span style="font-size:11px;font-weight:600;color:var(--text2);">${n.name}</span>
          <span style="font-size:10px;color:var(--text5);font-family:var(--fm);">${new Date(n.ts).toLocaleString('en-IN',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'})}</span>
        </div>
        <div style="font-size:12px;color:var(--text3);line-height:1.6;">${escHtml(n.text)}</div>
      </div>`).join('')}
      <div style="display:flex;gap:8px;margin-top:8px;">
        <input class="inp-sm" id="ni-${t.fbKey||t.id}" placeholder="Write a note‚Ä¶" style="flex:1;" onkeydown="if(event.key==='Enter')addNote('${t.fbKey||t.id}')">
        <button class="btn-p" style="padding:10px 14px;font-size:12px;" onclick="addNote('${t.fbKey||t.id}')">Add</button>
      </div>
      ${isCEO()?`<div style="margin-top:10px;"><button class="btn-danger" onclick="delTask('${t.fbKey||t.id}')">üóë Delete Task</button></div>`:''}
    </div>`:''}
  </div>`;
}

function tabDocs(p) {
  const pd=docs.filter(d=>d.projectId===p.id&&canSee(d));
  if(!pd.length) return `<div class="empty"><span class="empty-icon">üìÅ</span>No documents yet. Tap "+ Upload".</div>`;
  return pd.map(d=>docCard(d)).join('');
}

function docCard(d) {
  const vc=VC[d.visibility]||VC.shared;
  const t=tasks.find(x=>x.id===d.taskId);
  const u=USERS[d.uploadedBy];
  const op=docOpen[d.fbKey||d.id];
  return `
  <div class="doc-card">
    <div style="display:flex;align-items:flex-start;gap:12px;">
      <span style="font-size:28px;margin-top:2px;flex-shrink:0;">${fi(d.type)}</span>
      <div style="flex:1;min-width:0;">
        <div style="display:flex;align-items:center;gap:7px;flex-wrap:wrap;margin-bottom:6px;">
          <span style="font-size:13px;font-weight:600;color:var(--text2);word-break:break-all;">${d.name}</span>
          ${d.approved?bdg('‚úì Approved','#22c55e',true):''}
          ${d.locked?bdg('üîí Locked','#ef4444',true):''}
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin-bottom:10px;">
          <span style="font-size:10px;background:${vc.c}18;color:${vc.c};border:1px solid ${vc.c}35;padding:2px 8px;border-radius:4px;font-family:var(--fm);font-weight:600;">${vc.i} ${vc.l}</span>
          <span style="font-size:10px;color:var(--text4);font-family:var(--fm);">v${d.version||1} ¬∑ ${d.size||'‚Äî'}</span>
          <span style="font-size:10px;color:var(--text5);font-family:var(--fm);">by ${u?.name?.split(' ')[0]||d.uploadedBy}</span>
          ${t?`<span style="font-size:10px;color:var(--text4);font-family:var(--fm);">üìå ${t.title}</span>`:''}
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;">
          <button class="btn-icon" onclick="toggleDC('${d.fbKey||d.id}')" style="font-size:12px;">üí¨ ${Object.keys(d.comments||{}).length}</button>
          ${d.hasFile?`<button class="btn-icon" onclick="downloadDoc('${d.fbKey||d.id}')" style="font-size:12px;color:var(--green);">‚¨á Download</button>`:''}
          ${isCEO()?`
          <button class="btn-icon" onclick="togApprove('${d.fbKey||d.id}')" style="color:${d.approved?'var(--green)':'var(--text3)'};" title="${d.approved?'Revoke approval':'Approve'}">‚úì</button>
          <button class="btn-icon" onclick="togLock('${d.fbKey||d.id}')" style="color:${d.locked?'var(--red)':'var(--text3)'};" title="${d.locked?'Unlock':'Lock'}">üîí</button>
          <select onchange="chVis('${d.fbKey||d.id}',this.value)" style="background:var(--bg4);border:1px solid var(--border2);border-radius:6px;color:var(--text3);font-size:11px;padding:7px 8px;font-family:var(--fm);min-height:36px;">
            <option value="ceo-only"${d.visibility==='ceo-only'?' selected':''}>üëë CEO</option>
            <option value="team-only"${d.visibility==='team-only'?' selected':''}>üë• Team</option>
            <option value="shared"${d.visibility==='shared'?' selected':''}>üåê Shared</option>
          </select>
          <button class="btn-danger" onclick="delDoc('${d.fbKey||d.id}')">üóë</button>`:''}
        </div>
      </div>
    </div>
    ${op?`
    <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);">
      ${Object.values(d.comments||{}).sort((a,b)=>a.ts-b.ts).map(c=>`
      <div class="note-item" style="margin-bottom:7px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:3px;flex-wrap:wrap;gap:6px;">
          <span style="font-size:11px;font-weight:600;color:var(--text2);">${c.name}</span>
          <span style="font-size:10px;color:var(--text5);font-family:var(--fm);">${new Date(c.ts).toLocaleString('en-IN',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'})}</span>
        </div>
        <div style="font-size:12px;color:var(--text3);">${escHtml(c.text)}</div>
      </div>`).join('')}
      <div style="display:flex;gap:8px;">
        <input class="inp-sm" id="dc-${d.fbKey||d.id}" placeholder="Add a comment‚Ä¶" style="flex:1;" onkeydown="if(event.key==='Enter')addDC('${d.fbKey||d.id}')">
        <button class="btn-p" style="padding:10px 14px;font-size:12px;" onclick="addDC('${d.fbKey||d.id}')">Send</button>
      </div>
    </div>`:''}
  </div>`;
}

function tabComments(p) {
  const cm=Object.values(projComments[p.id]||{}).sort((a,b)=>a.ts-b.ts);
  return `
  <div style="margin-bottom:14px;">
    ${cm.map(c=>`
    <div class="cmt-item">
      ${av(USERS[c.by]?.avatar||'??',34,USERS[c.by]?.color||'#1d4ed8')}
      <div style="flex:1;min-width:0;">
        <div style="display:flex;justify-content:space-between;margin-bottom:5px;flex-wrap:wrap;gap:6px;">
          <span style="font-size:12px;font-weight:600;color:var(--text2);">${c.name}</span>
          <span style="font-size:10px;color:var(--text5);font-family:var(--fm);">${new Date(c.ts).toLocaleString('en-IN',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'})}</span>
        </div>
        <div style="font-size:13px;color:var(--text3);line-height:1.65;">${escHtml(c.text)}</div>
      </div>
    </div>`).join('')}
    ${cm.length===0?'<div class="empty" style="margin-bottom:12px;padding:28px;"><span class="empty-icon">üí¨</span>No comments yet.</div>':''}
  </div>
  <div style="display:flex;gap:10px;">
    ${av(CU.avatar,36,CU.color)}
    <input class="inp-sm" id="pc-inp" placeholder="Write a comment‚Ä¶" style="flex:1;" onkeydown="if(event.key==='Enter')addPC('${p.id}')">
    <button class="btn-p" onclick="addPC('${p.id}')">Post</button>
  </div>`;
}

function tabPayments(p) {
  const paid=(p.payments||[]).filter(x=>x.status==='Paid').reduce((s,x)=>s+Number(x.amount||0),0);
  const pend=(p.payments||[]).filter(x=>x.status==='Pending').reduce((s,x)=>s+Number(x.amount||0),0);
  const profit=(p.revenue||0)-(p.cost||0);
  return `
  <div class="g3" style="margin-bottom:16px;">
    <div class="stat-card"><div class="stat-icon">üí∞</div><div class="stat-val" style="color:var(--accent2);">‚Çπ${(p.budget||0).toLocaleString('en-IN')}</div><div class="stat-lbl">Budget</div></div>
    <div class="stat-card"><div class="stat-icon">‚úÖ</div><div class="stat-val" style="color:var(--green);">‚Çπ${paid.toLocaleString('en-IN')}</div><div class="stat-lbl">Received</div></div>
    <div class="stat-card"><div class="stat-icon">‚è≥</div><div class="stat-val" style="color:var(--amber);">‚Çπ${pend.toLocaleString('en-IN')}</div><div class="stat-lbl">Pending</div></div>
  </div>
  <div class="g2" style="margin-bottom:20px;">
    <div class="stat-card"><div class="stat-icon">üìà</div><div class="stat-val" style="color:var(--purple);">‚Çπ${(p.revenue||0).toLocaleString('en-IN')}</div><div class="stat-lbl">Revenue</div></div>
    <div class="stat-card"><div class="stat-icon">üíπ</div><div class="stat-val" style="color:${profit>=0?'var(--green)':'var(--red)'};">‚Çπ${profit.toLocaleString('en-IN')}</div><div class="stat-lbl">Net Profit</div></div>
  </div>
  <div class="flex-between" style="margin-bottom:12px;">
    <div class="sec-head" style="margin:0;">Payment Stages</div>
    <button class="btn-p" onclick="mAddPayment('${p.id}','${p.fbKey}')">+ Add Stage</button>
  </div>
  ${(p.payments||[]).map((pay,i)=>`
  <div class="pay-row">
    <div>
      <div style="font-size:13px;font-weight:600;color:var(--text2);">${pay.stage}</div>
      ${pay.date?`<div style="font-size:11px;color:var(--text4);font-family:var(--fm);margin-top:2px;">${fmtD(pay.date)}</div>`:''}
    </div>
    <div style="display:flex;align-items:center;gap:10px;">
      <span style="font-family:var(--fd);font-weight:700;font-size:14px;color:var(--purple);">‚Çπ${Number(pay.amount||0).toLocaleString('en-IN')}</span>
      <button onclick="togPay('${p.fbKey}',${i})" style="padding:8px 13px;border-radius:6px;font-size:11px;font-family:var(--fm);background:${pay.status==='Paid'?'rgba(20,53,28,.5)':'var(--bg4)'};border:1px solid ${pay.status==='Paid'?'rgba(34,197,94,.3)':'var(--border2)'};color:${pay.status==='Paid'?'var(--green)':'var(--text3)'};min-height:38px;">${pay.status==='Paid'?'‚úì Paid':'Pending'}</button>
    </div>
  </div>`).join('')}`;
}

// ‚îÄ‚îÄ‚îÄ TASKS PAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTasksPage() {
  const mt=myTasks();
  const filt=fTask==='All'?mt:mt.filter(t=>t.status===fTask);
  return `
  <div class="filter-bar">
    ${['All','Not Started','In Progress','Review','Completed'].map(s=>`<button class="fbtn${fTask===s?' on':''}" onclick="fTask='${s}';renderContent()">${s}</button>`).join('')}
  </div>
  ${filt.map(t=>{
    const proj=projects.find(p=>p.id===t.projectId);
    const od=t.deadline&&new Date(t.deadline)<new Date()&&t.status!=='Completed';
    const canEdit=isCEO()||t.assignedTo===CU.username;
    return `
    <div style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--r12);padding:14px 16px;margin-bottom:9px;">
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:7px;">
        <span style="font-size:10px;color:var(--accent2);font-family:var(--fm);font-weight:600;">${t.id}</span>
        ${bdg(t.status,SC[t.status]||'#64748b',true)}
        ${proj?bdg(proj.id,'#475569',true):''}
        ${od?bdg('Overdue','#ef4444',true):''}
        <span style="margin-left:auto;font-size:11px;color:var(--text4);font-family:var(--fm);">Due ${fmtD(t.deadline)}</span>
      </div>
      <div style="font-size:14px;font-weight:600;color:var(--text2);margin-bottom:9px;">${t.title}</div>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:${canEdit?'10px':'0'};">${pb(t.progress||0,SC[t.status]||'#3b82f6')}<span style="font-size:10px;color:var(--accent2);font-family:var(--fm);flex-shrink:0;width:34px;">${t.progress||0}%</span></div>
      ${canEdit?`<input type="range" min="0" max="100" value="${t.progress||0}" oninput="updTP('${t.fbKey||t.id}',this.value);this.previousElementSibling.querySelector('span').textContent=this.value+'%'" style="width:100%;accent-color:var(--accent);height:24px;">`:''}
    </div>`;
  }).join('')}
  ${filt.length===0?'<div class="empty"><span class="empty-icon">‚úì</span>No tasks found</div>':''}`;
}

// ‚îÄ‚îÄ‚îÄ DOCUMENTS PAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDocsPage() {
  const myD=docs.filter(canSee);
  const filt=fVis==='all'?myD:myD.filter(d=>d.visibility===fVis);
  return `
  <div class="flex-between" style="margin-bottom:16px;">
    <div class="filter-bar" style="margin:0;flex:1;">
      ${[['all','All'],['ceo-only','üëë CEO'],['team-only','üë• Team'],['shared','üåê Shared']].filter(([v])=>isCEO()||v!=='ceo-only').map(([v,l])=>`
      <button class="fbtn${fVis===v?' on':''}" onclick="fVis='${v}';renderContent()">${l}</button>`).join('')}
    </div>
    <button class="btn-p" onclick="mUploadDoc(null)">+ Upload</button>
  </div>
  ${filt.map(d=>docCard(d)).join('')}
  ${filt.length===0?'<div class="empty"><span class="empty-icon">üìÅ</span>No documents found</div>':''}`;
}

// ‚îÄ‚îÄ‚îÄ FINANCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderFinance() {
  const totR=projects.reduce((s,p)=>s+(p.revenue||0),0);
  const totC=projects.reduce((s,p)=>s+(p.cost||0),0);
  const totP=totR-totC;
  const totRcv=projects.reduce((s,p)=>s+(p.payments||[]).filter(x=>x.status==='Paid').reduce((ss,x)=>ss+Number(x.amount||0),0),0);
  return `
  <div class="g4" style="margin-bottom:22px;">
    <div class="stat-card"><div class="stat-icon">üìà</div><div class="stat-val" style="color:var(--accent2);">‚Çπ${totR.toLocaleString('en-IN')}</div><div class="stat-lbl">Total Revenue</div></div>
    <div class="stat-card"><div class="stat-icon">üìâ</div><div class="stat-val" style="color:var(--red);">‚Çπ${totC.toLocaleString('en-IN')}</div><div class="stat-lbl">Total Cost</div></div>
    <div class="stat-card"><div class="stat-icon">üíπ</div><div class="stat-val" style="color:var(--green);">‚Çπ${totP.toLocaleString('en-IN')}</div><div class="stat-lbl">Net Profit</div></div>
    <div class="stat-card"><div class="stat-icon">‚úÖ</div><div class="stat-val" style="color:var(--amber);">‚Çπ${totRcv.toLocaleString('en-IN')}</div><div class="stat-lbl">Received</div></div>
  </div>
  <div class="tbl-wrap">
    <table>
      <thead><tr><th>Project</th><th>Status</th><th>Budget</th><th>Revenue</th><th>Cost</th><th>Profit</th><th>Received</th></tr></thead>
      <tbody>
      ${projects.map(p=>{
        const rcv=(p.payments||[]).filter(x=>x.status==='Paid').reduce((s,x)=>s+Number(x.amount||0),0);
        const prf=(p.revenue||0)-(p.cost||0);
        return `<tr>
          <td><div style="font-weight:600;color:var(--text2);">${p.title}</div><div style="font-size:10px;color:var(--text5);font-family:var(--fm);margin-top:2px;">${p.id}</div></td>
          <td>${bdg(p.status,SC[p.status]||'#64748b',true)}</td>
          <td style="font-family:var(--fm);color:var(--text2);">‚Çπ${(p.budget||0).toLocaleString('en-IN')}</td>
          <td style="font-family:var(--fm);color:var(--accent2);">‚Çπ${(p.revenue||0).toLocaleString('en-IN')}</td>
          <td style="font-family:var(--fm);color:var(--red);">‚Çπ${(p.cost||0).toLocaleString('en-IN')}</td>
          <td style="font-family:var(--fm);color:${prf>=0?'var(--green)':'var(--red)'};">‚Çπ${prf.toLocaleString('en-IN')}</td>
          <td style="font-family:var(--fm);color:var(--amber);">‚Çπ${rcv.toLocaleString('en-IN')}</td>
        </tr>`;}).join('')}
      </tbody>
    </table>
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ USERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderUsers() {
  return `
  <div class="flex-end" style="margin-bottom:16px;">
    <button class="btn-p" onclick="mCreateUser()">+ Create Account</button>
  </div>
  ${Object.entries(USERS).map(([un,u])=>`
  <div style="display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--r12);margin-bottom:9px;opacity:${u.enabled===false?.5:1};transition:all .2s;">
    ${av(u.avatar,40,u.color)}
    <div style="flex:1;min-width:0;">
      <div style="display:flex;align-items:center;gap:7px;flex-wrap:wrap;margin-bottom:5px;">
        <span style="font-size:13px;font-weight:600;color:var(--text2);">${u.name}</span>
        ${u.role==='CEO'?bdg('üëë CEO','#a855f7',true):''}
        ${bdg(u.domain.split(' ')[0],'#475569',true)}
        ${u.enabled===false?bdg('Disabled','#ef4444',true):''}
      </div>
      <div style="font-size:11px;color:var(--text4);font-family:var(--fm);">@${un}</div>
      <div style="font-size:11px;color:var(--text4);font-family:var(--fm);">${u.domain}</div>
      <div style="font-size:11px;color:var(--text5);font-family:var(--fm);margin-top:2px;">Password: <span style="color:var(--text4);">${u.password}</span></div>
    </div>
    ${u.role!=='CEO'?`
    <div style="display:flex;flex-direction:column;gap:7px;flex-shrink:0;">
      <button class="btn-sm" onclick="mEditUser('${un}')">‚úè Edit</button>
      <button class="btn-sm" onclick="togUser('${un}')" style="color:${u.enabled===false?'var(--green)':'var(--red)'};border-color:${u.enabled===false?'rgba(34,197,94,.4)':'rgba(239,68,68,.4)'};">${u.enabled===false?'Enable':'Disable'}</button>
    </div>`:''}
  </div>`).join('')}`;
}

// ‚îÄ‚îÄ‚îÄ DELIVERY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDelivery() {
  const dp=projects.filter(p=>p.status==='Review'||p.status==='Delivered');
  return `
  <div style="font-size:11px;color:var(--text4);font-family:var(--fm);text-transform:uppercase;letter-spacing:.07em;margin-bottom:16px;">Projects ready for delivery or archival</div>
  ${dp.map(p=>{
    const pd=docs.filter(d=>d.projectId===p.id&&d.visibility==='shared');
    return `
    <div class="card" style="padding:18px 20px;margin-bottom:12px;">
      <div class="flex-between">
        <div>
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:6px;">
            <span style="font-size:11px;color:var(--accent2);font-family:var(--fm);font-weight:600;">${p.id}</span>
            ${bdg(p.status,SC[p.status]||'#64748b')}
          </div>
          <div style="font-family:var(--fd);font-weight:700;font-size:14px;margin-bottom:5px;">${p.title}</div>
          <div style="font-size:12px;color:var(--text4);font-family:var(--fm);">üìÇ ${pd.length} shared docs ¬∑ Deadline: ${fmtD(p.deadline)}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:7px;">
          ${p.status==='Review'?`<button class="btn-p" onclick="markDel('${p.fbKey}')">Mark Delivered ‚úì</button>`:''}
          ${p.status==='Delivered'?`<button class="btn-s" onclick="archProj('${p.fbKey}')">Archive ‚Üí</button>`:''}
        </div>
      </div>
    </div>`;}).join('')}
  ${dp.length===0?'<div class="empty"><span class="empty-icon">üì¶</span>No projects in Review or Delivered</div>':''}`;
}

// ‚îÄ‚îÄ‚îÄ ARCHITECTURE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderArchitecture() {
  return `
  ${isCEO()?`<div class="flex-end" style="margin-bottom:16px;"><button class="btn-p" onclick="mNewNote()">+ Add Note</button></div>`:''}
  ${archNotes.length===0?'<div class="empty"><span class="empty-icon">‚¨¢</span>No architecture notes yet.</div>':''}
  ${archNotes.map(n=>`
  <div class="card" style="padding:18px 20px;margin-bottom:14px;">
    <div class="flex-between" style="margin-bottom:12px;">
      <div>
        <div style="font-family:var(--fd);font-weight:700;font-size:14px;margin-bottom:5px;">${n.title}</div>
        <div style="font-size:11px;color:var(--text5);font-family:var(--fm);">Edited by ${USERS[n.editedBy]?.name?.split(' ')[0]||n.editedBy} ¬∑ ${fmtD(n.ts)}${n.locked?` ¬∑ üîí`:''}</div>
      </div>
      ${isCEO()?`<div style="display:flex;gap:6px;"><button class="btn-sm" onclick="mEditNote('${n.fbKey}')">Edit</button><button class="btn-danger" onclick="delNote('${n.fbKey}')">üóë</button></div>`:''}
    </div>
    <pre style="font-size:13px;color:var(--text3);line-height:1.8;white-space:pre-wrap;font-family:var(--fm);">${escHtml(n.content)}</pre>
  </div>`).join('')}`;
}

// ‚îÄ‚îÄ‚îÄ GROUP CHAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderGroupChat() {
  return `
  <div id="chat-wrap">
    <div style="padding:13px 16px;border-bottom:1px solid var(--border);background:var(--bg2);display:flex;align-items:center;gap:10px;flex-shrink:0;">
      <span style="font-family:var(--fd);font-weight:800;font-size:16px;">üí¨ Team Chat</span>
      <span class="online-badge"><span class="live-dot" style="width:6px;height:6px;"></span>Live</span>
      <span style="margin-left:auto;font-size:11px;color:var(--text4);font-family:var(--fm);">
        <span id="online-count">‚Äî</span> online
      </span>
    </div>
    <div id="chat-messages" style="flex:1;overflow-y:auto;padding:18px;display:flex;flex-direction:column;gap:10px;"></div>
    <div id="chat-input-bar">
      ${av(CU.avatar,36,CU.color)}
      <textarea class="chat-typing-area" id="chat-inp" placeholder="Message the team‚Ä¶" rows="1"
        oninput="autoResizeChat(this)"
        onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat();}"></textarea>
      <button class="chat-send-btn" onclick="sendChat()" title="Send (Enter)">‚û§</button>
    </div>
  </div>`;
}

function buildChatMessages() {
  let html='';
  const typingOthers=Object.keys(typingUsers).filter(u=>u!==CU.username&&typingUsers[u]>Date.now()-3000);
  if(typingOthers.length>0) {
    const names=typingOthers.map(u=>USERS[u]?.name?.split(' ')[0]||u).join(', ');
    html+=`<div style="align-self:flex-start;"><div class="chat-typing-indicator">${names} typing<div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div></div>`;
  }
  if(!groupChat.length&&!typingOthers.length) {
    return `<div style="flex:1;display:flex;align-items:center;justify-content:center;"><div style="text-align:center;color:var(--text5);"><div style="font-size:48px;margin-bottom:14px;">üí¨</div><div style="font-size:15px;font-weight:600;color:var(--text2);margin-bottom:6px;">Team Group Chat</div><div style="font-size:12px;font-family:var(--fm);">Live ‚Ä¢ Start the conversation!</div></div></div>`;
  }
  let lastDate='';
  groupChat.forEach(msg=>{
    const msgDate=new Date(msg.ts).toLocaleDateString('en-IN',{weekday:'long',day:'2-digit',month:'long'});
    if(msgDate!==lastDate){html+=`<div class="chat-date-div">${msgDate}</div>`;lastDate=msgDate;}
    const mine=msg.by===CU.username;
    const u=USERS[msg.by];
    const timeStr=fmtMsgTime(msg.ts);
    html+=`
    <div class="chat-msg ${mine?'mine':'theirs'}">
      ${!mine?`${av(u?.avatar||'?',32,u?.color||'#1d4ed8')}`:''}
      <div style="max-width:76%;min-width:0;">
        ${!mine?`<div class="chat-name-badge">${u?.name?.split(' ')[0]||msg.by} ¬∑ ${u?.domain||''}</div>`:''}
        <div class="chat-bubble">${escHtml(msg.text)}</div>
        <div class="chat-meta">${timeStr}</div>
      </div>
    </div>`;
  });
  return html;
}

function fmtMsgTime(ts) {
  const diff=Date.now()-ts;
  const m=Math.floor(diff/60000),h=Math.floor(diff/3600000),d=Math.floor(diff/86400000);
  if(m<1)return'Just now';if(m<60)return`${m}m ago`;if(h<24)return`${h}h ago`;
  if(d<7)return`${d}d ago`;
  return new Date(ts).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
}

function afterChatRender() {
  // Load all chat messages first time
  db.ref('groupChat').orderByChild('ts').limitToLast(100).once('value', snap => {
    groupChat=[];
    snap.forEach(c=>{const v=c.val();if(v)groupChat.push({...v,fbKey:c.key});});
    groupChat.sort((a,b)=>(a.ts||0)-(b.ts||0));
    const area=$('chat-messages');
    if(area){area.innerHTML=buildChatMessages();area.scrollTop=area.scrollHeight;}
  });
  setTimeout(()=>{
    const area=$('chat-messages');
    if(area){area.scrollTop=area.scrollHeight;}
    const inp=$('chat-inp');
    if(inp)inp.focus();
  },200);
}

function autoResizeChat(el) {
  el.style.height='auto';
  el.style.height=Math.min(el.scrollHeight,120)+'px';
  if(db&&CU) {
    db.ref(`presence/${CU.username}`).update({typing:true,lastSeen:Date.now()});
    clearTimeout(typingTimeout);
    typingTimeout=setTimeout(()=>{db.ref(`presence/${CU.username}`).update({typing:false,lastSeen:Date.now()});},2000);
  }
}

function sendChat() {
  const inp=$('chat-inp');
  if(!inp) return;
  const text=inp.value.trim();
  if(!text) return;
  db.ref('groupChat').push({by:CU.username,name:CU.name,domain:CU.domain,text,ts:Date.now()});
  inp.value='';inp.style.height='auto';
  db.ref(`presence/${CU.username}`).update({typing:false,lastSeen:Date.now()});
  setTimeout(()=>{const a=$('chat-messages');if(a)a.scrollTop=a.scrollHeight;},100);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE ACTIONS ‚Äî write to database directly
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleTE(key){taskExp[key]=!taskExp[key];renderContent();}
function toggleDC(key){docOpen[key]=!docOpen[key];renderContent();}

function updTP(key,val) {
  db.ref(`tasks/${key}`).update({progress:Number(val)});
}
function updTS(key,s) {
  db.ref(`tasks/${key}`).update({status:s});
  notify('Status: '+s);
}

function addNote(key) {
  const inp=document.getElementById('ni-'+key);
  if(!inp||!inp.value.trim()) return;
  db.ref(`tasks/${key}/notes`).push({text:inp.value.trim(),by:CU.username,name:CU.name,ts:Date.now()});
  inp.value='';
  notify('Note added');
}

function addDC(key) {
  const inp=document.getElementById('dc-'+key);
  if(!inp||!inp.value.trim()) return;
  db.ref(`docs/${key}/comments`).push({text:inp.value.trim(),by:CU.username,name:CU.name,ts:Date.now()});
  inp.value='';
}

function addPC(pid) {
  const inp=document.getElementById('pc-inp');
  if(!inp||!inp.value.trim()) return;
  db.ref(`projComments/${pid}`).push({text:inp.value.trim(),by:CU.username,name:CU.name,ts:Date.now()});
  inp.value='';
}

function togApprove(key) {
  const d=docs.find(x=>x.fbKey===key);
  if(d){db.ref(`docs/${key}`).update({approved:!d.approved});notify(d.approved?'Approval revoked':'Document approved');}
}
function togLock(key) {
  const d=docs.find(x=>x.fbKey===key);
  if(d){db.ref(`docs/${key}`).update({locked:!d.locked});notify(d.locked?'Unlocked':'Locked');}
}
function chVis(key,vis){db.ref(`docs/${key}`).update({visibility:vis});notify('Visibility changed');}
function delDoc(key){if(confirm('Delete this document permanently?')){delFile(key);db.ref(`docs/${key}`).remove();notify('Document deleted');}}
function delTask(key){if(confirm('Delete this task?')){db.ref(`tasks/${key}`).remove();notify('Task deleted');}}
function delNote(key){if(confirm('Delete this note?')){db.ref(`archNotes/${key}`).remove();notify('Note deleted');}}

function togPay(projKey,idx) {
  const p=projects.find(x=>x.fbKey===projKey);
  if(!p||!p.payments) return;
  const payments=[...p.payments];
  const pay=payments[idx];
  pay.status=pay.status==='Paid'?'Pending':'Paid';
  pay.date=pay.status==='Paid'?new Date().toISOString().slice(0,10):'';
  db.ref(`projects/${projKey}`).update({payments});
  notify('Payment updated');
}
function markDel(key){db.ref(`projects/${key}`).update({status:'Delivered'});notify('Marked as Delivered');}
function archProj(key){db.ref(`projects/${key}`).update({status:'Archived'});notify('Project archived');}
function togUser(un){
  const enabled=USERS[un].enabled===false;
  db.ref(`users/${un}`).update({enabled});
  notify((enabled?'Enabled':'Disabled')+': '+un);
}

// File download (from local IndexedDB)
async function downloadDoc(key) {
  const fileData=await getFile(key);
  if(!fileData||!fileData.dataURL){notify('File not found in local storage','err');return;}
  const a=document.createElement('a');
  a.href=fileData.dataURL;a.download=fileData.name||'download';
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  notify('Downloading: '+fileData.name);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showModal(title,body,wide) {
  $('modal-root').innerHTML=`
  <div class="overlay" onclick="if(event.target===this)closeM()">
    <div class="mbox${wide?' mbox-wide':''}">
      <div class="drag-handle"></div>
      <div class="mhead">
        <div class="mtitle">${title}</div>
        <button class="mclose" onclick="closeM()">√ó</button>
      </div>
      ${body}
    </div>
  </div>`;
}
function closeM(){$('modal-root').innerHTML='';}

// ‚îÄ‚îÄ‚îÄ CREATE PROJECT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mCreateProj() {
  const team=Object.entries(USERS).filter(([,u])=>u.role==='team'&&u.enabled!==false);
  selMembers=[];
  showModal('Create New Project',`
  <form onsubmit="submitProj(event)">
    <div class="field"><label class="field-lbl">Project Title *</label><input class="inp-sm" id="pf-t" required placeholder="e.g. Smart Irrigation System"></div>
    <div class="g2" style="gap:12px;">
      <div class="field"><label class="field-lbl">Type *</label><input class="inp-sm" id="pf-ty" required placeholder="IoT & Embedded"></div>
      <div class="field"><label class="field-lbl">Branch *</label><input class="inp-sm" id="pf-br" required placeholder="Electronics"></div>
      <div class="field"><label class="field-lbl">Year</label><input class="inp-sm" id="pf-yr" value="${new Date().getFullYear()}"></div>
      <div class="field"><label class="field-lbl">Deadline *</label><input class="inp-sm" id="pf-dl" type="date" required></div>
      <div class="field"><label class="field-lbl">Budget (‚Çπ) *</label><input class="inp-sm" id="pf-bg" type="number" placeholder="85000" required></div>
      <div class="field"><label class="field-lbl">Cost (‚Çπ)</label><input class="inp-sm" id="pf-ct" type="number" placeholder="0" value="0"></div>
    </div>
    <div class="field"><label class="field-lbl">Description</label><textarea class="inp-sm" id="pf-ds" rows="2"></textarea></div>
    <div class="field"><label class="field-lbl">Requirements</label><textarea class="inp-sm" id="pf-rq" rows="2"></textarea></div>
    <div class="field">
      <label class="field-lbl">Assign Team Members</label>
      <div id="mchips" style="display:flex;flex-wrap:wrap;margin-top:6px;">
        ${team.map(([un,u])=>`<span class="mchip" id="ch-${un}" onclick="togChip('${un}')">${av(u.avatar,20,u.color)} ${u.name.split(' ')[0]}</span>`).join('')}
      </div>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:6px;">
      <button type="button" class="btn-s" onclick="closeM()">Cancel</button>
      <button type="submit" class="btn-p">Create Project</button>
    </div>
  </form>`,true);
}
function togChip(un){
  const ch=document.getElementById('ch-'+un);
  if(selMembers.includes(un)){selMembers=selMembers.filter(x=>x!==un);ch.classList.remove('sel');}
  else{selMembers.push(un);ch.classList.add('sel');}
}
function submitProj(e) {
  e.preventDefault();
  const id=gid('PRJ');
  const budget=Number($('pf-bg').value);
  const cost=Number($('pf-ct').value)||0;
  const proj={id,title:$('pf-t').value,type:$('pf-ty').value,branch:$('pf-br').value,year:$('pf-yr').value,deadline:$('pf-dl').value,budget,cost,revenue:budget,status:'Created',assignedMembers:[...selMembers],description:$('pf-ds').value,requirements:$('pf-rq').value,createdAt:new Date().toISOString().slice(0,10),payments:[],createdBy:CU.username};
  db.ref('projects').push(proj);
  selMembers=[];closeM();notify('Project created: '+id);
}

// ‚îÄ‚îÄ‚îÄ EDIT PROJECT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mEditProj(pid) {
  const p=selProj;
  const team=Object.entries(USERS).filter(([,u])=>u.role==='team'&&u.enabled!==false);
  selMembers=[...(p.assignedMembers||[])];
  showModal('Edit Project',`
  <div class="field"><label class="field-lbl">Title *</label><input class="inp-sm" id="ep-t" value="${p.title}" required></div>
  <div class="g2" style="gap:12px;">
    <div class="field"><label class="field-lbl">Type</label><input class="inp-sm" id="ep-ty" value="${p.type||''}"></div>
    <div class="field"><label class="field-lbl">Branch</label><input class="inp-sm" id="ep-br" value="${p.branch||''}"></div>
    <div class="field"><label class="field-lbl">Deadline</label><input class="inp-sm" id="ep-dl" type="date" value="${p.deadline||''}"></div>
    <div class="field"><label class="field-lbl">Budget (‚Çπ)</label><input class="inp-sm" id="ep-bg" type="number" value="${p.budget||0}"></div>
    <div class="field"><label class="field-lbl">Revenue (‚Çπ)</label><input class="inp-sm" id="ep-rv" type="number" value="${p.revenue||0}"></div>
    <div class="field"><label class="field-lbl">Cost (‚Çπ)</label><input class="inp-sm" id="ep-ct" type="number" value="${p.cost||0}"></div>
  </div>
  <div class="field"><label class="field-lbl">Description</label><textarea class="inp-sm" id="ep-ds" rows="2">${p.description||''}</textarea></div>
  <div class="field"><label class="field-lbl">Requirements</label><textarea class="inp-sm" id="ep-rq" rows="2">${p.requirements||''}</textarea></div>
  <div class="field">
    <label class="field-lbl">Team Members</label>
    <div style="display:flex;flex-wrap:wrap;margin-top:6px;">
      ${team.map(([un,u])=>`<span class="mchip${selMembers.includes(un)?' sel':''}" id="ch-${un}" onclick="togChip('${un}')">${av(u.avatar,20,u.color)} ${u.name.split(' ')[0]}</span>`).join('')}
    </div>
  </div>
  <div style="display:flex;gap:10px;justify-content:flex-end;">
    <button class="btn-danger" onclick="delProj('${p.fbKey}')">üóë Delete</button>
    <button class="btn-s" onclick="closeM()">Cancel</button>
    <button class="btn-p" onclick="submitEditProj('${p.fbKey}')">Save Changes</button>
  </div>`,true);
}

function submitEditProj(key) {
  db.ref(`projects/${key}`).update({
    title:$('ep-t').value,type:$('ep-ty').value,branch:$('ep-br').value,
    deadline:$('ep-dl').value,budget:Number($('ep-bg').value),
    revenue:Number($('ep-rv').value),cost:Number($('ep-ct').value),
    description:$('ep-ds').value,requirements:$('ep-rq').value,
    assignedMembers:[...selMembers]
  });
  selMembers=[];closeM();notify('Project updated');
}

function delProj(key) {
  if(confirm('Delete this project and all its tasks? This cannot be undone.')) {
    // Delete all tasks for this project
    tasks.filter(t=>t.projectId===selProj?.id).forEach(t=>{if(t.fbKey)db.ref(`tasks/${t.fbKey}`).remove();});
    db.ref(`projects/${key}`).remove();
    db.ref(`projComments/${selProj?.id}`).remove();
    closeM();navigate('projects');notify('Project deleted');
  }
}

// ‚îÄ‚îÄ‚îÄ STATUS CHANGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mStatusChange() {
  const p=selProj;
  showModal('Change Status',`
  <div style="display:flex;flex-direction:column;gap:7px;">
    ${['Created','Approved','In Development','Review','Delivered','Archived'].map(s=>`
    <button onclick="doSC('${s}')" style="display:flex;align-items:center;gap:10px;padding:13px 14px;background:${p.status===s?'rgba(59,130,246,.12)':'var(--bg4)'};border:1px solid ${p.status===s?'var(--accent)':'var(--border)'};border-radius:9px;color:${p.status===s?'var(--accent2)':'var(--text2)'};font-size:14px;text-align:left;min-height:50px;">
      <span style="width:10px;height:10px;border-radius:50%;background:${SC[s]};display:inline-block;flex-shrink:0;"></span>
      ${s}${p.status===s?'<span style="margin-left:auto;font-size:10px;font-family:var(--fm);color:var(--accent2);">Current</span>':''}
    </button>`).join('')}
  </div>`);
}
function doSC(s) {
  if(selProj){db.ref(`projects/${selProj.fbKey}`).update({status:s});selProj.status=s;}
  closeM();notify('Status: '+s);
}

// ‚îÄ‚îÄ‚îÄ CREATE TASK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mCreateTask(pid) {
  const p=projects.find(x=>x.id===pid);
  const el=Object.entries(USERS).filter(([un])=>p?.assignedMembers?.includes(un));
  showModal('Add Task',`
  <form onsubmit="submitTask(event,'${pid}')">
    <div class="field"><label class="field-lbl">Task Title *</label><input class="inp-sm" id="tf-t" required placeholder="e.g. PCB Design"></div>
    <div class="field"><label class="field-lbl">Assign To *</label>
      <select class="inp-sm" id="tf-a" required>
        <option value="">Select member</option>
        ${el.map(([un,u])=>`<option value="${un}">${u.name} (${u.domain})</option>`).join('')}
        ${isCEO()?`<option value="${CU.username}">${CU.name} (CEO)</option>`:''}
      </select>
    </div>
    <div class="field"><label class="field-lbl">Deadline *</label><input class="inp-sm" id="tf-d" type="date" required></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button type="button" class="btn-s" onclick="closeM()">Cancel</button>
      <button type="submit" class="btn-p">Create Task</button>
    </div>
  </form>`);
}
function submitTask(e,pid) {
  e.preventDefault();
  const a=$('tf-a').value;
  const u=USERS[a];
  const id=gid('TSK');
  db.ref('tasks').push({id,projectId:pid,title:$('tf-t').value,assignedTo:a,domain:u?.domain||'',deadline:$('tf-d').value,status:'Not Started',progress:0,notes:{},createdAt:new Date().toISOString().slice(0,10),createdBy:CU.username});
  closeM();notify('Task created: '+id);
}

// ‚îÄ‚îÄ‚îÄ UPLOAD DOCUMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mUploadDoc(pid) {
  uploadedFile=null;
  const mpList=isCEO()?projects:projects.filter(p=>(p.assignedMembers||[]).includes(CU.username));
  const pt=pid?tasks.filter(t=>t.projectId===pid):[];
  const defVis=isCEO()?'ceo-only':'team-only';
  showModal('Upload Document',`
  <form onsubmit="submitDoc(event)">
    ${!pid?`<div class="field"><label class="field-lbl">Project *</label>
      <select class="inp-sm" id="df-p" required onchange="updDocTasks(this.value)">
        <option value="">Select project</option>
        ${mpList.map(p=>`<option value="${p.id}">${p.id} ‚Äî ${p.title}</option>`).join('')}
      </select></div>`:
      `<input type="hidden" id="df-p" value="${pid}">`}
    <div class="field">
      <label class="field-lbl">Upload File</label>
      <div class="upload-zone" id="upload-zone">
        <span class="upload-zone-icon">üìÅ</span>
        <div class="upload-zone-title">Tap to browse or drag & drop</div>
        <div class="upload-zone-sub">PDF, Word, Excel, Images, ZIP, DWG and more</div>
      </div>
      <div class="upload-preview" id="upload-preview" style="display:none;">
        <span class="up-icon">üìÑ</span>
        <div><div class="up-name">‚Äî</div><div class="up-size">‚Äî</div></div>
        <button type="button" class="up-rm" onclick="clearUploadFile()">√ó</button>
      </div>
      <input type="file" id="file-input-real" class="file-input-hidden" accept="*/*">
    </div>
    <div class="field"><label class="field-lbl">Document Name *</label><input class="inp-sm" id="df-n" required placeholder="Report_v1.pdf"></div>
    <div class="g2" style="gap:12px;">
      <div class="field"><label class="field-lbl">File Type</label>
        <select class="inp-sm" id="df-t">${['pdf','docx','xlsx','png','jpg','dwg','zip','mp4','txt','pptx'].map(t=>`<option value="${t}">${t.toUpperCase()}</option>`).join('')}</select>
      </div>
      <div class="field"><label class="field-lbl">Size</label><input class="inp-sm" id="df-s" placeholder="Auto-detected" value="‚Äî"></div>
    </div>
    <div class="field"><label class="field-lbl">Link to Task (optional)</label>
      <select class="inp-sm" id="df-tk">
        <option value="">No task link</option>
        ${pt.map(t=>`<option value="${t.id}">${t.id} ¬∑ ${t.title}</option>`).join('')}
      </select>
    </div>
    <div class="field">
      <label class="field-lbl">Visibility</label>
      <div class="vis-row" style="margin-top:7px;">
        ${(isCEO()?['ceo-only','team-only','shared']:['team-only','shared']).map(v=>{const vc=VC[v];return`<button type="button" class="vbtn" id="vb-${v}" onclick="selVis('${v}')" style="${v===defVis?`background:${vc.c}18;border-color:${vc.c};color:${vc.c};`:''}">${vc.i} ${vc.l}</button>`;}).join('')}
      </div>
      <input type="hidden" id="df-v" value="${defVis}">
    </div>
    <div id="upload-prog" style="display:none;margin-bottom:12px;"><div style="font-size:11px;color:var(--text4);font-family:var(--fm);margin-bottom:6px;">Saving file‚Ä¶</div><div class="pbar-wrap"><div class="pbar" id="prog-bar" style="width:0%;background:var(--accent);transition:width .3s;"></div></div></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button type="button" class="btn-s" onclick="closeM()">Cancel</button>
      <button type="submit" class="btn-p" id="submit-doc-btn">Upload Document</button>
    </div>
  </form>`,true);
  setTimeout(()=>initUploadZone('upload-zone','file-input-real'),50);
}

function updDocTasks(pid){
  const sel=document.getElementById('df-tk');
  if(!sel)return;
  const pt=tasks.filter(t=>t.projectId===pid);
  sel.innerHTML='<option value="">No task link</option>'+pt.map(t=>`<option value="${t.id}">${t.id} ¬∑ ${t.title}</option>`).join('');
}

function selVis(v){
  $('df-v').value=v;
  ['ceo-only','team-only','shared'].forEach(x=>{const b=document.getElementById('vb-'+x);if(!b)return;const vc=VC[x];if(x===v){b.style.background=vc.c+'18';b.style.borderColor=vc.c;b.style.color=vc.c;}else{b.style.background='';b.style.borderColor='var(--border2)';b.style.color='var(--text4)';}});
}

function initUploadZone(zid,iid){
  const zone=document.getElementById(zid),input=document.getElementById(iid);
  if(!zone||!input)return;
  zone.addEventListener('click',()=>input.click());
  zone.addEventListener('dragover',e=>{e.preventDefault();zone.classList.add('drag');});
  zone.addEventListener('dragleave',()=>zone.classList.remove('drag'));
  zone.addEventListener('drop',e=>{e.preventDefault();zone.classList.remove('drag');if(e.dataTransfer.files[0])handleFileSelect(e.dataTransfer.files[0]);});
  input.addEventListener('change',()=>{if(input.files[0])handleFileSelect(input.files[0]);});
}

function handleFileSelect(file){
  uploadedFile=file;
  const ext=file.name.split('.').pop().toLowerCase();
  const zone=document.getElementById('upload-zone');
  const preview=document.getElementById('upload-preview');
  if(zone)zone.style.display='none';
  if(preview){
    preview.style.display='flex';
    preview.querySelector('.up-icon').textContent=fi(ext);
    preview.querySelector('.up-name').textContent=file.name;
    preview.querySelector('.up-size').textContent=fmtSize(file.size);
  }
  const typeEl=document.getElementById('df-t');const sizeEl=document.getElementById('df-s');const nameEl=document.getElementById('df-n');
  if(typeEl)typeEl.value=ext;if(sizeEl)sizeEl.value=fmtSize(file.size);if(nameEl&&!nameEl.value)nameEl.value=file.name;
}

function clearUploadFile(){
  uploadedFile=null;
  const zone=document.getElementById('upload-zone'),preview=document.getElementById('upload-preview'),inp=document.getElementById('file-input-real');
  if(zone)zone.style.display='';if(preview)preview.style.display='none';if(inp)inp.value='';
}

async function submitDoc(e){
  e.preventDefault();
  const pid=$('df-p').value;
  if(!pid){notify('Select a project first','err');return;}
  const id=gid('DOC');
  const name=$('df-n').value;
  const type=$('df-t').value;
  const taskId=$('df-tk').value||null;
  const vis=$('df-v').value;
  const submitBtn=$('submit-doc-btn');
  if(submitBtn)submitBtn.disabled=true;
  let hasFile=false,finalSize=$('df-s').value,ext=type;
  if(uploadedFile){
    const prog=$('upload-prog'),bar=$('prog-bar');
    if(prog)prog.style.display='block';if(bar)bar.style.width='30%';
    try{
      const dataURL=await readFileAsDataURL(uploadedFile);
      if(bar)bar.style.width='80%';
      await saveFile(id,{id,name:uploadedFile.name,dataURL,mimeType:uploadedFile.type,size:uploadedFile.size});
      if(bar)bar.style.width='100%';
      hasFile=true;
      ext=uploadedFile.name.split('.').pop().toLowerCase();
      finalSize=fmtSize(uploadedFile.size);
    }catch(err){notify('File save failed. Metadata saved only.','err');}
  }
  const docData={id,projectId:pid,taskId,name:name||(uploadedFile?uploadedFile.name:'Document'),uploadedBy:CU.username,role:CU.role,visibility:vis,version:1,timestamp:Date.now(),size:finalSize,type:ext,locked:false,approved:false,comments:{},hasFile};
  db.ref('docs').push(docData);
  closeM();uploadedFile=null;notify(hasFile?'‚úì File saved!':'Document added');
}

// ‚îÄ‚îÄ‚îÄ PAYMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mAddPayment(pid,projKey){
  showModal('Add Payment Stage',`
  <form onsubmit="submitPay(event,'${projKey}')">
    <div class="field"><label class="field-lbl">Stage Name *</label><input class="inp-sm" id="pay-n" required placeholder="e.g. Milestone 2"></div>
    <div class="field"><label class="field-lbl">Amount (‚Çπ) *</label><input class="inp-sm" id="pay-a" type="number" required placeholder="30000"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button type="button" class="btn-s" onclick="closeM()">Cancel</button>
      <button type="submit" class="btn-p">Add Stage</button>
    </div>
  </form>`);
}
function submitPay(e,projKey){
  e.preventDefault();
  const p=projects.find(x=>x.fbKey===projKey);
  const payments=[...(p.payments||[]),{stage:$('pay-n').value,amount:Number($('pay-a').value),status:'Pending',date:''}];
  db.ref(`projects/${projKey}`).update({payments});
  closeM();notify('Payment stage added');
}

// ‚îÄ‚îÄ‚îÄ CREATE USER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mCreateUser(){
  showModal('Create User Account',`
  <form onsubmit="submitUser(event)">
    <div class="g2" style="gap:12px;">
      <div class="field"><label class="field-lbl">First Name *</label><input class="inp-sm" id="uf-f" required autocapitalize="words"></div>
      <div class="field"><label class="field-lbl">Last Name</label><input class="inp-sm" id="uf-l" autocapitalize="words"></div>
    </div>
    <div class="field"><label class="field-lbl">Domain / Role *</label><input class="inp-sm" id="uf-d" required placeholder="Electronics Assembly & Testing"></div>
    <div class="field"><label class="field-lbl">Username *</label><input class="inp-sm" id="uf-u" required placeholder="manoj.elec" autocapitalize="none" autocorrect="off"></div>
    <div class="field"><label class="field-lbl">Preset Password *</label><input class="inp-sm" id="uf-p" required placeholder="Strong preset password" type="password"></div>
    <div style="background:var(--bg4);border:1px solid var(--border);border-radius:9px;padding:12px 13px;margin-bottom:14px;font-size:12px;color:var(--text4);font-family:var(--fm);">
      üí° Password is given privately to the team member. They cannot change it.
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button type="button" class="btn-s" onclick="closeM()">Cancel</button>
      <button type="submit" class="btn-p">Create Account</button>
    </div>
  </form>`);
}
function submitUser(e){
  e.preventDefault();
  const f=$('uf-f').value,l=$('uf-l').value,un=$('uf-u').value.trim().toLowerCase();
  if(USERS[un]){notify('Username already exists','err');return;}
  const initials=(f[0]+(l?l[0]:f[1]||'')).toUpperCase();
  const colors=['#1d4ed8','#0f766e','#7c3aed','#be185d','#c2410c','#0369a1','#4d7c0f'];
  const color=colors[Math.floor(Math.random()*colors.length)];
  db.ref(`users/${un}`).set({name:f+(l?' '+l:''),role:'team',domain:$('uf-d').value,avatar:initials,color,password:$('uf-p').value,enabled:true,createdBy:CU.username,createdAt:Date.now()});
  closeM();notify('Account created: @'+un);
}

// ‚îÄ‚îÄ‚îÄ EDIT USER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mEditUser(un){
  const u=USERS[un];
  showModal(`Edit ‚Äî @${un}`,`
  <div class="field"><label class="field-lbl">Full Name</label><input class="inp-sm" id="eu-n" value="${u.name}" autocapitalize="words"></div>
  <div class="field"><label class="field-lbl">Domain / Role</label><input class="inp-sm" id="eu-d" value="${u.domain}"></div>
  <div class="field"><label class="field-lbl">Preset Password</label><input class="inp-sm" id="eu-p" value="${u.password}" type="password"></div>
  <div style="display:flex;gap:10px;justify-content:flex-end;">
    <button class="btn-s" onclick="closeM()">Cancel</button>
    <button class="btn-p" onclick="submitEdit('${un}')">Save Changes</button>
  </div>`);
}
function submitEdit(un){
  const n=$('eu-n').value;
  db.ref(`users/${un}`).update({name:n,domain:$('eu-d').value,password:$('eu-p').value,avatar:n.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase()});
  closeM();notify('User updated: @'+un);
}

// ‚îÄ‚îÄ‚îÄ ARCHITECTURE NOTES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mNewNote(){
  showModal('New Architecture Note',`
  <div class="field"><label class="field-lbl">Title *</label><input class="inp-sm" id="an-t" required></div>
  <div class="field"><label class="field-lbl">Content</label><textarea class="inp-sm" id="an-c" rows="7" style="resize:vertical;font-family:var(--fm);font-size:13px;line-height:1.7;"></textarea></div>
  <div style="display:flex;gap:10px;justify-content:flex-end;">
    <button class="btn-s" onclick="closeM()">Cancel</button>
    <button class="btn-p" onclick="submitNote()">Add Note</button>
  </div>`,true);
}
function submitNote(){
  const t=$('an-t')?.value,c=$('an-c')?.value;
  if(!t)return;
  db.ref('archNotes').push({title:t,content:c||'',editedBy:CU.username,ts:Date.now(),locked:false});
  closeM();notify('Note added');
}
function mEditNote(key){
  const n=archNotes.find(x=>x.fbKey===key);if(!n)return;
  showModal('Edit: '+n.title,`
  <div class="field"><label class="field-lbl">Title</label><input class="inp-sm" id="en-t" value="${n.title}"></div>
  <div class="field"><label class="field-lbl">Content</label><textarea class="inp-sm" id="en-c" rows="9" style="resize:vertical;font-family:var(--fm);font-size:13px;line-height:1.7;">${n.content||''}</textarea></div>
  <div style="display:flex;gap:10px;justify-content:flex-end;">
    <button class="btn-s" onclick="closeM()">Cancel</button>
    <button class="btn-p" onclick="submitEditNote('${key}')">Save</button>
  </div>`,true);
}
function submitEditNote(key){
  db.ref(`archNotes/${key}`).update({title:$('en-t').value,content:$('en-c').value,editedBy:CU.username,ts:Date.now()});
  closeM();notify('Note updated');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RESPONSIVE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('resize',()=>{
  const mb=$('menu-btn');if(!mb)return;
  mb.style.display=window.innerWidth<=768?'flex':'none';
});

// Shake animation for login
const shakeCSS=document.createElement('style');
shakeCSS.textContent=`@keyframes shake{0%,100%{transform:translateX(0);}15%{transform:translateX(-8px);}30%{transform:translateX(7px);}45%{transform:translateX(-6px);}60%{transform:translateX(5px);}75%{transform:translateX(-3px);}90%{transform:translateX(2px);}}`;
document.head.appendChild(shakeCSS);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STARTUP ‚Äî Firebase-first boot sequence
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(async function startup() {
  showScreen('s-loading');
  // 1. Open IndexedDB for file storage
  await openIDB();

  // 2. Init Firebase
  await initFirebase();

  // 3. Load users from Firebase (or seed defaults if first run)
  const fbUsers = await FB.get('users');
  if (!fbUsers) {
    // First run ‚Äî seed default users to Firebase
    await FB.set('users', DEFAULT_USERS);
    USERS = {...DEFAULT_USERS};
  } else {
    USERS = fbUsers;
  }

  // 4. Check for existing session
  const savedUser = await validateSession();
  if (savedUser && USERS[savedUser] && USERS[savedUser].enabled !== false) {
    CU = {username:savedUser,...USERS[savedUser]};
    _rememberMe = !!localStorage.getItem(SEC.REMEMBER);
    setPresence();
    startInactivity();
    ['click','keydown','touchstart','scroll'].forEach(e=>document.addEventListener(e,resetInactivity,{passive:true}));
    startListeners();
    showScreen('s-app');
    initApp();
  } else {
    showScreen('s-login');
  }
})();
</script>
</body>
</html>

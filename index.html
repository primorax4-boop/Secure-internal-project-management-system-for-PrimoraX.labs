<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>PrimoraX.labs â€” Internal Operations</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=DM+Mono:wght@400;500;600&family=Sora:wght@600;700;800&display=swap" rel="stylesheet"/>
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
:root{
  --bg:#060d1f;--bg2:#07101f;--bg3:#0b1829;--bg4:#0e1f38;--bg5:#132544;
  --border:#182d50;--border2:#1d3a6a;--border3:#234180;
  --text:#edf0fc;--text2:#c8ceec;--text3:#8a9dc0;--text4:#516889;--text5:#334f6e;
  --blue:#1460c0;--blue2:#1a72d4;--blue3:#4ec4fc;--blue4:#1a3a6e;
  --green:#56c26a;--green2:#1a4a28;--red:#f04545;--red2:#4a1515;
  --amber:#fcb144;--amber2:#4a3010;--purple:#cc88e8;--purple2:#3a1a52;
  --cyan:#22d3ee;--teal:#14b8a6;
  --ff:'DM Sans',sans-serif;--fm:'DM Mono',monospace;--fd:'Sora',sans-serif;
  --r8:8px;--r10:10px;--r12:12px;--r16:16px;
  --shadow:0 4px 24px rgba(0,0,0,.4);--shadow2:0 8px 40px rgba(0,0,0,.6);
  --touch-min:48px;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--ff);font-size:14px;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:var(--bg2);}
::-webkit-scrollbar-thumb{background:var(--border3);border-radius:2px;}
button{cursor:pointer;border:none;font-family:var(--ff);background:none;touch-action:manipulation;}
input,select,textarea{outline:none;font-family:var(--ff);font-size:16px !important;} /* prevent zoom on iOS */

.screen{display:none;}
.screen.active{display:flex;}

/* LOGIN */
#s-login{min-height:100vh;align-items:center;justify-content:center;padding:20px;
  background:var(--bg);
  background-image:radial-gradient(ellipse 80% 60% at 15% 60%,rgba(20,96,192,.18) 0%,transparent 70%),
  radial-gradient(ellipse 60% 50% at 85% 15%,rgba(14,31,56,.6) 0%,transparent 60%),
  radial-gradient(ellipse 40% 40% at 50% 90%,rgba(20,60,130,.1) 0%,transparent 60%);}
.login-wrap{width:100%;max-width:400px;}
.login-card{background:var(--bg3);border:1px solid var(--border2);border-radius:20px;padding:44px 40px;box-shadow:0 40px 80px rgba(0,0,0,.7),0 0 0 1px rgba(78,196,252,.04);}
.login-logo{text-align:center;margin-bottom:36px;}
.login-hex{width:52px;height:52px;background:linear-gradient(145deg,#1a72d4,#0d47a1);border-radius:14px;display:inline-flex;align-items:center;justify-content:center;font-size:26px;margin-bottom:14px;box-shadow:0 8px 24px rgba(21,101,192,.35);}
.login-brand{font-family:var(--fd);font-weight:800;font-size:24px;color:var(--text);letter-spacing:-.03em;line-height:1;}
.login-sub{font-size:11px;color:var(--text5);font-family:var(--fm);letter-spacing:.1em;text-transform:uppercase;margin-top:6px;}
.inp-group{margin-bottom:18px;}
.inp-label{display:block;font-size:10px;color:var(--text4);font-family:var(--fm);letter-spacing:.1em;text-transform:uppercase;font-weight:600;margin-bottom:7px;}
.inp{width:100%;background:var(--bg4);border:1.5px solid var(--border2);border-radius:var(--r10);color:var(--text);padding:13px 14px;font-size:16px !important;transition:border-color .2s,box-shadow .2s;}
.inp:focus{border-color:var(--blue2);box-shadow:0 0 0 3px rgba(26,114,212,.12);}
.inp::placeholder{color:var(--text5);}
.pw-wrap{position:relative;}
.pw-wrap .inp{padding-right:52px;}
.pw-eye{position:absolute;right:13px;top:50%;transform:translateY(-50%);color:var(--text4);font-size:20px;padding:6px 8px;border-radius:4px;min-height:var(--touch-min);display:flex;align-items:center;}
.pw-eye:hover{color:var(--text2);}
.login-err{background:rgba(240,69,69,.15);border:1px solid rgba(240,69,69,.3);color:#fc8585;border-radius:var(--r8);padding:10px 14px;font-size:12px;margin-bottom:16px;font-family:var(--fm);display:none;}
.btn-login{width:100%;background:linear-gradient(135deg,#1565c0,#0d47a1);color:#fff;padding:15px;border-radius:var(--r10);font-size:15px;font-weight:600;letter-spacing:.02em;box-shadow:0 4px 20px rgba(21,101,192,.4);transition:all .2s;min-height:var(--touch-min);}
.btn-login:hover{transform:translateY(-1px);box-shadow:0 6px 28px rgba(21,101,192,.5);}
.btn-login:active{transform:translateY(0);}
.login-footer{text-align:center;margin-top:22px;font-size:10px;color:var(--text5);font-family:var(--fm);letter-spacing:.06em;}

/* WELCOME */
#s-welcome{min-height:100vh;align-items:center;justify-content:center;padding:20px;flex-direction:column;
  background:var(--bg);
  background-image:radial-gradient(ellipse 70% 60% at 30% 40%,rgba(20,96,192,.14) 0%,transparent 65%),
  radial-gradient(ellipse 50% 50% at 75% 70%,rgba(78,196,252,.05) 0%,transparent 60%);}
#welcome-card{text-align:center;animation:wElcome .6s cubic-bezier(.34,1.56,.64,1) both;}
@keyframes wElcome{from{opacity:0;transform:scale(.88) translateY(24px);}to{opacity:1;transform:scale(1) translateY(0);}}
.wc-avatar{width:88px;height:88px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-family:var(--fm);font-weight:700;font-size:30px;margin-bottom:24px;position:relative;}
.wc-avatar::after{content:'';position:absolute;inset:-4px;border-radius:50%;border:2px solid rgba(78,196,252,.3);animation:pulse 2s ease-in-out infinite;}
@keyframes pulse{0%,100%{opacity:.4;transform:scale(1);}50%{opacity:1;transform:scale(1.05);}}
.wc-greeting{font-family:var(--fd);font-weight:800;font-size:28px;color:var(--text);letter-spacing:-.03em;margin-bottom:8px;}
.wc-sub{font-size:14px;color:var(--text3);margin-bottom:6px;}
.wc-role{display:inline-block;padding:5px 16px;border-radius:20px;font-size:12px;font-family:var(--fm);font-weight:600;letter-spacing:.06em;text-transform:uppercase;margin-bottom:32px;}
.wc-role.ceo{background:rgba(204,136,232,.15);border:1px solid rgba(204,136,232,.3);color:var(--purple);}
.wc-role.team{background:rgba(78,196,252,.1);border:1px solid rgba(78,196,252,.25);color:var(--blue3);}
.wc-facts{display:flex;gap:14px;margin-bottom:28px;flex-wrap:wrap;justify-content:center;}
.wc-fact{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r12);padding:12px 18px;min-width:100px;}
.wc-fact-val{font-family:var(--fd);font-weight:700;font-size:22px;color:var(--blue3);}
.wc-fact-lbl{font-size:10px;color:var(--text4);font-family:var(--fm);text-transform:uppercase;letter-spacing:.06em;margin-top:3px;}
.wc-quote{font-size:13px;color:var(--text4);font-style:italic;margin-bottom:32px;max-width:340px;}
.btn-enter{background:linear-gradient(135deg,#1565c0,#0d47a1);color:#fff;padding:14px 36px;border-radius:var(--r10);font-size:15px;font-weight:600;box-shadow:0 4px 20px rgba(21,101,192,.4);transition:all .2s;letter-spacing:.02em;min-height:var(--touch-min);}
.btn-enter:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(21,101,192,.5);}

/* APP SHELL */
#s-app{height:100vh;flex-direction:row;overflow:hidden;}
#sidebar{width:232px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;height:100vh;flex-shrink:0;transition:transform .28s cubic-bezier(.4,0,.2,1);}
#main-area{flex:1;display:flex;flex-direction:column;overflow:hidden;background:var(--bg);}

/* SIDEBAR */
.sb-logo{padding:20px 16px 16px;border-bottom:1px solid var(--border);}
.sb-logo-row{display:flex;align-items:center;gap:11px;}
.sb-hex{width:38px;height:38px;background:linear-gradient(145deg,#1a72d4,#0d47a1);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.sb-brand{font-family:var(--fd);font-weight:800;font-size:16px;color:var(--text);letter-spacing:-.02em;}
.sb-brand span{color:var(--blue3);}
.sb-tag{font-size:9px;color:var(--text5);font-family:var(--fm);letter-spacing:.1em;text-transform:uppercase;margin-top:1px;}
.sb-nav{flex:1;padding:12px 8px;overflow-y:auto;}
.sb-section{font-size:9px;color:var(--text5);font-family:var(--fm);letter-spacing:.1em;text-transform:uppercase;padding:0 8px;margin:10px 0 6px;}
.nb{display:flex;align-items:center;gap:10px;width:100%;padding:11px 12px;border-radius:9px;margin-bottom:2px;color:var(--text4);border:1px solid transparent;text-align:left;font-size:13px;font-weight:500;transition:all .14s;position:relative;min-height:44px;}
.nb:hover{background:var(--bg3);color:var(--text2);}
.nb.active{background:var(--bg4);color:var(--blue3);border-color:var(--border2);}
.nb.active::before{content:'';position:absolute;left:0;top:20%;bottom:20%;width:3px;background:var(--blue3);border-radius:0 2px 2px 0;}
.nb .ni{font-size:16px;width:22px;text-align:center;flex-shrink:0;}
.nb .nl{flex:1;}
.nb .nt{font-size:9px;font-family:var(--fm);color:#b060d0;background:rgba(180,90,220,.1);padding:2px 6px;border-radius:3px;letter-spacing:.04em;}
.sb-user{padding:14px 14px 16px;border-top:1px solid var(--border);}
.sb-user-row{display:flex;align-items:center;gap:10px;margin-bottom:11px;}
.sb-uname{font-size:12px;font-weight:600;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.sb-urole{font-size:10px;color:var(--text4);font-family:var(--fm);margin-top:1px;}
.btn-signout{width:100%;padding:10px;border-radius:var(--r8);font-size:13px;background:var(--bg4);color:var(--text3);border:1px solid var(--border2);transition:all .15s;min-height:44px;}
.btn-signout:hover{background:rgba(240,69,69,.15);color:#fc8585;border-color:rgba(240,69,69,.3);}

/* TOPBAR */
#topbar{padding:0 20px;height:56px;border-bottom:1px solid var(--border);background:var(--bg2);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.tb-left{display:flex;align-items:center;gap:8px;}
#menu-btn{display:none;color:var(--text3);font-size:22px;padding:6px 8px;border-radius:6px;margin-right:4px;min-height:44px;min-width:44px;align-items:center;justify-content:center;}
#menu-btn:hover{background:var(--bg3);}
.tb-title{font-family:var(--fd);font-weight:700;font-size:16px;color:var(--text);letter-spacing:-.02em;}
.tb-date{font-size:10px;color:var(--text5);font-family:var(--fm);margin-top:1px;}
.tb-right{display:flex;align-items:center;gap:8px;}

/* CONTENT */
#content{flex:1;overflow-y:auto;padding:22px 24px;-webkit-overflow-scrolling:touch;display:flex;flex-direction:column;min-height:0;}
#content:not([style]){overflow-y:auto;}
.page{animation:pageIn .22s ease both;flex:1;}
@keyframes pageIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}

/* REUSABLE */
.badge{display:inline-flex;align-items:center;border-radius:5px;padding:2px 8px;font-size:10px;font-family:var(--fm);font-weight:600;letter-spacing:.05em;text-transform:uppercase;white-space:nowrap;gap:3px;}
.avatar{border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:var(--fm);font-weight:700;flex-shrink:0;letter-spacing:.04em;}
.card{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r12);transition:border-color .15s;}
.card:hover{border-color:var(--border3);}
.stat-card{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r12);padding:16px 18px;}
.stat-icon{font-size:20px;margin-bottom:8px;}
.stat-val{font-family:var(--fd);font-weight:700;font-size:24px;margin-bottom:3px;}
.stat-lbl{font-size:10px;color:var(--text4);font-family:var(--fm);text-transform:uppercase;letter-spacing:.06em;}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.g3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;}
.pbar-wrap{height:5px;background:var(--bg5);border-radius:3px;overflow:hidden;}
.pbar{height:100%;border-radius:3px;transition:width .4s ease;}
.divider{border:none;border-top:1px solid var(--border);margin:12px 0;}
.section-head{font-family:var(--fd);font-weight:700;font-size:13px;color:var(--text2);margin-bottom:12px;}
.irow{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);}
.irow:last-child{border-bottom:none;}
.ilabel{font-size:11px;color:var(--text4);font-family:var(--fm);text-transform:uppercase;letter-spacing:.05em;}
.ival{font-size:13px;color:var(--text2);font-weight:500;}
.filter-bar{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px;}
.fbtn{padding:8px 14px;border-radius:8px;font-size:12px;font-family:var(--fm);background:var(--bg3);color:var(--text3);border:1px solid var(--border);transition:all .14s;min-height:38px;}
.fbtn:hover{border-color:var(--border3);color:var(--text2);}
.fbtn.on{background:var(--blue);color:#fff;border-color:var(--blue2);}
.flex-end{display:flex;justify-content:flex-end;}
.flex-mid{display:flex;align-items:center;}
.flex-between{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;}
.gap6{gap:6px;} .gap8{gap:8px;} .gap10{gap:10px;} .gap12{gap:12px;}
.empty{text-align:center;padding:48px 20px;color:var(--text5);background:var(--bg3);border:1px solid var(--border);border-radius:var(--r12);}
.empty-icon{font-size:32px;display:block;margin-bottom:10px;}
.back-btn{display:inline-flex;align-items:center;gap:6px;color:var(--text4);font-size:12px;font-family:var(--fm);margin-bottom:14px;padding:8px 0;transition:color .14s;min-height:40px;}
.back-btn:hover{color:var(--blue3);}

/* BUTTONS - all touch-friendly */
.btn-p{background:linear-gradient(135deg,#1565c0,#0d47a1);color:#fff;padding:10px 20px;border-radius:var(--r8);font-size:13px;font-weight:600;box-shadow:0 3px 12px rgba(21,101,192,.3);white-space:nowrap;transition:all .15s;min-height:42px;}
.btn-p:hover{opacity:.9;transform:translateY(-1px);}
.btn-s{background:var(--bg4);color:var(--text3);padding:10px 16px;border-radius:var(--r8);font-size:13px;border:1px solid var(--border2);white-space:nowrap;transition:all .14s;min-height:42px;}
.btn-s:hover{background:var(--bg5);color:var(--text2);}
.btn-sm{background:var(--bg4);color:var(--text3);padding:7px 13px;border-radius:6px;font-size:12px;font-family:var(--fm);border:1px solid var(--border2);transition:all .14s;min-height:36px;}
.btn-sm:hover{background:var(--bg5);color:var(--text2);}
.btn-icon{background:var(--bg4);border:1px solid var(--border2);border-radius:6px;color:var(--text3);padding:6px 10px;font-size:13px;transition:all .14s;min-height:38px;min-width:38px;display:inline-flex;align-items:center;justify-content:center;}
.btn-icon:hover{border-color:var(--border3);color:var(--text2);}

/* FORMS */
.field{margin-bottom:14px;}
.inp-sm{background:var(--bg4);border:1.5px solid var(--border2);border-radius:var(--r8);color:var(--text);padding:11px 13px;font-size:16px !important;width:100%;transition:border-color .2s;min-height:46px;}
.inp-sm:focus{border-color:var(--blue2);}
.inp-sm::placeholder{color:var(--text5);}
select.inp-sm option{background:var(--bg4);}
textarea.inp-sm{min-height:unset;resize:vertical;}

/* FILE UPLOAD ZONE */
.upload-zone{border:2px dashed var(--border3);border-radius:var(--r12);padding:32px 20px;text-align:center;cursor:pointer;transition:all .2s;background:var(--bg4);}
.upload-zone:hover,.upload-zone.drag{border-color:var(--blue2);background:rgba(26,114,212,.06);}
.upload-zone-icon{font-size:40px;margin-bottom:12px;display:block;}
.upload-zone-title{font-size:15px;font-weight:600;color:var(--text2);margin-bottom:6px;}
.upload-zone-sub{font-size:12px;color:var(--text4);font-family:var(--fm);}
.file-input-hidden{display:none;}
.upload-preview{background:var(--bg4);border:1px solid var(--border2);border-radius:var(--r8);padding:12px 14px;margin-top:10px;display:flex;align-items:center;gap:10px;}
.upload-preview-icon{font-size:28px;flex-shrink:0;}
.upload-preview-name{font-size:13px;color:var(--text2);font-weight:500;word-break:break-all;}
.upload-preview-size{font-size:11px;color:var(--text4);font-family:var(--fm);margin-top:2px;}
.upload-preview-rm{margin-left:auto;color:var(--red);font-size:18px;padding:4px 6px;flex-shrink:0;}

/* MODAL */
#modal-root .overlay{position:fixed;inset:0;background:rgba(4,9,20,.9);z-index:1000;display:flex;align-items:flex-end;justify-content:center;padding:0;animation:fadeOver .18s ease;}
@media(min-width:600px){#modal-root .overlay{align-items:center;padding:16px;}}
@keyframes fadeOver{from{opacity:0;}to{opacity:1;}}
.mbox{background:var(--bg3);border:1px solid var(--border2);border-radius:20px 20px 0 0;padding:22px 20px 32px;width:100%;max-height:92vh;overflow-y:auto;box-shadow:0 -20px 60px rgba(0,0,0,.7);animation:mSlideUp .25s cubic-bezier(.34,1.1,.64,1);}
@media(min-width:600px){.mbox{border-radius:18px;max-width:520px;padding:26px 28px 28px;animation:mSlide .22s cubic-bezier(.34,1.3,.64,1);}}
@keyframes mSlideUp{from{transform:translateY(100%);}to{transform:translateY(0);}}
@keyframes mSlide{from{opacity:0;transform:scale(.95) translateY(16px);}to{opacity:1;transform:scale(1) translateY(0);}}
.mbox-wide{max-width:600px;}
.mhead{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;}
.mtitle{font-family:var(--fd);font-weight:700;font-size:16px;color:var(--text);}
.mclose{color:var(--text4);font-size:28px;line-height:1;padding:4px 8px;border-radius:5px;transition:all .14s;min-height:44px;min-width:44px;display:flex;align-items:center;justify-content:center;}
.mclose:hover{background:var(--bg5);color:var(--text);}
/* Modal drag handle for mobile */
.drag-handle{width:40px;height:4px;background:var(--border2);border-radius:2px;margin:0 auto 16px;}

/* TABS */
.tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:18px;gap:0;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
.tabs::-webkit-scrollbar{display:none;}
.tab{padding:10px 16px;font-size:13px;font-weight:500;color:var(--text4);border-bottom:2px solid transparent;text-transform:capitalize;transition:all .14s;white-space:nowrap;min-height:44px;display:flex;align-items:center;}
.tab:hover{color:var(--text2);}
.tab.on{color:var(--blue3);border-bottom-color:var(--blue3);}

/* TABLE */
.tbl-wrap{overflow-x:auto;border-radius:var(--r12);border:1px solid var(--border);-webkit-overflow-scrolling:touch;}
table{width:100%;border-collapse:collapse;min-width:580px;}
th{padding:10px 14px;text-align:left;font-size:10px;color:var(--text4);font-family:var(--fm);text-transform:uppercase;letter-spacing:.06em;font-weight:600;background:var(--bg4);border-bottom:1px solid var(--border);}
td{padding:12px 14px;border-bottom:1px solid var(--border);font-size:12px;color:var(--text2);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:rgba(255,255,255,.015);}

/* CARDS */
.proj-card{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r12);padding:16px 20px;margin-bottom:10px;cursor:pointer;transition:all .15s;}
.proj-card:hover{border-color:var(--border3);background:var(--bg4);}
.task-card{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r12);margin-bottom:10px;overflow:hidden;}
.tc-head{padding:14px 16px;cursor:pointer;transition:background .14s;min-height:60px;}
.tc-head:hover{background:rgba(255,255,255,.02);}
.tc-body{border-top:1px solid var(--border);padding:14px 16px;}
.doc-card{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r10);padding:14px 16px;margin-bottom:9px;}
.note-item{padding:10px 12px;background:var(--bg4);border-radius:var(--r8);margin-bottom:7px;border-left:3px solid var(--border2);}
.cmt-item{display:flex;gap:11px;padding:12px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--r10);margin-bottom:8px;}
.pay-row{display:flex;align-items:center;justify-content:space-between;padding:13px 16px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--r10);margin-bottom:8px;}

/* MEMBER CHIPS */
.mchip{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;background:var(--bg4);border:1px solid var(--border2);border-radius:20px;font-size:13px;margin:4px;cursor:pointer;transition:all .14s;min-height:40px;}
.mchip:hover{border-color:var(--border3);}
.mchip.sel{background:rgba(21,96,192,.25);border-color:var(--blue2);color:var(--blue3);}
.vis-row{display:flex;gap:8px;margin-top:6px;}
.vbtn{flex:1;padding:10px 8px;border-radius:var(--r8);font-size:12px;font-family:var(--fm);border:1.5px solid var(--border2);background:var(--bg4);color:var(--text4);cursor:pointer;transition:all .15s;min-height:44px;}

/* NOTIF */
#notif{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);z-index:9999;background:rgba(22,80,28,.97);border:1px solid rgba(86,194,106,.35);color:#a5e0b0;padding:12px 22px;border-radius:12px;font-family:var(--fm);font-size:13px;box-shadow:var(--shadow2);display:none;animation:nIn .22s ease;max-width:90vw;text-align:center;white-space:nowrap;}
#notif.err{background:rgba(60,14,14,.97);border-color:rgba(240,69,69,.35);color:#fc9898;}
@keyframes nIn{from{transform:translateX(-50%) translateY(16px);opacity:0;}to{transform:translateX(-50%) translateY(0);opacity:1;}}

/* OVERLAY */
#sb-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:199;}
#sb-overlay.on{display:block;}

/* MOBILE NAV BAR - bottom navigation for mobile */
#bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;z-index:150;background:var(--bg2);border-top:1px solid var(--border);padding:6px 8px env(safe-area-inset-bottom,8px);gap:2px;}
.bnav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:8px 4px;border-radius:8px;color:var(--text5);font-size:9px;font-family:var(--fm);letter-spacing:.04em;text-transform:uppercase;cursor:pointer;transition:all .14s;min-height:54px;justify-content:center;}
.bnav-item:hover,.bnav-item.active{color:var(--blue3);}
.bnav-item.active{background:rgba(78,196,252,.08);}
.bnav-icon{font-size:20px;}

/* STORAGE STATUS */
.storage-badge{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;background:rgba(86,194,106,.1);border:1px solid rgba(86,194,106,.2);border-radius:6px;font-size:10px;font-family:var(--fm);color:var(--green);}

/* DOC DOWNLOAD AREA */
.doc-data-preview{margin-top:12px;padding:12px;background:var(--bg4);border-radius:10px;border:1px dashed var(--border3);}
.doc-data-preview img{max-width:100%;border-radius:6px;}

/* â”€â”€â”€ GROUP CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#chat-wrap{display:flex;flex-direction:column;flex:1;overflow:hidden;min-height:0;}
@media(max-width:768px){#chat-wrap{padding-bottom:env(safe-area-inset-bottom);}}
#chat-messages{flex:1;overflow-y:auto;padding:16px 16px 8px;display:flex;flex-direction:column;gap:8px;-webkit-overflow-scrolling:touch;min-height:0;}
#chat-input-bar{padding:12px 16px;border-top:1px solid var(--border);background:var(--bg2);display:flex;gap:10px;align-items:flex-end;flex-shrink:0;}
.chat-msg{display:flex;gap:10px;max-width:85%;}
.chat-msg.mine{flex-direction:row-reverse;align-self:flex-end;}
.chat-msg.mine .chat-bubble{background:linear-gradient(135deg,#1565c0,#0d47a1);color:#fff;border-radius:18px 18px 4px 18px;}
.chat-msg.theirs .chat-bubble{background:var(--bg3);border:1px solid var(--border);border-radius:18px 18px 18px 4px;}
.chat-bubble{padding:10px 14px;font-size:13px;line-height:1.6;max-width:100%;word-break:break-word;}
.chat-meta{font-size:10px;margin-top:3px;font-family:var(--fm);}
.chat-msg.mine .chat-meta{text-align:right;color:rgba(78,196,252,.7);}
.chat-msg.theirs .chat-meta{color:var(--text5);}
.chat-date-divider{text-align:center;font-size:10px;color:var(--text5);font-family:var(--fm);padding:6px 0;letter-spacing:.06em;text-transform:uppercase;}
.chat-typing-area{flex:1;background:var(--bg4);border:1.5px solid var(--border2);border-radius:14px;color:var(--text);padding:11px 14px;font-size:15px;resize:none;max-height:120px;min-height:44px;line-height:1.5;transition:border-color .2s;}
.chat-typing-area:focus{border-color:var(--blue2);}
.chat-send-btn{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#1565c0,#0d47a1);color:#fff;font-size:18px;display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 3px 12px rgba(21,101,192,.4);transition:all .15s;}
.chat-send-btn:hover{transform:scale(1.08);}
.chat-send-btn:active{transform:scale(.95);}
.chat-name-badge{font-size:11px;font-weight:600;color:var(--text3);margin-bottom:4px;padding:0 2px;}
.chat-msg.mine .chat-name-badge{display:none;}
.chat-unread{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:var(--red);color:#fff;font-size:9px;font-family:var(--fm);font-weight:700;margin-left:4px;}

/* MOBILE */
@media(max-width:768px){
  #menu-btn{display:flex;}
  #sidebar{position:fixed;left:0;top:0;bottom:0;z-index:200;transform:translateX(-100%);}
  #sidebar.open{transform:translateX(0);}
  #content{padding:14px 14px 80px;}
  #bottom-nav{display:flex;}
  .g4{grid-template-columns:1fr 1fr;}
  .g2{grid-template-columns:1fr;}
  .g3{grid-template-columns:1fr 1fr;}
  .tb-title{font-size:15px;}
  .mbox{padding:20px 16px 36px;}
}
@media(max-width:480px){
  .g4{grid-template-columns:1fr 1fr;}
  .g3{grid-template-columns:1fr;}
  .login-card{padding:32px 20px;}
  .wc-greeting{font-size:24px;}
  .wc-facts{gap:10px;}
  .filter-bar{gap:5px;}
  .fbtn{padding:7px 11px;font-size:11px;}
}
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="s-login" class="screen active">
  <div class="login-wrap">
    <div class="login-card">
      <div class="login-logo">
        <div class="login-hex">â¬¡</div>
        <div class="login-brand">PrimoraX<span style="color:var(--blue3)">.labs</span></div>
        <div class="login-sub">Internal Operations System</div>
      </div>
      <div class="inp-group">
        <label class="inp-label">Username</label>
        <input class="inp" id="l-user" placeholder="" autocomplete="username" autocapitalize="none" spellcheck="false"/>
      </div>
      <div class="inp-group">
        <label class="inp-label">Password</label>
        <div class="pw-wrap">
          <input class="inp" id="l-pass" type="password" placeholder="Your preset password" autocomplete="current-password"/>
          <button class="pw-eye" id="l-eye" onclick="togglePW()" type="button">ğŸ‘</button>
        </div>
      </div>
      <div class="login-err" id="l-err">âš  Invalid credentials. Contact your administrator.</div>
      <div id="l-lock" style="display:none;background:rgba(252,177,68,.1);border:1px solid rgba(252,177,68,.3);color:#fcb144;border-radius:var(--r8);padding:10px 14px;font-size:12px;margin-bottom:16px;font-family:var(--fm);"></div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;">
        <label style="display:flex;align-items:center;gap:9px;cursor:pointer;user-select:none;">
          <div class="toggle-wrap" id="rm-toggle" onclick="toggleRM()" style="width:38px;height:22px;background:var(--bg5);border-radius:11px;border:1.5px solid var(--border2);position:relative;transition:all .2s;flex-shrink:0;">
            <div id="rm-knob" style="width:16px;height:16px;background:var(--text5);border-radius:50%;position:absolute;top:1px;left:1px;transition:all .2s;"></div>
          </div>
          <span style="font-size:12px;color:var(--text4);font-family:var(--fm);">Remember me for 7 days</span>
        </label>
        <span id="rm-on" style="display:none;font-size:10px;color:var(--green);font-family:var(--fm);letter-spacing:.04em;">SESSION SAVED</span>
      </div>
      <button class="btn-login" onclick="doLogin()">Access System</button>
      <p class="login-footer">ğŸ”’ RESTRICTED INTERNAL ACCESS Â· INTERNAL USE ONLY</p>
    </div>
  </div>
</div>

<!-- WELCOME SCREEN -->
<div id="s-welcome" class="screen" style="flex-direction:column;">
  <div id="welcome-card">
    <div id="wc-av" class="wc-avatar" style="background:#0d47a1;margin:0 auto;"></div>
    <div id="wc-time" style="font-size:12px;color:var(--text4);font-family:var(--fm);text-transform:uppercase;letter-spacing:.08em;margin-bottom:10px;"></div>
    <div id="wc-greet" class="wc-greeting"></div>
    <div id="wc-full" class="wc-sub"></div>
    <div id="wc-role-badge" class="wc-role team" style="margin-top:10px;"></div>
    <div id="wc-facts" class="wc-facts"></div>
    <div id="wc-quote" class="wc-quote"></div>
    <button class="btn-enter" onclick="enterApp()">Enter Dashboard â†’</button>
    <p style="font-size:11px;color:var(--text5);margin-top:16px;font-family:var(--fm);">
      <span id="wc-date"></span>
    </p>
  </div>
</div>

<!-- APP SCREEN -->
<div id="s-app" class="screen">
  <div id="sb-overlay" onclick="closeSB()"></div>
  <div id="sidebar">
    <div class="sb-logo">
      <div class="sb-logo-row">
        <div class="sb-hex">â¬¡</div>
        <div>
          <div class="sb-brand">PrimoraX<span>.labs</span></div>
          <div class="sb-tag">Internal Ops</div>
        </div>
      </div>
    </div>
    <nav class="sb-nav" id="sb-nav"></nav>
    <div class="sb-user" id="sb-user"></div>
  </div>
  <div id="main-area">
    <div id="topbar">
      <div class="tb-left">
        <button id="menu-btn" onclick="toggleSB()" style="display:none;">â˜°</button>
        <div>
          <div class="tb-title" id="tb-title">Dashboard</div>
          <div class="tb-date" id="tb-date"></div>
        </div>
      </div>
      <div class="tb-right" id="tb-right"></div>
    </div>
    <div id="content"></div>
  </div>
  <!-- Bottom Navigation for Mobile -->
  <div id="bottom-nav">
    <div class="bnav-item" id="bn-dashboard" onclick="navigate('dashboard')"><span class="bnav-icon">â—ˆ</span>Home</div>
    <div class="bnav-item" id="bn-projects" onclick="navigate('projects')"><span class="bnav-icon">â¬¡</span>Projects</div>
    <div class="bnav-item" id="bn-tasks" onclick="navigate('tasks')"><span class="bnav-icon">â—</span>Tasks</div>
    <div class="bnav-item" id="bn-groupchat" onclick="navigate('groupchat')"><span class="bnav-icon">ğŸ’¬</span>Chat</div>
    <div class="bnav-item" id="bn-more" onclick="toggleSB()"><span class="bnav-icon">â˜°</span>More</div>
  </div>
</div>

<!-- NOTIFICATIONS & MODALS -->
<div id="notif"></div>
<div id="modal-root"></div>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     SECURITY ENGINE
// â•šâ•â•â•â•â–ˆâ–ˆâ•—â•šâ•â•â•â•â–ˆâ–ˆâ•—    Senior-grade, zero-cost, zero-API
//  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•    IndexedDB Â· SubtleCrypto Â· Tokens
//  â•šâ•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•     Rate limiting Â· Auto-logout Â· XSS
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—    All built into the browser. Free.
// â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ SECURITY CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SEC = {
  TOKEN_KEY:       'px_session_token',
  TOKEN_HASH_KEY:  'px_session_hash',
  TOKEN_USER_KEY:  'px_session_user',
  TOKEN_EXPIRY_KEY:'px_session_expiry',
  REMEMBER_KEY:    'px_remember',
  FAIL_KEY:        'px_fail_',       // prefix + username
  LOCK_KEY:        'px_lock_',       // prefix + username
  MAX_FAILS:       5,                // attempts before lockout
  LOCK_SECS:       30,               // lockout seconds
  SESSION_SECS:    1800,             // 30 min inactivity
  REMEMBER_DAYS:   7,                // remember me duration
  TOKEN_BYTES:     32,               // 256-bit token
};
let _rememberMe = false;
let _inactivityTimer = null;

// â”€â”€ CRYPTO HELPERS (SubtleCrypto â€” built-in, free) â”€â”€â”€â”€â”€â”€
async function sha256hex(str) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
function genToken() {
  const arr = new Uint8Array(SEC.TOKEN_BYTES);
  crypto.getRandomValues(arr);
  return Array.from(arr).map(b=>b.toString(16).padStart(2,'0')).join('');
}

// â”€â”€ RATE LIMITING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getFailCount(un) {
  return parseInt(localStorage.getItem(SEC.FAIL_KEY + un) || '0');
}
function incFail(un) {
  const n = getFailCount(un) + 1;
  localStorage.setItem(SEC.FAIL_KEY + un, n);
  if (n >= SEC.MAX_FAILS) {
    localStorage.setItem(SEC.LOCK_KEY + un, Date.now() + SEC.LOCK_SECS * 1000);
  }
  return n;
}
function clearFail(un) {
  localStorage.removeItem(SEC.FAIL_KEY + un);
  localStorage.removeItem(SEC.LOCK_KEY + un);
}
function getLockRemain(un) {
  const until = parseInt(localStorage.getItem(SEC.LOCK_KEY + un) || '0');
  const remain = Math.ceil((until - Date.now()) / 1000);
  return remain > 0 ? remain : 0;
}

// â”€â”€ SESSION MANAGEMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function createSession(username, remember) {
  const token = genToken();
  const hash  = await sha256hex(token + username + navigator.userAgent.slice(0, 30));
  const store = remember ? localStorage : sessionStorage;
  const expiry = remember
    ? Date.now() + SEC.REMEMBER_DAYS * 86400 * 1000
    : Date.now() + SEC.SESSION_SECS * 1000;

  // Clear any old session first
  clearSession();

  store.setItem(SEC.TOKEN_KEY,   token);
  store.setItem(SEC.TOKEN_HASH_KEY, hash);
  store.setItem(SEC.TOKEN_USER_KEY, username);
  store.setItem(SEC.TOKEN_EXPIRY_KEY, expiry);
  if (remember) localStorage.setItem(SEC.REMEMBER_KEY, '1');
}

async function validateSession() {
  // Check both sessionStorage (non-remember) and localStorage (remember)
  const stores = [sessionStorage, localStorage];
  for (const store of stores) {
    const token  = store.getItem(SEC.TOKEN_KEY);
    const hash   = store.getItem(SEC.TOKEN_HASH_KEY);
    const user   = store.getItem(SEC.TOKEN_USER_KEY);
    const expiry = parseInt(store.getItem(SEC.TOKEN_EXPIRY_KEY) || '0');
    if (!token || !hash || !user || !expiry) continue;
    if (Date.now() > expiry) { store.removeItem(SEC.TOKEN_KEY); continue; }
    // Re-compute hash and compare (prevents token tampering)
    const expected = await sha256hex(token + user + navigator.userAgent.slice(0, 30));
    if (expected !== hash) { clearSession(); return null; }
    // Validate user still exists and enabled
    if (!USERS[user] || USERS[user].enabled === false) { clearSession(); return null; }
    // Refresh expiry on sessionStorage sessions (activity-based)
    if (store === sessionStorage) {
      store.setItem(SEC.TOKEN_EXPIRY_KEY, Date.now() + SEC.SESSION_SECS * 1000);
    }
    return user;
  }
  return null;
}

function clearSession() {
  [sessionStorage, localStorage].forEach(s => {
    s.removeItem(SEC.TOKEN_KEY);
    s.removeItem(SEC.TOKEN_HASH_KEY);
    s.removeItem(SEC.TOKEN_USER_KEY);
    s.removeItem(SEC.TOKEN_EXPIRY_KEY);
  });
  localStorage.removeItem(SEC.REMEMBER_KEY);
}

// â”€â”€ INACTIVITY AUTO-LOGOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetInactivity() {
  if (_rememberMe) return; // don't auto-logout if remember-me
  clearTimeout(_inactivityTimer);
  _inactivityTimer = setTimeout(() => {
    notify('Session expired due to inactivity', 'err');
    setTimeout(doLogout, 1500);
  }, SEC.SESSION_SECS * 1000);
}
function startInactivityWatch() {
  ['click','keydown','touchstart','scroll'].forEach(e =>
    document.addEventListener(e, resetInactivity, { passive: true })
  );
  resetInactivity();
}
function stopInactivityWatch() {
  clearTimeout(_inactivityTimer);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INDEXEDDB â€” Permanent Storage for ALL data + files
// 3 object stores:
//   'files'   â€” actual uploaded file blobs (dataURL)
//   'appdata' â€” projects, tasks, docs, notes, comments
//   'meta'    â€” misc metadata
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let DB = null;
const DB_NAME    = 'PrimoraXv3';
const DB_VERSION = 3;

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = e => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains('files')) {
        db.createObjectStore('files', { keyPath: 'id' });
      }
      if (!db.objectStoreNames.contains('appdata')) {
        db.createObjectStore('appdata', { keyPath: 'key' });
      }
    };
    req.onsuccess  = e => { DB = e.target.result; resolve(DB); };
    req.onerror    = () => reject(req.error);
    req.onblocked  = () => { console.warn('DB blocked by old tab'); resolve(null); };
  });
}

// â”€â”€ Generic appdata get/set â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function dbGet(key) {
  return new Promise(resolve => {
    if (!DB) { resolve(null); return; }
    const tx  = DB.transaction('appdata','readonly');
    const req = tx.objectStore('appdata').get(key);
    req.onsuccess = () => resolve(req.result ? req.result.value : null);
    req.onerror   = () => resolve(null);
  });
}
function dbSet(key, value) {
  return new Promise(resolve => {
    if (!DB) { resolve(); return; }
    const tx = DB.transaction('appdata','readwrite');
    tx.objectStore('appdata').put({ key, value });
    tx.oncomplete = resolve;
    tx.onerror    = resolve;
  });
}

// â”€â”€ File store â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveFileToDB(id, fileData) {
  return new Promise((resolve, reject) => {
    if (!DB) { resolve(); return; }
    const tx = DB.transaction('files','readwrite');
    tx.objectStore('files').put({ id, ...fileData });
    tx.oncomplete = resolve;
    tx.onerror    = () => reject(tx.error);
  });
}
function getFileFromDB(id) {
  return new Promise(resolve => {
    if (!DB) { resolve(null); return; }
    const tx  = DB.transaction('files','readonly');
    const req = tx.objectStore('files').get(id);
    req.onsuccess = () => resolve(req.result || null);
    req.onerror   = () => resolve(null);
  });
}
function deleteFileFromDB(id) {
  return new Promise(resolve => {
    if (!DB) { resolve(); return; }
    const tx = DB.transaction('files','readwrite');
    tx.objectStore('files').delete(id);
    tx.oncomplete = resolve;
    tx.onerror    = resolve;
  });
}

// â”€â”€ Persist / Load ALL app data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// USERS is persisted so edits (name, password, domain,
// enable/disable, new accounts) survive page refreshes.
async function persistAll() {
  clearTimeout(persistAll._t);
  persistAll._t = setTimeout(async () => {
    await dbSet('projects',     projects);
    await dbSet('tasks',        tasks);
    await dbSet('docs',         docs);
    await dbSet('archNotes',    archNotes);
    await dbSet('projComments', projComments);
    await dbSet('groupChat',    groupChat);
    await dbSet('users_data',   USERS);
    // Broadcast to other tabs that data changed
    SYNC.broadcast('data_changed');
  }, 400);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REAL-TIME SYNC ENGINE
// Uses BroadcastChannel (built-in, free, zero API) so
// multiple tabs/windows of this app stay in sync live.
// Also runs a 3-second polling loop as a fallback for
// browsers that don't support BroadcastChannel.
// Result: any change in one tab appears instantly in all
// other open tabs â€” group chat, tasks, projects, docs.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SYNC = {
  channel: null,
  pollTimer: null,
  lastHash: '',   // detect actual changes

  init() {
    // BroadcastChannel: real-time tab-to-tab messaging
    try {
      this.channel = new BroadcastChannel('px_sync');
      this.channel.onmessage = async (e) => {
        if (!CU) return; // not logged in
        if (e.data?.type === 'data_changed') {
          await this.pullAndRefresh();
        }
      };
    } catch(e) {
      console.warn('BroadcastChannel not supported, using polling only');
    }
    // Polling fallback: check DB every 3 seconds for changes
    this.startPolling();
  },

  broadcast(type) {
    try { this.channel?.postMessage({ type }); } catch(e) {}
  },

  startPolling() {
    clearInterval(this.pollTimer);
    this.pollTimer = setInterval(() => this.pollCheck(), 3000);
  },

  stopPolling() {
    clearInterval(this.pollTimer);
    try { this.channel?.close(); } catch(e) {}
  },

  async pollCheck() {
    if (!CU || !DB) return;
    try {
      // Read a lightweight fingerprint from DB to detect changes
      const saved = await dbGet('groupChat');
      const hash = JSON.stringify(saved?.length) + JSON.stringify(saved?.slice(-1));
      if (hash !== this.lastHash) {
        this.lastHash = hash;
        await this.pullAndRefresh();
      }
    } catch(e) {}
  },

  async pullAndRefresh() {
    if (!CU || !DB) return;
    // Pull fresh data from IndexedDB
    const newProjects     = (await dbGet('projects'))     || [];
    const newTasks        = (await dbGet('tasks'))        || [];
    const newDocs         = (await dbGet('docs'))         || [];
    const newNotes        = (await dbGet('archNotes'))    || [];
    const newComments     = (await dbGet('projComments')) || {};
    const newChat         = (await dbGet('groupChat'))    || [];
    const newUsers        = await dbGet('users_data');

    // Check if anything actually changed before re-rendering
    const changed =
      JSON.stringify(newProjects)  !== JSON.stringify(projects) ||
      JSON.stringify(newTasks)     !== JSON.stringify(tasks)    ||
      JSON.stringify(newDocs)      !== JSON.stringify(docs)     ||
      JSON.stringify(newNotes)     !== JSON.stringify(archNotes)||
      JSON.stringify(newComments)  !== JSON.stringify(projComments) ||
      JSON.stringify(newChat)      !== JSON.stringify(groupChat);

    if (!changed) return;

    // Apply updates
    projects     = newProjects;
    tasks        = newTasks;
    docs         = newDocs;
    archNotes    = newNotes;
    projComments = newComments;
    groupChat    = newChat;
    if (newUsers) {
      for (const un of Object.keys(newUsers)) USERS[un] = newUsers[un];
    }

    // Smart refresh: update only what's visible
    if (page === 'groupchat') {
      // Chat: only update messages, don't destroy the input
      const msgArea = $('chat-messages');
      if (msgArea) {
        msgArea.innerHTML = buildChatMessages();
        msgArea.scrollTop = msgArea.scrollHeight;
      }
    } else {
      // All other pages: full re-render
      renderContent();
      renderTopBar();
    }
    // Update unread badge on chat nav item
    updateChatBadge();
  }
};

let _lastSeenChatCount = 0;
function updateChatBadge() {
  const count = groupChat.length - _lastSeenChatCount;
  const nav = $('bn-groupchat');
  if (nav) {
    const badge = nav.querySelector('.chat-badge');
    if (count > 0 && page !== 'groupchat') {
      if (!badge) {
        const b = document.createElement('span');
        b.className = 'chat-badge';
        b.style.cssText = 'position:absolute;top:2px;right:2px;width:8px;height:8px;background:var(--red);border-radius:50%;';
        nav.style.position = 'relative';
        nav.appendChild(b);
      }
    } else {
      if (badge) badge.remove();
      _lastSeenChatCount = groupChat.length;
    }
  }
  // Also update sidebar chat nav item
  const sbChat = document.querySelector('.nb[onclick*="groupchat"]');
  if (sbChat) {
    const existing = sbChat.querySelector('.chat-dot');
    if (count > 0 && page !== 'groupchat') {
      if (!existing) {
        const dot = document.createElement('span');
        dot.className = 'chat-dot';
        dot.style.cssText = 'width:7px;height:7px;background:var(--red);border-radius:50%;flex-shrink:0;';
        sbChat.appendChild(dot);
      }
    } else {
      existing?.remove();
    }
  }
}

async function loadAll() {
  projects     = (await dbGet('projects'))     || [];
  tasks        = (await dbGet('tasks'))        || [];
  docs         = (await dbGet('docs'))         || [];
  archNotes    = (await dbGet('archNotes'))    || [];
  projComments = (await dbGet('projComments')) || {};
  groupChat    = (await dbGet('groupChat'))    || [];

  // Load saved user overrides. Saved data WINS over hardcoded defaults.
  // This ensures CEO edits (name, domain, password, enable/disable, new accounts)
  // permanently survive refreshes without being overwritten by hardcoded values.
  const savedUsers = await dbGet('users_data');
  if (savedUsers && Object.keys(savedUsers).length > 0) {
    // Completely replace USERS with the saved version, but keep any
    // hardcoded users that weren't in the saved snapshot (new additions to code)
    for (const un of Object.keys(savedUsers)) {
      USERS[un] = savedUsers[un]; // saved data fully wins
    }
    // Add any hardcoded users not yet in saved data
    for (const un of Object.keys(USERS)) {
      if (!savedUsers[un]) {
        // new hardcoded user â€” will be saved next persistAll
      }
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRESET USERS â€” Default/seed data only.
// After first load, USERS is merged with DB-saved changes
// so all edits (name, password, domain, enable/disable,
// new accounts) survive page refreshes permanently.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let USERS = {
  'sumukh.ceo'       : {password:'PrimoraX@CEO2025',    name:'Sumukh Bharadwaj K S', role:'CEO',  domain:'Management',                       avatar:'SB', color:'#7b1fa2', enabled:true},
  'vishal.elec'      : {password:'elec@vishal01',        name:'Vishal Rajoor',         role:'team', domain:'Electronics',                     avatar:'VR', color:'#1565c0', enabled:true},
  'yashas.mech'      : {password:'mech@yashas01',        name:'Yashas Raj',            role:'team', domain:'Mechanical',                      avatar:'YR', color:'#00695c', enabled:true},
  'vaishak.analysis' : {password:'analysis@vaishak01',   name:'Vaishakh Shetty B',     role:'team', domain:'Analysis',                       avatar:'VS', color:'#1976d2', enabled:true},
  'subbaiah.research': {password:'research@subbaiah01',  name:'Thaman Subbaiah',       role:'team', domain:'Research',                       avatar:'TS', color:'#6a1b9a', enabled:true},
  'thilak.media'     : {password:'media@thilak01',       name:'Thilak',                role:'team', domain:'Media',                          avatar:'TM', color:'#c2185b', enabled:true},
  'bindushree.coord' : {password:'coord@bindushree01',   name:'Bindushree H M',        role:'team', domain:'Research',                       avatar:'BH', color:'#6a1b9a', enabled:true},
  'manoj.elec'       : {password:'elec@manoj01',         name:'Manoj Y S',             role:'team', domain:'Electronics Assembly & Testing',  avatar:'MY', color:'#e65100', enabled:true},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let projects = [];
let tasks = [];
let docs = [];
let archNotes = [];
let projComments = {};
let groupChat = [];      // â† Team-wide group chat messages
let uploadedFile = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let CU = null;
let page = 'dashboard';
let selProj = null;
let activeTab = 'overview';
let taskExp = {};
let docOpen = {};
let fStatus = 'All';
let fVis = 'all';
let fTask = 'All';
let selMembers = [];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SC = {Created:'#4fc3f7',Approved:'#56c26a','In Development':'#fcb144',Review:'#cc88e8',Delivered:'#6ee7b7',Archived:'#7a9ab0','In Progress':'#fcb144',Completed:'#6ee7b7','Not Started':'#6b8fae'};
const VC = {'ceo-only':{l:'CEO Only',c:'#f04545',i:'ğŸ‘‘'},'team-only':{l:'Team Only',c:'#42a5f5',i:'ğŸ‘¥'},shared:{l:'Shared',c:'#56c26a',i:'ğŸŒ'}};
const FI = {pdf:'ğŸ“„',xlsx:'ğŸ“Š',docx:'ğŸ“',zip:'ğŸ“¦',png:'ğŸ–¼',jpg:'ğŸ–¼',jpeg:'ğŸ–¼',gif:'ğŸ–¼',mp4:'ğŸ¬',mp3:'ğŸµ',dwg:'ğŸ“',txt:'ğŸ“‹',ppt:'ğŸ“Š',pptx:'ğŸ“Š'};
const QUOTES = {
  CEO:['Full control. Full visibility. Let\'s build something great today.','Every great project starts with a clear plan. You have it.'],
  Electronics:['Great circuits start with great thinking. Ready to design?','Precision in every trace. Let\'s make it count.'],
  Mechanical:['Engineering is the art of making what you want happen. Go for it.','Every component matters. Let\'s get it right.'],
  Analysis:['Data tells the story. You write it.','Insight drives decisions. Ready to dig in?'],
  Research:['Knowledge is the foundation of every great project.','The best research is thorough and clear. Let\'s go.'],
  Media:['Presentation is everything. Make it shine.','Visual communication starts here.'],
  Coordination:['Keeping things moving is an art. You\'ve got this.','Great projects run on great coordination.'],
  Management:['Direction and purpose in every decision.','Leadership is clarity. Let\'s create it.'],
  'Electronics Assembly & Testing':['Precision in assembly is everything. Let\'s test it right.','Great builds start with careful hands and sharp eyes.'],
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const $ = id => document.getElementById(id);
const isCEO = () => CU?.role === 'CEO';
const myProj = () => isCEO() ? projects : projects.filter(p => p.assignedMembers?.includes(CU.username));
const myTasks = () => isCEO() ? tasks : tasks.filter(t => t.assignedTo === CU.username);
function canSee(d) {
  if (isCEO()) return true;
  if (d.visibility === 'ceo-only') return false;
  if (d.visibility === 'team-only') return d.uploadedBy === CU.username;
  if (d.visibility === 'shared') { const p = projects.find(x => x.id === d.projectId); return p?.assignedMembers?.includes(CU.username); }
  return false;
}
function fi(t) { return FI[t?.toLowerCase()] || 'ğŸ“'; }
function fmtD(d) { if (!d) return 'â€”'; return new Date(d).toLocaleDateString('en-IN', {day:'2-digit',month:'short',year:'numeric'}); }
function fmtDT(d) { return new Date(d).toLocaleDateString('en-IN', {weekday:'long',day:'2-digit',month:'long',year:'numeric'}); }
function fmtSize(bytes) {
  if (!bytes) return 'â€”';
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1048576) return (bytes/1024).toFixed(1) + ' KB';
  return (bytes/1048576).toFixed(1) + ' MB';
}
function bdg(label, color, sm) {
  const p = sm ? '2px 7px' : '3px 10px', fs = sm ? '10px' : '11px';
  return `<span class="badge" style="background:${color}1f;color:${color};border:1px solid ${color}40;padding:${p};font-size:${fs};">${label}</span>`;
}
function av(init, sz=36, col='#0d47a1') {
  return `<div class="avatar" style="width:${sz}px;height:${sz}px;background:${col};font-size:${Math.round(sz*.36)}px;color:#fff;">${init}</div>`;
}
function pb(val, col='#1976d2') {
  return `<div class="pbar-wrap"><div class="pbar" style="width:${val}%;background:${col};"></div></div>`;
}
function gid(p) { return p + '-' + Date.now().toString().slice(-5); }
function greetWord() {
  const h = new Date().getHours();
  if (h < 12) return 'Good morning';
  if (h < 17) return 'Good afternoon';
  return 'Good evening';
}
function notify(msg, type='ok') {
  const n = $('notif');
  n.textContent = (type==='err' ? 'âš  ' : 'âœ“ ') + msg;
  n.className = type === 'err' ? 'err' : '';
  n.style.display = 'block';
  clearTimeout(n._t);
  n._t = setTimeout(() => n.style.display = 'none', 3200);
}
function toggleSB() { $('sidebar').classList.toggle('open'); $('sb-overlay').classList.toggle('on'); }
function closeSB() { $('sidebar').classList.remove('open'); $('sb-overlay').classList.remove('on'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH â€” Secure login with rate limiting + Remember Me
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _rmOn = false;
function toggleRM() {
  _rmOn = !_rmOn;
  const tog = $('rm-toggle');
  const knob = $('rm-knob');
  const lbl = $('rm-on');
  if (_rmOn) {
    tog.style.background  = 'rgba(26,114,212,.35)';
    tog.style.borderColor = 'var(--blue2)';
    knob.style.left       = '17px';
    knob.style.background = 'var(--blue3)';
    if (lbl) lbl.style.display = 'inline';
  } else {
    tog.style.background  = 'var(--bg5)';
    tog.style.borderColor = 'var(--border2)';
    knob.style.left       = '1px';
    knob.style.background = 'var(--text5)';
    if (lbl) lbl.style.display = 'none';
  }
}

function togglePW() {
  const p = $('l-pass'), e = $('l-eye');
  p.type = p.type === 'password' ? 'text' : 'password';
  e.textContent = p.type === 'password' ? 'ğŸ‘' : 'ğŸ™ˆ';
}
$('l-pass').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
$('l-user').addEventListener('keydown', e => { if (e.key === 'Enter') $('l-pass').focus(); });

async function doLogin() {
  const un  = $('l-user').value.trim().toLowerCase();
  const pw  = $('l-pass').value;
  const errEl  = $('l-err');
  const lockEl = $('l-lock');

  // Check lockout
  const lockRemain = getLockRemain(un);
  if (lockRemain > 0) {
    lockEl.style.display = 'block';
    lockEl.textContent   = `â± Too many failed attempts. Try again in ${lockRemain}s.`;
    // Countdown ticker
    const ticker = setInterval(() => {
      const r = getLockRemain(un);
      if (r <= 0) { clearInterval(ticker); lockEl.style.display = 'none'; }
      else lockEl.textContent = `â± Too many failed attempts. Try again in ${r}s.`;
    }, 1000);
    return;
  }

  const u = USERS[un];
  if (u && u.password === pw && u.enabled !== false) {
    clearFail(un);
    CU = { username: un, ...u };
    _rememberMe = _rmOn;
    await createSession(un, _rmOn);
    await loadAll(); // pull permanent data from IndexedDB
    showScreen('s-welcome');
    buildWelcome();
  } else {
    const fails = incFail(un);
    const remaining = SEC.MAX_FAILS - fails;
    errEl.style.display = 'block';
    if (remaining > 0) {
      errEl.textContent = `âš  Invalid credentials. ${remaining} attempt${remaining!==1?'s':''} remaining.`;
    } else {
      errEl.textContent = `â›” Account temporarily locked for ${SEC.LOCK_SECS} seconds.`;
    }
    setTimeout(() => errEl.style.display = 'none', 4000);
    // Shake the card
    const card = document.querySelector('.login-card');
    card.style.animation = 'none';
    card.offsetHeight; // reflow
    card.style.animation = 'shake .4s ease';
  }
}

async function doLogout() {
  stopInactivityWatch();
  SYNC.stopPolling();
  clearSession();
  CU = null; selProj = null; page = 'dashboard';
  projects = []; tasks = []; docs = []; archNotes = []; projComments = {}; groupChat = [];
  _lastSeenChatCount = 0;
  showScreen('s-login');
  $('l-user').value = ''; $('l-pass').value = '';
  _rmOn = false;
  const tog = $('rm-toggle'), knob = $('rm-knob'), lbl = $('rm-on');
  if (tog) { tog.style.background='var(--bg5)';tog.style.borderColor='var(--border2)'; }
  if (knob) { knob.style.left='1px';knob.style.background='var(--text5)'; }
  if (lbl) lbl.style.display='none';
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  $(id).classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WELCOME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildWelcome() {
  const u = CU;
  const mp = myProj(), mt = myTasks();
  const overdue = mt.filter(t => t.deadline && new Date(t.deadline) < new Date() && t.status !== 'Completed').length;

  const av_el = $('wc-av');
  av_el.textContent = u.avatar;
  av_el.style.background = `linear-gradient(145deg, ${u.color}, ${u.color}cc)`;
  av_el.style.boxShadow = `0 12px 40px ${u.color}55, 0 0 0 4px ${u.color}22`;

  $('wc-time').textContent = greetWord() + ',';
  $('wc-greet').textContent = u.name.split(' ')[0] + ' ğŸ‘‹';
  $('wc-full').textContent = u.role === 'CEO' ? 'Sumukh Bharadwaj K S Â· CEO & Founder' : `${u.name} Â· ${u.domain}`;

  const rb = $('wc-role-badge');
  rb.className = 'wc-role ' + (isCEO() ? 'ceo' : 'team');
  rb.textContent = isCEO() ? 'ğŸ‘‘ CEO Â· Full Access' : `${u.domain}`;

  const facts = isCEO() ? [
    {val: projects.length, lbl: 'Projects'},
    {val: tasks.filter(t=>t.status==='In Progress').length, lbl: 'Active'},
    {val: 'â‚¹' + projects.reduce((s,p)=>s+(p.revenue||0),0).toLocaleString('en-IN'), lbl: 'Revenue'},
    {val: docs.length, lbl: 'Docs'},
  ] : [
    {val: mp.length, lbl: 'My Projects'},
    {val: mt.filter(t=>t.status==='In Progress').length, lbl: 'Active'},
    {val: mt.filter(t=>t.status==='Completed').length, lbl: 'Done'},
    {val: overdue > 0 ? overdue : 'âœ“', lbl: overdue > 0 ? 'Overdue' : 'On Track'},
  ];
  $('wc-facts').innerHTML = facts.map(f =>
    `<div class="wc-fact"><div class="wc-fact-val">${f.val}</div><div class="wc-fact-lbl">${f.lbl}</div></div>`
  ).join('');

  const qList = QUOTES[u.domain] || QUOTES.Management;
  $('wc-quote').textContent = '"' + qList[Math.floor(Math.random() * qList.length)] + '"';
  $('wc-date').textContent = fmtDT(new Date());
}

function enterApp() {
  showScreen('s-app');
  initApp();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initApp() {
  const mb = $('menu-btn');
  if (window.innerWidth <= 768) mb.style.display = 'flex';
  startInactivityWatch();
  SYNC.init();
  renderSidebar();
  renderTopBar();
  navigate('dashboard');
}

function navigate(p, proj) {
  page = p;
  if (p !== 'proj-detail') selProj = null;
  if (proj) selProj = proj;
  activeTab = 'overview'; taskExp = {}; docOpen = {};
  fStatus = 'All'; fVis = 'all'; fTask = 'All';

  // When entering chat, mark all messages as seen
  if (p === 'groupchat') {
    _lastSeenChatCount = groupChat.length;
    updateChatBadge();
  }

  const c = $('content');
  if (p === 'groupchat') {
    c.style.cssText = 'padding:0;overflow:hidden;display:flex;flex-direction:column;flex:1;';
  } else {
    c.style.cssText = '';
  }

  renderTopBar(); renderSidebar(); updateBottomNav();
  c.innerHTML = '';
  setTimeout(() => renderContent(), 10);
  closeSB();
}

function updateBottomNav() {
  ['dashboard','projects','tasks','groupchat'].forEach(id => {
    const el = $('bn-'+id);
    if (el) el.classList.toggle('active', page === id || (id === 'projects' && page === 'proj-detail'));
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIDEBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSidebar() {
  const navItems = [
    {id:'dashboard', icon:'â—ˆ', label:'Dashboard'},
    {id:'projects',  icon:'â¬¡', label:'Projects'},
    {id:'tasks',     icon:'â—', label:'Tasks'},
    {id:'documents', icon:'â–£', label:'Documents'},
    {id:'groupchat', icon:'ğŸ’¬', label:'Group Chat'},
    {id:'architecture', icon:'â¬¢', label:'Architecture'},
    ...(isCEO() ? [
      {id:'finance',  icon:'â—†', label:'Finance',  ceo:true},
      {id:'delivery', icon:'â–¶', label:'Delivery', ceo:true},
      {id:'users',    icon:'â—‰', label:'Users',    ceo:true},
    ] : []),
  ];
  const isActive = id => page === id || (page === 'proj-detail' && id === 'projects');
  $('sb-nav').innerHTML = `
    <div class="sb-section">Navigation</div>
    ${navItems.map(n => `
    <button class="nb${isActive(n.id)?' active':''}" onclick="navigate('${n.id}')">
      <span class="ni">${n.icon}</span>
      <span class="nl">${n.label}</span>
      ${n.ceo ? `<span class="nt">CEO</span>` : ''}
    </button>`).join('')}`;

  const col = CU.role === 'CEO' ? '#7b1fa2' : CU.color;
  $('sb-user').innerHTML = `
    <div class="sb-user-row">
      ${av(CU.avatar, 36, col)}
      <div style="min-width:0;">
        <div class="sb-uname">${CU.name.split(' ').slice(0,2).join(' ')}</div>
        <div class="sb-urole">${isCEO() ? 'ğŸ‘‘ CEO' : CU.domain}</div>
      </div>
    </div>
    <button class="btn-signout" onclick="doLogout()">Sign Out</button>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOPBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTopBar() {
  const labels = {
    dashboard: 'Dashboard', projects: 'Projects',
    'proj-detail': selProj ? `${selProj.id}` : 'Project',
    tasks: 'Tasks', documents: 'Documents', finance: 'Finance',
    users: 'Users', delivery: 'Delivery', architecture: 'Architecture',
    groupchat: 'Group Chat',
  };
  $('tb-title').textContent = labels[page] || 'â€”';
  $('tb-date').textContent = new Date().toLocaleDateString('en-IN', {weekday:'short',day:'2-digit',month:'short',year:'numeric'});
  $('tb-right').innerHTML = isCEO()
    ? `${bdg('ğŸ‘‘ CEO','#cc88e8',true)}`
    : `${bdg(CU.domain.split(' ')[0],'#4ec4fc',true)}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderContent() {
  const c = $('content');
  if (page === 'groupchat') {
    // Chat must fill the entire content area with NO wrapper padding
    c.innerHTML = renderGroupChat();
    afterChatRender();
  } else {
    const map = {
      dashboard: renderDashboard,
      projects: renderProjects,
      'proj-detail': renderProjDetail,
      tasks: renderTasksPage,
      documents: renderDocsPage,
      finance: isCEO() ? renderFinance : renderDashboard,
      users: isCEO() ? renderUsers : renderDashboard,
      delivery: isCEO() ? renderDelivery : renderDashboard,
      architecture: renderArchitecture,
    };
    c.innerHTML = `<div class="page">${(map[page] || renderDashboard)()}</div>`;
  }
}

// â”€â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDashboard() {
  const mp = myProj(), mt = myTasks(), md = docs.filter(canSee);
  const stats = isCEO() ? [
    {icon:'â¬¡', val:projects.length, lbl:'Total Projects', color:'var(--blue3)'},
    {icon:'â—', val:tasks.filter(t=>t.status==='In Progress').length, lbl:'Active Tasks', color:'var(--amber)'},
    {icon:'â–£', val:docs.length, lbl:'Documents', color:'var(--green)'},
    {icon:'â—†', val:'â‚¹'+projects.reduce((s,p)=>s+(p.revenue||0),0).toLocaleString('en-IN'), lbl:'Revenue', color:'var(--purple)'},
  ] : [
    {icon:'â¬¡', val:mp.length, lbl:'My Projects', color:'var(--blue3)'},
    {icon:'â—', val:mt.filter(t=>t.status==='In Progress').length, lbl:'In Progress', color:'var(--amber)'},
    {icon:'âœ“', val:mt.filter(t=>t.status==='Completed').length, lbl:'Completed', color:'var(--green)'},
    {icon:'â–£', val:md.length, lbl:'My Docs', color:'var(--purple)'},
  ];
  return `
  <div style="margin-bottom:20px;">
    <div style="font-family:var(--fd);font-weight:800;font-size:20px;color:var(--text);letter-spacing:-.03em;">${isCEO()?'ğŸ‘‘ ':''}${greetWord()}, ${CU.name.split(' ')[0]}</div>
    <div style="font-size:12px;color:var(--text4);margin-top:4px;">${isCEO()?'Full system overview':'Your current work status'}</div>
  </div>
  <div class="g4" style="margin-bottom:22px;">
    ${stats.map(s=>`
    <div class="stat-card">
      <div class="stat-icon">${s.icon}</div>
      <div class="stat-val" style="color:${s.color};">${s.val}</div>
      <div class="stat-lbl">${s.lbl}</div>
    </div>`).join('')}
  </div>
  <div class="g2">
    <div class="card" style="padding:16px 18px;">
      <div class="flex-between" style="margin-bottom:12px;">
        <div class="section-head" style="margin:0;">${isCEO()?'All Projects':'My Projects'}</div>
        <button class="btn-sm" onclick="navigate('projects')">View all â†’</button>
      </div>
      ${mp.slice(0,4).map(p=>`
      <div class="proj-card" style="padding:11px 13px;" onclick="openProj('${p.id}')">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
          <div style="min-width:0;">
            <div style="font-size:10px;color:var(--blue3);font-family:var(--fm);font-weight:600;margin-bottom:3px;">${p.id} Â· ${p.branch}</div>
            <div style="font-size:13px;font-weight:600;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${p.title}</div>
          </div>
          ${bdg(p.status, SC[p.status]||'#78909c', true)}
        </div>
        <div style="margin-top:8px;">${pb(tasks.filter(t=>t.projectId===p.id).reduce((s,t,_,a)=>s+(a.length?t.progress/a.length:0),0)||0, SC[p.status]||'#1976d2')}</div>
      </div>`).join('')}
      ${mp.length===0?'<div class="empty"><span class="empty-icon">ğŸ“‚</span>No projects assigned</div>':''}
    </div>
    <div class="card" style="padding:16px 18px;">
      <div class="flex-between" style="margin-bottom:12px;">
        <div class="section-head" style="margin:0;">${isCEO()?'Recent Tasks':'My Tasks'}</div>
        <button class="btn-sm" onclick="navigate('tasks')">View all â†’</button>
      </div>
      ${mt.slice(0,4).map(t=>{
        const proj=projects.find(p=>p.id===t.projectId);
        return `
        <div style="padding:11px 12px;background:var(--bg4);border-radius:9px;margin-bottom:7px;border:1px solid var(--border);">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;gap:8px;">
            <div style="font-size:13px;font-weight:500;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${t.title}</div>
            ${bdg(t.status,SC[t.status]||'#78909c',true)}
          </div>
          <div style="font-size:10px;color:var(--text4);font-family:var(--fm);margin-bottom:6px;">${proj?.id||''} Â· Due ${fmtD(t.deadline)}</div>
          <div style="display:flex;align-items:center;gap:8px;">${pb(t.progress,SC[t.status]||'#1976d2')}<span style="font-size:10px;color:var(--blue3);font-family:var(--fm);flex-shrink:0;">${t.progress}%</span></div>
        </div>`;
      }).join('')}
      ${mt.length===0?'<div class="empty"><span class="empty-icon">âœ“</span>No tasks assigned</div>':''}
    </div>
  </div>`;
}

// â”€â”€â”€ PROJECTS LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderProjects() {
  const mp = myProj();
  const filt = fStatus==='All' ? mp : mp.filter(p=>p.status===fStatus);
  return `
  <div class="flex-between" style="margin-bottom:16px;gap:10px;">
    <div class="filter-bar" style="margin:0;flex:1;">
      ${['All','Created','Approved','In Development','Review','Delivered','Archived'].map(s=>`
      <button class="fbtn${fStatus===s?' on':''}" onclick="setFS('${s}')">${s}</button>`).join('')}
    </div>
    ${isCEO()?`<button class="btn-p" onclick="mCreateProj()" style="flex-shrink:0;">+ New</button>`:''}
  </div>
  ${filt.map(p=>projCard(p)).join('')}
  ${filt.length===0?'<div class="empty"><span class="empty-icon">ğŸ”</span>No projects found</div>':''}`;
}
function setFS(s){fStatus=s;renderContent();}
function openProj(id){const p=projects.find(x=>x.id===id);if(p){selProj=p;page='proj-detail';activeTab='overview';renderTopBar();renderSidebar();updateBottomNav();renderContent();}}
function projCard(p){
  const members=(p.assignedMembers||[]).slice(0,4).map((un,i)=>{
    const u=USERS[un];return u?`<div style="margin-left:${i>0?'-8px':'0'};z-index:${4-i};position:relative;" title="${u.name}">${av(u.avatar,26,u.color)}</div>`:'';}).join('');
  const prog=tasks.filter(t=>t.projectId===p.id);
  const overall=prog.length?Math.round(prog.reduce((s,t)=>s+t.progress,0)/prog.length):0;
  return `
  <div class="proj-card" onclick="openProj('${p.id}')">
    <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;">
      <div style="flex:1;min-width:0;">
        <div style="display:flex;align-items:center;gap:7px;flex-wrap:wrap;margin-bottom:5px;">
          <span style="font-size:11px;color:var(--blue3);font-family:var(--fm);font-weight:600;">${p.id}</span>
          ${bdg(p.status,SC[p.status]||'#78909c',true)}
          ${bdg(p.branch,'#546e8a',true)}
        </div>
        <div style="font-family:var(--fd);font-weight:700;font-size:14px;color:var(--text);margin-bottom:5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${p.title}</div>
        <div style="font-size:12px;color:var(--text4);margin-bottom:9px;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;">${p.description}</div>
        <div style="display:flex;align-items:center;gap:8px;">${pb(overall,SC[p.status]||'#1976d2')}<span style="font-size:10px;color:var(--text4);font-family:var(--fm);flex-shrink:0;">${overall}%</span></div>
        <div style="display:flex;gap:12px;font-size:11px;color:var(--text4);font-family:var(--fm);flex-wrap:wrap;margin-top:7px;">
          <span>ğŸ“… ${fmtD(p.deadline)}</span>
          <span>ğŸ‘¥ ${(p.assignedMembers||[]).length}</span>
          ${isCEO()?`<span style="color:var(--purple);">â‚¹${(p.budget||0).toLocaleString('en-IN')}</span>`:''}
        </div>
      </div>
      <div style="display:flex;align-items:center;flex-shrink:0;margin-top:4px;">${members}</div>
    </div>
  </div>`;
}

// â”€â”€â”€ PROJECT DETAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderProjDetail() {
  if(!selProj)return'<div class="empty">No project selected</div>';
  const p=selProj;
  const tabs=['overview','tasks','documents','comments'];
  if(isCEO())tabs.push('payments');
  let body='';
  if(activeTab==='overview')body=tabOverview(p);
  else if(activeTab==='tasks')body=tabTasks(p);
  else if(activeTab==='documents')body=tabDocs(p);
  else if(activeTab==='comments')body=tabComments(p);
  else if(activeTab==='payments')body=tabPayments(p);
  return `
  <button class="back-btn" onclick="navigate('projects')">â† Back</button>
  <div class="flex-between" style="margin-bottom:16px;">
    <div>
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:5px;">
        <span style="font-family:var(--fm);font-size:11px;color:var(--blue3);font-weight:600;">${p.id}</span>
        ${bdg(p.status,SC[p.status]||'#78909c')}
        ${bdg(p.branch,'#546e8a',true)}
      </div>
      <h2 style="font-family:var(--fd);font-weight:800;font-size:17px;color:var(--text);letter-spacing:-.02em;line-height:1.3;">${p.title}</h2>
    </div>
    <div style="display:flex;gap:7px;flex-wrap:wrap;">
      ${isCEO()?`<button class="btn-s" onclick="mStatusChange()" style="padding:8px 12px;font-size:12px;">Status</button>`:''}
      <button class="btn-s" onclick="mUploadDoc('${p.id}')" style="padding:8px 12px;font-size:12px;">+ Upload</button>
      ${isCEO()?`<button class="btn-p" onclick="mCreateTask('${p.id}')" style="padding:8px 12px;font-size:12px;">+ Task</button>`:''}
    </div>
  </div>
  <div class="tabs">
    ${tabs.map(t=>`<button class="tab${activeTab===t?' on':''}" onclick="setTab('${t}')">${t}</button>`).join('')}
  </div>
  ${body}`;
}
function setTab(t){activeTab=t;renderContent();}

function tabOverview(p){
  const pt=tasks.filter(t=>t.projectId===p.id);
  const overall=pt.length?Math.round(pt.reduce((s,t)=>s+t.progress,0)/pt.length):0;
  return `
  <div class="g2">
    <div class="card" style="padding:16px 18px;">
      <div class="section-head">Project Info</div>
      <div class="irow"><span class="ilabel">Type</span><span class="ival">${p.type}</span></div>
      <div class="irow"><span class="ilabel">Branch</span><span class="ival">${p.branch}</span></div>
      <div class="irow"><span class="ilabel">Year</span><span class="ival">${p.year}</span></div>
      <div class="irow"><span class="ilabel">Created</span><span class="ival">${fmtD(p.createdAt)}</span></div>
      <div class="irow"><span class="ilabel">Deadline</span><span class="ival">${fmtD(p.deadline)}</span></div>
      ${isCEO()?`<div class="irow"><span class="ilabel">Budget</span><span class="ival" style="color:var(--purple);">â‚¹${(p.budget||0).toLocaleString('en-IN')}</span></div>`:''}
      <div style="margin-top:12px;padding-top:10px;border-top:1px solid var(--border);">
        <div style="font-size:10px;color:var(--text4);font-family:var(--fm);text-transform:uppercase;margin-bottom:6px;">Overall Progress</div>
        ${pb(overall,'#4ec4fc')}
        <div style="text-align:right;font-size:11px;color:var(--blue3);font-family:var(--fm);margin-top:4px;">${overall}%</div>
      </div>
    </div>
    <div class="card" style="padding:16px 18px;">
      <div class="section-head">Team</div>
      ${(p.assignedMembers||[]).map(un=>{const u=USERS[un];return u?`
      <div style="display:flex;align-items:center;gap:10px;padding:9px 11px;background:var(--bg4);border-radius:9px;margin-bottom:7px;border:1px solid var(--border);">
        ${av(u.avatar,30,u.color)}
        <div><div style="font-size:13px;font-weight:500;color:var(--text2);">${u.name}</div><div style="font-size:10px;color:var(--text4);font-family:var(--fm);">${u.domain}</div></div>
      </div>`:''}).join('')}
      ${(p.assignedMembers||[]).length===0?'<div style="color:var(--text5);font-size:12px;">No members assigned</div>':''}
    </div>
    <div class="card" style="padding:16px 18px;grid-column:span 2;">
      <div class="section-head">Description & Requirements</div>
      <p style="font-size:13px;color:var(--text3);line-height:1.75;margin-bottom:12px;">${p.description||'â€”'}</p>
      <div style="font-size:10px;color:var(--text4);font-family:var(--fm);text-transform:uppercase;margin-bottom:6px;">Requirements</div>
      <p style="font-size:13px;color:var(--text3);line-height:1.7;">${p.requirements||'â€”'}</p>
    </div>
  </div>`;
}

function tabTasks(p){
  const pt=isCEO()?tasks.filter(t=>t.projectId===p.id):tasks.filter(t=>t.projectId===p.id&&t.assignedTo===CU.username);
  if(!pt.length)return`<div class="empty"><span class="empty-icon">ğŸ“‹</span>${isCEO()?'No tasks yet. Add one above.':'No tasks assigned to you here.'}</div>`;
  return pt.map(t=>taskCard(t)).join('');
}

function taskCard(t){
  const u=USERS[t.assignedTo];
  const canEdit=isCEO()||t.assignedTo===CU.username;
  const exp=taskExp[t.id];
  const overdueFlag = t.deadline && new Date(t.deadline)<new Date() && t.status!=='Completed';
  return `
  <div class="task-card">
    <div class="tc-head" onclick="toggleTE('${t.id}')">
      <div style="display:flex;align-items:center;gap:10px;">
        <div style="flex:1;min-width:0;">
          <div style="display:flex;align-items:center;gap:7px;flex-wrap:wrap;margin-bottom:4px;">
            <span style="font-size:10px;color:var(--blue3);font-family:var(--fm);font-weight:600;">${t.id}</span>
            ${bdg(t.status,SC[t.status]||'#78909c',true)}
            ${overdueFlag?bdg('Overdue','#f04545',true):''}
          </div>
          <div style="font-size:14px;font-weight:600;color:var(--text2);margin-bottom:7px;">${t.title}</div>
          <div style="display:flex;align-items:center;gap:8px;">${pb(t.progress,SC[t.status]||'#1976d2')}<span style="font-size:10px;color:var(--blue3);font-family:var(--fm);flex-shrink:0;">${t.progress}%</span></div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:5px;margin-left:8px;flex-shrink:0;">
          ${u?av(u.avatar,30,u.color):''}
          <span style="font-size:10px;color:var(--text5);font-family:var(--fm);">Due ${fmtD(t.deadline)}</span>
        </div>
        <span style="color:var(--text5);font-size:12px;margin-left:6px;">${exp?'â–²':'â–¼'}</span>
      </div>
    </div>
    ${exp?`
    <div class="tc-body">
      ${canEdit?`
      <div style="margin-bottom:14px;padding:12px 13px;background:var(--bg4);border-radius:9px;border:1px solid var(--border);">
        <div style="font-size:10px;color:var(--text4);font-family:var(--fm);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;">Update Progress</div>
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
          <input type="range" min="0" max="100" value="${t.progress}" oninput="updTP('${t.id}',this.value);this.nextElementSibling.textContent=this.value+'%'" style="flex:1;accent-color:var(--blue2);height:20px;">
          <span style="font-size:12px;color:var(--blue3);font-family:var(--fm);width:38px;flex-shrink:0;">${t.progress}%</span>
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;">
          ${['Not Started','In Progress','Review','Completed'].map(s=>`
          <button onclick="updTS('${t.id}','${s}')" style="padding:7px 11px;border-radius:6px;font-size:11px;font-family:var(--fm);background:${t.status===s?'var(--blue)':'var(--bg3)'};color:${t.status===s?'#fff':'var(--text3)'};border:1px solid ${t.status===s?'var(--blue2)':'var(--border2)'};min-height:36px;">${s}</button>`).join('')}
        </div>
      </div>`:''}
      <div style="font-size:10px;color:var(--text4);font-family:var(--fm);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;">Internal Notes</div>
      ${(t.notes||[]).map(n=>`
      <div class="note-item">
        <div style="display:flex;justify-content:space-between;margin-bottom:4px;flex-wrap:wrap;gap:6px;">
          <span style="font-size:11px;font-weight:600;color:var(--text2);">${n.name}</span>
          <span style="font-size:10px;color:var(--text5);font-family:var(--fm);">${n.ts}</span>
        </div>
        <div style="font-size:12px;color:var(--text3);line-height:1.55;">${n.text}</div>
      </div>`).join('')}
      <div style="display:flex;gap:8px;margin-top:8px;">
        <input class="inp-sm" id="ni-${t.id}" placeholder="Write a noteâ€¦" style="flex:1;" onkeydown="if(event.key==='Enter')addNote('${t.id}')">
        <button class="btn-p" style="padding:10px 14px;font-size:12px;" onclick="addNote('${t.id}')">Add</button>
      </div>
    </div>`:''}
  </div>`;
}

function tabDocs(p){
  const pd=docs.filter(d=>d.projectId===p.id&&canSee(d));
  if(!pd.length)return`<div class="empty"><span class="empty-icon">ğŸ“</span>No documents yet. Tap "+ Upload" above.</div>`;
  return pd.map(d=>docCard(d)).join('');
}

function docCard(d){
  const vc=VC[d.visibility]||VC.shared;
  const t=tasks.find(x=>x.id===d.taskId);
  const u=USERS[d.uploadedBy];
  const op=docOpen[d.id];
  return `
  <div class="doc-card">
    <div style="display:flex;align-items:flex-start;gap:12px;">
      <span style="font-size:28px;margin-top:2px;flex-shrink:0;">${fi(d.type)}</span>
      <div style="flex:1;min-width:0;">
        <div style="display:flex;align-items:center;gap:7px;flex-wrap:wrap;margin-bottom:5px;">
          <span style="font-size:13px;font-weight:600;color:var(--text2);word-break:break-all;">${d.name}</span>
          ${d.approved?bdg('âœ“ Approved','#56c26a',true):''}
          ${d.locked?bdg('ğŸ”’ Locked','#f04545',true):''}
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin-bottom:8px;">
          <span style="font-size:10px;background:${vc.c}1a;color:${vc.c};border:1px solid ${vc.c}3a;padding:2px 8px;border-radius:4px;font-family:var(--fm);font-weight:600;">${vc.i} ${vc.l}</span>
          <span style="font-size:10px;color:var(--text4);font-family:var(--fm);">v${d.version} Â· ${d.size}</span>
          <span style="font-size:10px;color:var(--text5);font-family:var(--fm);">by ${u?.name?.split(' ')[0]||d.uploadedBy}</span>
          ${t?`<span style="font-size:10px;color:var(--text4);font-family:var(--fm);">ğŸ“Œ ${t.title}</span>`:''}
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;">
          <button class="btn-icon" onclick="toggleDC('${d.id}')" style="font-size:12px;">ğŸ’¬ ${(d.comments||[]).length}</button>
          ${d.hasFile?`<button class="btn-icon" onclick="downloadDoc('${d.id}')" style="font-size:12px;color:var(--green);">â¬‡ Download</button>`:''}
          ${isCEO()?`
          <button class="btn-icon" title="${d.approved?'Revoke':'Approve'}" onclick="togApprove('${d.id}')" style="color:${d.approved?'var(--green)':'var(--text3)'};">âœ“</button>
          <button class="btn-icon" title="${d.locked?'Unlock':'Lock'}" onclick="togLock('${d.id}')" style="color:${d.locked?'var(--red)':'var(--text3)'};">ğŸ”’</button>
          <select onchange="chVis('${d.id}',this.value)" style="background:var(--bg4);border:1px solid var(--border2);border-radius:6px;color:var(--text3);font-size:11px;padding:7px 8px;font-family:var(--fm);min-height:36px;">
            <option value="ceo-only"${d.visibility==='ceo-only'?' selected':''}>ğŸ‘‘ CEO</option>
            <option value="team-only"${d.visibility==='team-only'?' selected':''}>ğŸ‘¥ Team</option>
            <option value="shared"${d.visibility==='shared'?' selected':''}>ğŸŒ Shared</option>
          </select>
          <button class="btn-icon" onclick="delDoc('${d.id}')" style="color:var(--red);">ğŸ—‘</button>`:''}
        </div>
      </div>
    </div>
    ${op?`
    <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);">
      ${(d.comments||[]).map(c=>`
      <div class="note-item" style="margin-bottom:7px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:3px;flex-wrap:wrap;gap:6px;">
          <span style="font-size:11px;font-weight:600;color:var(--text2);">${c.name}</span>
          <span style="font-size:10px;color:var(--text5);font-family:var(--fm);">${c.ts}</span>
        </div>
        <div style="font-size:12px;color:var(--text3);">${c.text}</div>
      </div>`).join('')}
      <div style="display:flex;gap:8px;">
        <input class="inp-sm" id="dc-${d.id}" placeholder="Add a commentâ€¦" style="flex:1;" onkeydown="if(event.key==='Enter')addDC('${d.id}')">
        <button class="btn-p" style="padding:10px 14px;font-size:12px;" onclick="addDC('${d.id}')">Send</button>
      </div>
    </div>`:''}
  </div>`;
}

function tabComments(p){
  const cm=projComments[p.id]||[];
  return `
  <div style="margin-bottom:12px;">
    ${cm.map(c=>`
    <div class="cmt-item">
      ${av(USERS[c.by]?.avatar||'??',34,USERS[c.by]?.color||'#1565c0')}
      <div style="flex:1;min-width:0;">
        <div style="display:flex;justify-content:space-between;margin-bottom:5px;flex-wrap:wrap;gap:6px;">
          <span style="font-size:12px;font-weight:600;color:var(--text2);">${c.name}</span>
          <span style="font-size:10px;color:var(--text5);font-family:var(--fm);">${c.ts}</span>
        </div>
        <div style="font-size:13px;color:var(--text3);line-height:1.65;">${c.text}</div>
      </div>
    </div>`).join('')}
    ${cm.length===0?'<div class="empty" style="margin-bottom:12px;"><span class="empty-icon">ğŸ’¬</span>No comments yet.</div>':''}
  </div>
  <div style="display:flex;gap:10px;">
    ${av(CU.avatar,36,CU.color)}
    <input class="inp-sm" id="pc-inp" placeholder="Write a commentâ€¦" style="flex:1;" onkeydown="if(event.key==='Enter')addPC('${p.id}')">
    <button class="btn-p" onclick="addPC('${p.id}')">Post</button>
  </div>`;
}

function tabPayments(p){
  const paid=(p.payments||[]).filter(x=>x.status==='Paid').reduce((s,x)=>s+Number(x.amount),0);
  const pend=(p.payments||[]).filter(x=>x.status==='Pending').reduce((s,x)=>s+Number(x.amount),0);
  const profit=(p.revenue||0)-(p.cost||0);
  return `
  <div class="g3" style="margin-bottom:16px;">
    <div class="stat-card"><div class="stat-icon">ğŸ’°</div><div class="stat-val" style="color:var(--blue3);">â‚¹${(p.budget||0).toLocaleString('en-IN')}</div><div class="stat-lbl">Budget</div></div>
    <div class="stat-card"><div class="stat-icon">âœ…</div><div class="stat-val" style="color:var(--green);">â‚¹${paid.toLocaleString('en-IN')}</div><div class="stat-lbl">Received</div></div>
    <div class="stat-card"><div class="stat-icon">â³</div><div class="stat-val" style="color:var(--amber);">â‚¹${pend.toLocaleString('en-IN')}</div><div class="stat-lbl">Pending</div></div>
  </div>
  <div class="g2" style="margin-bottom:20px;">
    <div class="stat-card"><div class="stat-icon">ğŸ“ˆ</div><div class="stat-val" style="color:var(--purple);">â‚¹${(p.revenue||0).toLocaleString('en-IN')}</div><div class="stat-lbl">Revenue</div></div>
    <div class="stat-card"><div class="stat-icon">ğŸ’¹</div><div class="stat-val" style="color:${profit>=0?'var(--green)':'var(--red)'};">â‚¹${profit.toLocaleString('en-IN')}</div><div class="stat-lbl">Net Profit</div></div>
  </div>
  <div class="flex-between" style="margin-bottom:12px;">
    <div class="section-head" style="margin:0;">Payment Stages</div>
    <button class="btn-p" onclick="mAddPayment('${p.id}')">+ Add Stage</button>
  </div>
  ${(p.payments||[]).map((pay,i)=>`
  <div class="pay-row">
    <div>
      <div style="font-size:13px;font-weight:600;color:var(--text2);">${pay.stage}</div>
      ${pay.date?`<div style="font-size:11px;color:var(--text4);font-family:var(--fm);margin-top:2px;">${fmtD(pay.date)}</div>`:''}
    </div>
    <div style="display:flex;align-items:center;gap:10px;">
      <span style="font-family:var(--fd);font-weight:700;font-size:14px;color:var(--purple);">â‚¹${Number(pay.amount).toLocaleString('en-IN')}</span>
      <button onclick="togPay('${p.id}',${i})" style="padding:8px 13px;border-radius:6px;font-size:11px;font-family:var(--fm);background:${pay.status==='Paid'?'rgba(22,80,28,.5)':'var(--bg4)'};border:1px solid ${pay.status==='Paid'?'rgba(86,194,106,.3)':'var(--border2)'};color:${pay.status==='Paid'?'var(--green)':'var(--text3)'};min-height:38px;">${pay.status==='Paid'?'âœ“ Paid':'Pending'}</button>
    </div>
  </div>`).join('')}`;
}

// â”€â”€â”€ TASKS PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTasksPage(){
  const mt=myTasks();
  const filt=fTask==='All'?mt:mt.filter(t=>t.status===fTask);
  return `
  <div class="filter-bar">
    ${['All','Not Started','In Progress','Review','Completed'].map(s=>`<button class="fbtn${fTask===s?' on':''}" onclick="setFT('${s}')">${s}</button>`).join('')}
  </div>
  ${filt.map(t=>{
    const proj=projects.find(p=>p.id===t.projectId);
    const overdueFlag = t.deadline && new Date(t.deadline)<new Date() && t.status!=='Completed';
    const canEdit=isCEO()||t.assignedTo===CU.username;
    return `
    <div style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--r12);padding:14px 16px;margin-bottom:9px;">
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:7px;">
        <span style="font-size:10px;color:var(--blue3);font-family:var(--fm);font-weight:600;">${t.id}</span>
        ${bdg(t.status,SC[t.status]||'#78909c',true)}
        ${proj?bdg(proj.id,'#546e8a',true):''}
        ${overdueFlag?bdg('Overdue','#f04545',true):''}
        <span style="margin-left:auto;font-size:11px;color:var(--text4);font-family:var(--fm);">Due ${fmtD(t.deadline)}</span>
      </div>
      <div style="font-size:14px;font-weight:600;color:var(--text2);margin-bottom:9px;">${t.title}</div>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:${canEdit?'10px':'0'};">${pb(t.progress,SC[t.status]||'#1976d2')}<span style="font-size:10px;color:var(--blue3);font-family:var(--fm);flex-shrink:0;width:34px;">${t.progress}%</span></div>
      ${canEdit?`
      <input type="range" min="0" max="100" value="${t.progress}" 
        oninput="updTP('${t.id}',this.value);this.previousElementSibling.querySelector('span').textContent=this.value+'%'" 
        style="width:100%;accent-color:var(--blue2);height:24px;">`:''}
    </div>`;
  }).join('')}
  ${filt.length===0?'<div class="empty"><span class="empty-icon">âœ“</span>No tasks found</div>':''}`;
}
function setFT(s){fTask=s;renderContent();}

// â”€â”€â”€ DOCUMENTS PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDocsPage(){
  const myD=docs.filter(canSee);
  const filt=fVis==='all'?myD:myD.filter(d=>d.visibility===fVis);
  return `
  <div class="flex-between" style="margin-bottom:16px;">
    <div class="filter-bar" style="margin:0;flex:1;">
      ${[['all','All'],['ceo-only','ğŸ‘‘ CEO'],['team-only','ğŸ‘¥ Team'],['shared','ğŸŒ Shared']].filter(([v])=>isCEO()||v!=='ceo-only').map(([v,l])=>`
      <button class="fbtn${fVis===v?' on':''}" onclick="setFV('${v}')">${l}</button>`).join('')}
    </div>
    <button class="btn-p" onclick="mUploadDoc(null)" style="flex-shrink:0;">+ Upload</button>
  </div>
  ${filt.map(d=>docCard(d)).join('')}
  ${filt.length===0?'<div class="empty"><span class="empty-icon">ğŸ“</span>No documents found</div>':''}`;
}
function setFV(v){fVis=v;renderContent();}

// â”€â”€â”€ FINANCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFinance(){
  const totR=projects.reduce((s,p)=>s+(p.revenue||0),0);
  const totC=projects.reduce((s,p)=>s+(p.cost||0),0);
  const totP=totR-totC;
  const totRcv=projects.reduce((s,p)=>s+(p.payments||[]).filter(x=>x.status==='Paid').reduce((ss,x)=>ss+Number(x.amount),0),0);
  return `
  <div class="g4" style="margin-bottom:22px;">
    <div class="stat-card"><div class="stat-icon">ğŸ“ˆ</div><div class="stat-val" style="color:var(--blue3);">â‚¹${totR.toLocaleString('en-IN')}</div><div class="stat-lbl">Total Revenue</div></div>
    <div class="stat-card"><div class="stat-icon">ğŸ“‰</div><div class="stat-val" style="color:var(--red);">â‚¹${totC.toLocaleString('en-IN')}</div><div class="stat-lbl">Total Cost</div></div>
    <div class="stat-card"><div class="stat-icon">ğŸ’¹</div><div class="stat-val" style="color:var(--green);">â‚¹${totP.toLocaleString('en-IN')}</div><div class="stat-lbl">Net Profit</div></div>
    <div class="stat-card"><div class="stat-icon">âœ…</div><div class="stat-val" style="color:var(--amber);">â‚¹${totRcv.toLocaleString('en-IN')}</div><div class="stat-lbl">Received</div></div>
  </div>
  <div class="tbl-wrap">
    <table>
      <thead><tr><th>Project</th><th>Status</th><th>Budget</th><th>Revenue</th><th>Cost</th><th>Profit</th><th>Received</th></tr></thead>
      <tbody>
      ${projects.map(p=>{
        const rcv=(p.payments||[]).filter(x=>x.status==='Paid').reduce((s,x)=>s+Number(x.amount),0);
        const prf=(p.revenue||0)-(p.cost||0);
        return `<tr>
          <td><div style="font-weight:600;color:var(--text2);">${p.title}</div><div style="font-size:10px;color:var(--text5);font-family:var(--fm);margin-top:2px;">${p.id}</div></td>
          <td>${bdg(p.status,SC[p.status]||'#78909c',true)}</td>
          <td style="font-family:var(--fm);color:var(--text2);">â‚¹${(p.budget||0).toLocaleString('en-IN')}</td>
          <td style="font-family:var(--fm);color:var(--blue3);">â‚¹${(p.revenue||0).toLocaleString('en-IN')}</td>
          <td style="font-family:var(--fm);color:var(--red);">â‚¹${(p.cost||0).toLocaleString('en-IN')}</td>
          <td style="font-family:var(--fm);color:${prf>=0?'var(--green)':'var(--red)'};">â‚¹${prf.toLocaleString('en-IN')}</td>
          <td style="font-family:var(--fm);color:var(--amber);">â‚¹${rcv.toLocaleString('en-IN')}</td>
        </tr>`;}).join('')}
      </tbody>
    </table>
  </div>`;
}

// â”€â”€â”€ USERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderUsers(){
  return `
  <div class="flex-end" style="margin-bottom:16px;">
    <button class="btn-p" onclick="mCreateUser()">+ Create Account</button>
  </div>
  ${Object.entries(USERS).map(([un,u])=>`
  <div style="display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--r12);margin-bottom:9px;opacity:${u.enabled===false?.5:1};">
    ${av(u.avatar,38,u.color)}
    <div style="flex:1;min-width:0;">
      <div style="display:flex;align-items:center;gap:7px;flex-wrap:wrap;margin-bottom:4px;">
        <span style="font-size:13px;font-weight:600;color:var(--text2);">${u.name}</span>
        ${u.role==='CEO'?bdg('ğŸ‘‘ CEO','#cc88e8',true):''}
        ${bdg(u.domain.split(' ')[0],'#546e8a',true)}
        ${u.enabled===false?bdg('Disabled','#f04545',true):''}
      </div>
      <div style="font-size:11px;color:var(--text4);font-family:var(--fm);">${un}</div>
      <div style="font-size:11px;color:var(--text4);font-family:var(--fm);">${u.domain}</div>
      ${isCEO()?`<div style="font-size:11px;color:var(--text5);font-family:var(--fm);margin-top:1px;">Password: <span style="color:var(--text4);">${u.password}</span></div>`:''}
    </div>
    ${u.role!=='CEO'?`
    <div style="display:flex;flex-direction:column;gap:7px;flex-shrink:0;">
      <button class="btn-sm" onclick="mEditUser('${un}')">Edit</button>
      <button class="btn-sm" onclick="togUser('${un}')" style="color:${u.enabled===false?'var(--green)':'var(--red)'};border-color:${u.enabled===false?'var(--green)':'var(--red)'};">${u.enabled===false?'Enable':'Disable'}</button>
    </div>`:''}
  </div>`).join('')}`;
}

// â”€â”€â”€ DELIVERY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDelivery(){
  const dp=projects.filter(p=>p.status==='Review'||p.status==='Delivered');
  return `
  <div style="font-size:11px;color:var(--text4);font-family:var(--fm);text-transform:uppercase;letter-spacing:.07em;margin-bottom:14px;">Projects ready for delivery or archival</div>
  ${dp.map(p=>{
    const pd=docs.filter(d=>d.projectId===p.id&&d.visibility==='shared');
    return `
    <div class="card" style="padding:16px 20px;margin-bottom:12px;">
      <div class="flex-between">
        <div>
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:5px;">
            <span style="font-size:11px;color:var(--blue3);font-family:var(--fm);font-weight:600;">${p.id}</span>
            ${bdg(p.status,SC[p.status]||'#78909c')}
          </div>
          <div style="font-family:var(--fd);font-weight:700;font-size:14px;color:var(--text);margin-bottom:5px;">${p.title}</div>
          <div style="font-size:12px;color:var(--text4);font-family:var(--fm);">ğŸ“‚ ${pd.length} shared docs Â· Deadline: ${fmtD(p.deadline)}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:7px;">
          ${p.status==='Review'?`<button class="btn-p" onclick="markDel('${p.id}')">Mark Delivered âœ“</button>`:''}
          ${p.status==='Delivered'?`<button class="btn-s" onclick="archProj('${p.id}')">Archive â†’</button>`:''}
        </div>
      </div>
    </div>`;}).join('')}
  ${dp.length===0?'<div class="empty"><span class="empty-icon">ğŸ“¦</span>No projects in Review or Delivered state</div>':''}`;
}

// â”€â”€â”€ GROUP CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderGroupChat() {
  return `
  <div id="chat-wrap">
    <div id="chat-messages">
      ${buildChatMessages()}
    </div>
    <div style="padding:10px 14px 14px;border-top:1px solid var(--border);background:var(--bg2);display:flex;gap:10px;align-items:flex-end;flex-shrink:0;">
      ${av(CU.avatar,36,CU.color)}
      <textarea class="chat-typing-area" id="chat-inp" placeholder="Message the teamâ€¦ (Enter to send)" rows="1"
        oninput="autoResizeChat(this)"
        onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat();}"></textarea>
      <button class="chat-send-btn" onclick="sendChat()" title="Send">â¤</button>
    </div>
  </div>`;
}

function buildChatMessages() {
  if (!groupChat.length) {
    return `<div style="flex:1;display:flex;align-items:center;justify-content:center;min-height:200px;">
      <div style="text-align:center;">
        <div style="font-size:44px;margin-bottom:14px;">ğŸ’¬</div>
        <div style="font-size:15px;font-weight:600;color:var(--text3);margin-bottom:6px;">Team Group Chat</div>
        <div style="font-size:12px;color:var(--text5);font-family:var(--fm);">Be the first to say something!</div>
      </div>
    </div>`;
  }

  let html = '';
  let lastDate = '';
  groupChat.forEach(msg => {
    const d = new Date(msg.ts);
    const msgDate = d.toLocaleDateString('en-IN',{weekday:'long',day:'2-digit',month:'long'});
    if (msgDate !== lastDate) {
      html += `<div class="chat-date-divider">${msgDate}</div>`;
      lastDate = msgDate;
    }
    const mine = msg.by === CU.username;
    const u = USERS[msg.by];
    const timeStr = d.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
    html += `
    <div class="chat-msg ${mine?'mine':'theirs'}">
      ${!mine ? av(u?.avatar||'?', 32, u?.color||'#1565c0') : ''}
      <div style="max-width:76%;min-width:0;">
        ${!mine ? `<div class="chat-name-badge">${u?.name?.split(' ')[0]||msg.by}<span style="color:var(--text5);font-weight:400;"> Â· ${u?.domain||''}</span></div>` : ''}
        <div class="chat-bubble">${escapeHtml(msg.text)}</div>
        <div class="chat-meta">${timeStr}${mine?' Â· You':''}</div>
      </div>
    </div>`;
  });
  return html;
}

function escapeHtml(str) {
  return String(str)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;')
    .replace(/\n/g,'<br>');
}

function autoResizeChat(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

async function sendChat() {
  const inp = $('chat-inp');
  if (!inp) return;
  const text = inp.value.trim();
  if (!text) return;

  const msg = {
    id: Date.now() + Math.random(),
    by: CU.username,
    name: CU.name,
    text,
    ts: Date.now()
  };

  groupChat.push(msg);
  inp.value = '';
  inp.style.height = 'auto';

  // Immediately update the UI for the sender
  const msgArea = $('chat-messages');
  if (msgArea) {
    msgArea.innerHTML = buildChatMessages();
    msgArea.scrollTop = msgArea.scrollHeight;
  }

  // Persist immediately (no debounce for chat) and broadcast
  await dbSet('groupChat', groupChat);
  SYNC.broadcast('data_changed');
  _lastSeenChatCount = groupChat.length;
}

function afterChatRender() {
  requestAnimationFrame(() => {
    const msgArea = $('chat-messages');
    if (msgArea) msgArea.scrollTop = msgArea.scrollHeight;
    // Small delay to let mobile keyboard settle
    setTimeout(() => {
      const inp = $('chat-inp');
      if (inp) inp.focus();
    }, 100);
  });
}

// â”€â”€â”€ ARCHITECTURE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderArchitecture(){
  return `
  ${isCEO()?`<div class="flex-end" style="margin-bottom:16px;"><button class="btn-p" onclick="mNewNote()">+ Add Note</button></div>`:''}
  ${archNotes.length===0?'<div class="empty"><span class="empty-icon">â¬¢</span>No architecture notes yet.</div>':''}
  ${archNotes.map(n=>`
  <div class="card" style="padding:16px 20px;margin-bottom:14px;">
    <div class="flex-between" style="margin-bottom:10px;">
      <div>
        <div style="font-family:var(--fd);font-weight:700;font-size:14px;color:var(--text);margin-bottom:4px;">${n.title}</div>
        <div style="font-size:11px;color:var(--text5);font-family:var(--fm);">
          Edited by ${USERS[n.editedBy]?.name?.split(' ')[0]||n.editedBy} Â· ${n.ts}
          ${n.locked?` <span style="color:var(--red);">Â· ğŸ”’</span>`:''}
        </div>
      </div>
      ${isCEO()&&!n.locked?`<button class="btn-s" onclick="mEditNote(${n.id})">Edit</button>`:''}
    </div>
    <pre style="font-size:13px;color:var(--text3);line-height:1.8;white-space:pre-wrap;font-family:var(--fm);">${n.content}</pre>
  </div>`).join('')}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleTE(id){taskExp[id]=!taskExp[id];renderContent();}
function toggleDC(id){docOpen[id]=!docOpen[id];renderContent();}
function updTP(id,val){const t=tasks.find(x=>x.id===id);if(t){t.progress=Number(val);persistAll();}}
function updTS(id,s){const t=tasks.find(x=>x.id===id);if(t)t.status=s;persistAll();renderContent();notify('Status: '+s);}
function addNote(tid){
  const inp=document.getElementById('ni-'+tid);
  if(!inp||!inp.value.trim())return;
  const t=tasks.find(x=>x.id===tid);
  if(t)t.notes=[...(t.notes||[]),{text:inp.value.trim(),by:CU.username,name:CU.name,ts:new Date().toLocaleString('en-IN')}];
  persistAll();renderContent();notify('Note added');
}
function addDC(did){
  const inp=document.getElementById('dc-'+did);
  if(!inp||!inp.value.trim())return;
  const d=docs.find(x=>x.id===did);
  if(d)d.comments=[...(d.comments||[]),{text:inp.value.trim(),by:CU.username,name:CU.name,ts:new Date().toLocaleString('en-IN')}];
  persistAll();renderContent();
}
function addPC(pid){
  const inp=document.getElementById('pc-inp');
  if(!inp||!inp.value.trim())return;
  if(!projComments[pid])projComments[pid]=[];
  projComments[pid].push({id:Date.now(),text:inp.value.trim(),by:CU.username,name:CU.name,ts:new Date().toLocaleString('en-IN')});
  persistAll();renderContent();
}
function togApprove(id){const d=docs.find(x=>x.id===id);if(d)d.approved=!d.approved;persistAll();renderContent();notify(d.approved?'Document approved':'Approval revoked');}
function togLock(id){const d=docs.find(x=>x.id===id);if(d)d.locked=!d.locked;persistAll();renderContent();notify(d.locked?'Locked':'Unlocked');}
function chVis(id,vis){const d=docs.find(x=>x.id===id);if(d)d.visibility=vis;persistAll();renderContent();notify('Visibility changed');}
function delDoc(id){
  if(confirm('Delete this document?')){
    deleteFileFromDB(id);
    docs=docs.filter(x=>x.id!==id);
    persistAll();renderContent();notify('Document deleted');
  }
}
function togPay(pid,idx){
  const p=projects.find(x=>x.id===pid);
  if(p&&p.payments[idx]){const pay=p.payments[idx];pay.status=pay.status==='Paid'?'Pending':'Paid';pay.date=pay.status==='Paid'?new Date().toISOString().slice(0,10):'';}
  persistAll();renderContent();notify('Payment updated');
}
function markDel(id){const p=projects.find(x=>x.id===id);if(p)p.status='Delivered';persistAll();renderContent();notify('Marked as Delivered');}
function archProj(id){const p=projects.find(x=>x.id===id);if(p)p.status='Archived';persistAll();renderContent();notify('Project archived');}
function togUser(un){USERS[un].enabled=USERS[un].enabled===false?true:false;persistAll();renderContent();notify('User '+(USERS[un].enabled?'enabled':'disabled')+': '+un);}

// â”€â”€â”€ FILE DOWNLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function downloadDoc(docId) {
  const fileData = await getFileFromDB(docId);
  if (!fileData || !fileData.dataURL) {
    notify('File not found in storage', 'err');
    return;
  }
  const a = document.createElement('a');
  a.href = fileData.dataURL;
  a.download = fileData.name || 'download';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  notify('Downloading: ' + fileData.name);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showModal(title, body, wide) {
  $('modal-root').innerHTML = `
  <div class="overlay" onclick="if(event.target===this)closeM()">
    <div class="mbox${wide?' mbox-wide':''}">
      <div class="drag-handle"></div>
      <div class="mhead">
        <div class="mtitle">${title}</div>
        <button class="mclose" onclick="closeM()">Ã—</button>
      </div>
      ${body}
    </div>
  </div>`;
}
function closeM(){$('modal-root').innerHTML='';}

// â”€â”€â”€ FILE UPLOAD ZONE HANDLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initUploadZone(zoneId, inputId) {
  const zone = document.getElementById(zoneId);
  const input = document.getElementById(inputId);
  if (!zone || !input) return;

  zone.addEventListener('click', () => input.click());
  zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('drag'));
  zone.addEventListener('drop', e => {
    e.preventDefault(); zone.classList.remove('drag');
    const f = e.dataTransfer.files[0];
    if (f) handleFileSelect(f);
  });
  input.addEventListener('change', () => {
    if (input.files[0]) handleFileSelect(input.files[0]);
  });
}

function handleFileSelect(file) {
  uploadedFile = file;
  // Get extension
  const ext = file.name.split('.').pop().toLowerCase();
  // Update UI
  const zone = document.getElementById('upload-zone');
  const preview = document.getElementById('upload-preview');
  const typeSelect = document.getElementById('df-t');
  const sizeField = document.getElementById('df-s');
  const nameField = document.getElementById('df-n');

  if (zone) zone.style.display = 'none';
  if (preview) {
    preview.style.display = 'flex';
    preview.querySelector('.upload-preview-name').textContent = file.name;
    preview.querySelector('.upload-preview-size').textContent = fmtSize(file.size);
    preview.querySelector('.upload-preview-icon').textContent = fi(ext);
  }
  if (typeSelect) { typeSelect.value = ext; }
  if (sizeField) sizeField.value = fmtSize(file.size);
  if (nameField && !nameField.value) nameField.value = file.name;
}

function clearUploadFile() {
  uploadedFile = null;
  const zone = document.getElementById('upload-zone');
  const preview = document.getElementById('upload-preview');
  const inp = document.getElementById('file-input-real');
  if (zone) zone.style.display = '';
  if (preview) preview.style.display = 'none';
  if (inp) inp.value = '';
}

// Create Project
function mCreateProj(){
  const team=Object.entries(USERS).filter(([,u])=>u.role==='team'&&u.enabled!==false);
  selMembers=[];
  showModal('Create New Project Order',`
  <form onsubmit="submitProj(event)">
    <div class="field"><label class="inp-label">Project Title *</label><input class="inp-sm" id="pf-t" required placeholder="e.g. Smart Irrigation System"></div>
    <div class="g2" style="gap:12px;">
      <div class="field"><label class="inp-label">Type *</label><input class="inp-sm" id="pf-ty" required placeholder="IoT & Embedded"></div>
      <div class="field"><label class="inp-label">Branch *</label><input class="inp-sm" id="pf-br" required placeholder="Electronics"></div>
      <div class="field"><label class="inp-label">Year</label><input class="inp-sm" id="pf-yr" value="${new Date().getFullYear()}"></div>
      <div class="field"><label class="inp-label">Deadline *</label><input class="inp-sm" id="pf-dl" type="date" required></div>
      <div class="field"><label class="inp-label">Budget (â‚¹) *</label><input class="inp-sm" id="pf-bg" type="number" placeholder="85000" required></div>
      <div class="field"><label class="inp-label">Cost (â‚¹)</label><input class="inp-sm" id="pf-ct" type="number" placeholder="0" value="0"></div>
    </div>
    <div class="field"><label class="inp-label">Description</label><textarea class="inp-sm" id="pf-ds" rows="2" style="resize:vertical;"></textarea></div>
    <div class="field"><label class="inp-label">Requirements</label><textarea class="inp-sm" id="pf-rq" rows="2" style="resize:vertical;"></textarea></div>
    <div class="field">
      <label class="inp-label">Assign Team Members</label>
      <div id="mchips" style="display:flex;flex-wrap:wrap;margin-top:6px;">
        ${team.map(([un,u])=>`<span class="mchip" id="ch-${un}" onclick="togChip('${un}')">${av(u.avatar,20,u.color)} ${u.name.split(' ')[0]}</span>`).join('')}
      </div>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:6px;">
      <button type="button" class="btn-s" onclick="closeM()">Cancel</button>
      <button type="submit" class="btn-p">Create Project</button>
    </div>
  </form>`, true);
}
function togChip(un){
  const ch=document.getElementById('ch-'+un);
  if(selMembers.includes(un)){selMembers=selMembers.filter(x=>x!==un);ch.classList.remove('sel');}
  else{selMembers.push(un);ch.classList.add('sel');}
}
function submitProj(e){
  e.preventDefault();
  const id=gid('PRJ');
  const budget=Number(document.getElementById('pf-bg').value);
  const cost=Number(document.getElementById('pf-ct').value)||0;
  projects.push({id,title:$('pf-t').value,type:$('pf-ty').value,branch:$('pf-br').value,year:$('pf-yr').value,deadline:$('pf-dl').value,budget,status:'Created',assignedMembers:[...selMembers],description:$('pf-ds').value,requirements:$('pf-rq').value,createdAt:new Date().toISOString().slice(0,10),payments:[],revenue:budget,cost});
  selMembers=[];closeM();persistAll();renderContent();notify('Project created: '+id);
}

// Status Change
function mStatusChange(){
  const p=selProj;
  showModal('Change Project Status',`
  <div style="display:flex;flex-direction:column;gap:7px;">
    ${['Created','Approved','In Development','Review','Delivered','Archived'].map(s=>`
    <button onclick="doSC('${s}')" style="display:flex;align-items:center;gap:10px;padding:13px 14px;background:${p.status===s?'rgba(21,96,192,.2)':'var(--bg4)'};border:1px solid ${p.status===s?'var(--blue2)':'var(--border)'};border-radius:9px;color:${p.status===s?'var(--blue3)':'var(--text2)'};font-size:14px;text-align:left;min-height:50px;">
      <span style="width:10px;height:10px;border-radius:50%;background:${SC[s]};display:inline-block;flex-shrink:0;"></span>
      ${s}
      ${p.status===s?'<span style="margin-left:auto;font-size:10px;font-family:var(--fm);color:var(--blue3);">Current</span>':''}
    </button>`).join('')}
  </div>`);
}
function doSC(s){
  if(selProj){const p=projects.find(x=>x.id===selProj.id);if(p){p.status=s;selProj=p;}}
  closeM();persistAll();renderContent();notify('Status: '+s);
}

// Create Task
function mCreateTask(pid){
  const p=projects.find(x=>x.id===pid);
  const el=Object.entries(USERS).filter(([un])=>p?.assignedMembers?.includes(un));
  showModal('Add Task',`
  <form onsubmit="submitTask(event,'${pid}')">
    <div class="field"><label class="inp-label">Task Title *</label><input class="inp-sm" id="tf-t" required placeholder="e.g. PCB Design"></div>
    <div class="field"><label class="inp-label">Assign To *</label>
      <select class="inp-sm" id="tf-a" required>
        <option value="">Select member</option>
        ${el.map(([un,u])=>`<option value="${un}">${u.name} (${u.domain})</option>`).join('')}
      </select>
    </div>
    <div class="field"><label class="inp-label">Deadline *</label><input class="inp-sm" id="tf-d" type="date" required></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button type="button" class="btn-s" onclick="closeM()">Cancel</button>
      <button type="submit" class="btn-p">Create Task</button>
    </div>
  </form>`);
}
function submitTask(e,pid){
  e.preventDefault();
  const a=$('tf-a').value;
  const u=USERS[a];
  const id=gid('TSK');
  tasks.push({id,projectId:pid,title:$('tf-t').value,assignedTo:a,domain:u?.domain||'',deadline:$('tf-d').value,status:'Not Started',progress:0,notes:[],createdAt:new Date().toISOString().slice(0,10)});
  closeM();persistAll();renderContent();notify('Task created: '+id);
}

// Upload Document â€” with REAL file storage
function mUploadDoc(pid){
  uploadedFile = null;
  const mpList=isCEO()?projects:projects.filter(p=>p.assignedMembers?.includes(CU.username));
  const pt=pid?tasks.filter(t=>t.projectId===pid):[];
  const defVis = isCEO()?'ceo-only':'team-only';

  showModal('Upload Document',`
  <form onsubmit="submitDoc(event)">
    ${!pid?`<div class="field"><label class="inp-label">Project *</label>
      <select class="inp-sm" id="df-p" required onchange="updDocTasks(this.value)">
        <option value="">Select project</option>
        ${mpList.map(p=>`<option value="${p.id}">${p.id} â€” ${p.title}</option>`).join('')}
      </select></div>`:`<input type="hidden" id="df-p" value="${pid}">`}

    <!-- FILE UPLOAD ZONE -->
    <div class="field">
      <label class="inp-label">Upload File (from phone or laptop)</label>
      <div class="upload-zone" id="upload-zone">
        <span class="upload-zone-icon">ğŸ“</span>
        <div class="upload-zone-title">Tap to browse or drag & drop</div>
        <div class="upload-zone-sub">PDF, Word, Excel, Images, ZIP, DWG and more</div>
      </div>
      <div class="upload-preview" id="upload-preview" style="display:none;">
        <span class="upload-preview-icon">ğŸ“„</span>
        <div>
          <div class="upload-preview-name">filename.pdf</div>
          <div class="upload-preview-size">â€”</div>
        </div>
        <button type="button" class="upload-preview-rm" onclick="clearUploadFile()">Ã—</button>
      </div>
      <input type="file" id="file-input-real" class="file-input-hidden" accept="*/*">
    </div>

    <div class="field"><label class="inp-label">Document Name *</label><input class="inp-sm" id="df-n" required placeholder="Report_v1.pdf"></div>
    <div class="g2" style="gap:12px;">
      <div class="field"><label class="inp-label">File Type</label>
        <select class="inp-sm" id="df-t">
          ${['pdf','docx','xlsx','png','jpg','dwg','zip','mp4','txt','pptx'].map(t=>`<option value="${t}">${t.toUpperCase()}</option>`).join('')}
        </select>
      </div>
      <div class="field"><label class="inp-label">File Size</label><input class="inp-sm" id="df-s" placeholder="Auto-detected" value="â€”"></div>
    </div>
    <div class="field"><label class="inp-label">Link to Task (optional)</label>
      <select class="inp-sm" id="df-tk">
        <option value="">No task link</option>
        ${pt.map(t=>`<option value="${t.id}">${t.id} Â· ${t.title}</option>`).join('')}
      </select>
    </div>
    <div class="field">
      <label class="inp-label">Visibility</label>
      <div class="vis-row" style="margin-top:7px;">
        ${(isCEO()?['ceo-only','team-only','shared']:['team-only','shared']).map((v,i)=>{const vc=VC[v];return`<button type="button" class="vbtn" id="vb-${v}" onclick="selVis('${v}')" style="${v===defVis?`background:${vc.c}1a;border-color:${vc.c};color:${vc.c};`:''}">${vc.i} ${vc.l}</button>`;}).join('')}
      </div>
      <input type="hidden" id="df-v" value="${defVis}">
    </div>
    <div id="upload-progress" style="display:none;margin-bottom:12px;">
      <div style="font-size:11px;color:var(--text4);font-family:var(--fm);margin-bottom:6px;">Saving file to device storage...</div>
      <div class="pbar-wrap"><div class="pbar" id="prog-bar" style="width:0%;background:var(--blue2);transition:width .3s;"></div></div>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button type="button" class="btn-s" onclick="closeM()">Cancel</button>
      <button type="submit" class="btn-p" id="submit-doc-btn">Upload Document</button>
    </div>
  </form>`, true);

  // Init upload zone after modal renders
  setTimeout(() => initUploadZone('upload-zone','file-input-real'), 50);
}

function updDocTasks(pid){
  const sel=document.getElementById('df-tk');
  if (!sel) return;
  const pt=tasks.filter(t=>t.projectId===pid);
  sel.innerHTML='<option value="">No task link</option>'+pt.map(t=>`<option value="${t.id}">${t.id} Â· ${t.title}</option>`).join('');
}

function selVis(v){
  $('df-v').value=v;
  ['ceo-only','team-only','shared'].forEach(x=>{const b=document.getElementById('vb-'+x);if(!b)return;const vc=VC[x];if(x===v){b.style.background=vc.c+'1a';b.style.borderColor=vc.c;b.style.color=vc.c;}else{b.style.background='';b.style.borderColor='var(--border2)';b.style.color='var(--text4)';}});
}

async function submitDoc(e){
  e.preventDefault();
  const pid=$('df-p').value;
  if(!pid){notify('Select a project first','err');return;}

  const id=gid('DOC');
  const name=$('df-n').value;
  const type=$('df-t').value;
  const size=$('df-s').value;
  const taskId=$('df-tk').value||null;
  const vis=$('df-v').value;

  // Show progress
  const prog=$('upload-progress');
  const progBar=$('prog-bar');
  const submitBtn=$('submit-doc-btn');
  if(submitBtn) submitBtn.disabled=true;

  let hasFile = false;

  if(uploadedFile) {
    // Save actual file to IndexedDB
    if(prog) prog.style.display='block';
    if(progBar) progBar.style.width='30%';

    try {
      const dataURL = await readFileAsDataURL(uploadedFile);
      if(progBar) progBar.style.width='80%';
      await saveFileToDB(id, { 
        id, 
        name: uploadedFile.name, 
        dataURL, 
        mimeType: uploadedFile.type,
        size: uploadedFile.size
      });
      if(progBar) progBar.style.width='100%';
      hasFile = true;
    } catch(err) {
      console.error(err);
      notify('File save failed. Metadata saved only.', 'err');
    }
  }

  const ext = uploadedFile ? uploadedFile.name.split('.').pop().toLowerCase() : type;
  const finalSize = uploadedFile ? fmtSize(uploadedFile.size) : size;

  docs.push({
    id, projectId:pid, taskId, 
    name: name || (uploadedFile ? uploadedFile.name : 'Document'),
    uploadedBy:CU.username, role:CU.role, 
    visibility:vis, version:1, 
    timestamp:new Date().toLocaleString('en-IN'), 
    size:finalSize, type:ext, 
    locked:false, approved:false, comments:[],
    hasFile
  });

  closeM();
  uploadedFile = null;
  persistAll();
  renderContent();
  notify(hasFile ? 'âœ“ File saved to device storage!' : 'Document entry added');
}

function readFileAsDataURL(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => resolve(e.target.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// Add Payment
function mAddPayment(pid){
  showModal('Add Payment Stage',`
  <form onsubmit="submitPay(event,'${pid}')">
    <div class="field"><label class="inp-label">Stage Name *</label><input class="inp-sm" id="pay-n" required placeholder="e.g. Milestone 2"></div>
    <div class="field"><label class="inp-label">Amount (â‚¹) *</label><input class="inp-sm" id="pay-a" type="number" required placeholder="30000"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button type="button" class="btn-s" onclick="closeM()">Cancel</button>
      <button type="submit" class="btn-p">Add Stage</button>
    </div>
  </form>`);
}
function submitPay(e,pid){
  e.preventDefault();
  const p=projects.find(x=>x.id===pid);
  if(p)p.payments.push({stage:$('pay-n').value,amount:Number($('pay-a').value),status:'Pending',date:''});
  closeM();persistAll();renderContent();notify('Payment stage added');
}

// Create User
function mCreateUser(){
  showModal('Create User Account',`
  <form onsubmit="submitUser(event)">
    <div class="g2" style="gap:12px;">
      <div class="field"><label class="inp-label">First Name *</label><input class="inp-sm" id="uf-f" required autocapitalize="words"></div>
      <div class="field"><label class="inp-label">Last Name</label><input class="inp-sm" id="uf-l" autocapitalize="words"></div>
    </div>
    <div class="field"><label class="inp-label">Full Domain / Role *</label><input class="inp-sm" id="uf-d" required placeholder="Electronics Assembly & Testing"></div>
    <div class="field"><label class="inp-label">Username *</label><input class="inp-sm" id="uf-u" required placeholder="manoj.elec" autocapitalize="none"></div>
    <div class="field"><label class="inp-label">Preset Password *</label><input class="inp-sm" id="uf-p" required placeholder="Strong preset password" type="password"></div>
    <div style="background:var(--bg4);border:1px solid var(--border);border-radius:9px;padding:12px 13px;margin-bottom:14px;font-size:12px;color:var(--text4);">
      ğŸ’¡ This password will be given privately to the team member. They cannot change it.
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button type="button" class="btn-s" onclick="closeM()">Cancel</button>
      <button type="submit" class="btn-p">Create Account</button>
    </div>
  </form>`);
}
function submitUser(e){
  e.preventDefault();
  const f=$('uf-f').value, l=$('uf-l').value, un=$('uf-u').value.trim();
  if(USERS[un]){notify('Username already exists','err');return;}
  const initials = (f[0]+(l?l[0]:f[1]||'')).toUpperCase();
  USERS[un]={name:f+(l?' '+l:''),role:'team',domain:$('uf-d').value,avatar:initials,color:'#1565c0',password:$('uf-p').value,enabled:true};
  closeM();persistAll();renderContent();notify('Account created: '+un);
}

// Edit User
function mEditUser(un){
  const u=USERS[un];
  showModal(`Edit â€” ${un}`,`
  <div class="field"><label class="inp-label">Full Name</label><input class="inp-sm" id="eu-n" value="${u.name}" autocapitalize="words"></div>
  <div class="field"><label class="inp-label">Domain / Role</label><input class="inp-sm" id="eu-d" value="${u.domain}"></div>
  <div class="field"><label class="inp-label">Preset Password</label><input class="inp-sm" id="eu-p" value="${u.password}" type="password"></div>
  <div style="display:flex;gap:10px;justify-content:flex-end;">
    <button class="btn-s" onclick="closeM()">Cancel</button>
    <button class="btn-p" onclick="submitEdit('${un}')">Save Changes</button>
  </div>`);
}
function submitEdit(un){
  const n=$('eu-n').value;
  USERS[un].name=n;USERS[un].domain=$('eu-d').value;USERS[un].password=$('eu-p').value;
  USERS[un].avatar=n.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
  closeM();persistAll();renderContent();notify('User updated: '+un);
}

// Architecture Note
function mNewNote(){
  showModal('New Architecture Note',`
  <div class="field"><label class="inp-label">Title *</label><input class="inp-sm" id="an-t" required></div>
  <div class="field"><label class="inp-label">Content</label><textarea class="inp-sm" id="an-c" rows="7" style="resize:vertical;font-family:var(--fm);font-size:13px;line-height:1.7;"></textarea></div>
  <div style="display:flex;gap:10px;justify-content:flex-end;">
    <button class="btn-s" onclick="closeM()">Cancel</button>
    <button class="btn-p" onclick="submitNote()">Add Note</button>
  </div>`, true);
}
function submitNote(){
  const t=$('an-t')?.value;const c=$('an-c')?.value;
  if(!t)return;
  archNotes.push({id:Date.now(),title:t,content:c||'',editedBy:CU.username,ts:new Date().toISOString().slice(0,10),locked:false});
  closeM();persistAll();renderContent();notify('Note added');
}
function mEditNote(id){
  const n=archNotes.find(x=>x.id===id);if(!n)return;
  showModal('Edit: '+n.title,`
  <div class="field"><label class="inp-label">Content</label><textarea class="inp-sm" id="en-c" rows="9" style="resize:vertical;font-family:var(--fm);font-size:13px;line-height:1.7;">${n.content}</textarea></div>
  <div style="display:flex;gap:10px;justify-content:flex-end;">
    <button class="btn-s" onclick="closeM()">Cancel</button>
    <button class="btn-p" onclick="submitEditNote(${id})">Save</button>
  </div>`, true);
}
function submitEditNote(id){
  const n=archNotes.find(x=>x.id===id);
  if(n){n.content=$('en-c').value;n.editedBy=CU.username;n.ts=new Date().toISOString().slice(0,10);}
  closeM();persistAll();renderContent();notify('Note updated');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESPONSIVE MENU BUTTON
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('resize', () => {
  const mb = $('menu-btn');
  if (!mb) return;
  mb.style.display = window.innerWidth <= 768 ? 'flex' : 'none';
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHAKE ANIMATION (for failed login)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const shakeCSS = document.createElement('style');
shakeCSS.textContent = `@keyframes shake{0%,100%{transform:translateX(0);}15%{transform:translateX(-8px);}30%{transform:translateX(7px);}45%{transform:translateX(-6px);}60%{transform:translateX(5px);}75%{transform:translateX(-3px);}90%{transform:translateX(2px);}}`;
document.head.appendChild(shakeCSS);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STARTUP â€” Auto-restore session on page load / refresh
// This is the "permanent session" feature.
// On every page load, we check if a valid saved session
// exists in localStorage (remember-me) or sessionStorage
// (tab session). If valid, we skip login entirely and
// restore the user straight into the app.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async function startup() {
  // 1. Open the database first â€” everything depends on it
  await openDB().catch(e => console.warn('IndexedDB unavailable:', e));

  // 2. Set the topbar date
  $('tb-date').textContent = new Date().toLocaleDateString('en-IN',{weekday:'short',day:'2-digit',month:'short',year:'numeric'});

  // 3. Try to validate an existing session
  const savedUser = await validateSession();

  if (savedUser) {
    // âœ“ Valid session found â€” restore without showing login
    CU = { username: savedUser, ...USERS[savedUser] };
    _rememberMe = !!localStorage.getItem(SEC.REMEMBER_KEY);

    // Load all app data from IndexedDB
    await loadAll();

    // Show a brief "restoring session" splash then jump straight to app
    showScreen('s-welcome');
    buildWelcome();

    // Auto-enter app after 1.2 seconds (skip the "Enter Dashboard" button)
    setTimeout(() => { enterApp(); }, 1200);
  } else {
    // No session â€” show login screen normally
    showScreen('s-login');
  }
})();

</script>
</body>
</html>
